package com.mercurio.lms.rnc.action;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.rnc.model.AcaoCorretiva;
import com.mercurio.lms.rnc.model.CausaNaoConformidade;
import com.mercurio.lms.rnc.model.Disposicao;
import com.mercurio.lms.rnc.model.MotivoDisposicao;
import com.mercurio.lms.rnc.model.OcorrenciaNaoConformidade;
import com.mercurio.lms.rnc.model.service.AcaoCorretivaService;
import com.mercurio.lms.rnc.model.service.CausaNaoConformidadeService;
import com.mercurio.lms.rnc.model.service.DisposicaoService;
import com.mercurio.lms.rnc.model.service.MotivoDisposicaoService;
import com.mercurio.lms.rnc.model.service.NaoConformidadeService;
import com.mercurio.lms.rnc.model.service.NegociacaoService;
import com.mercurio.lms.rnc.model.service.OcorrenciaNaoConformidadeService;
import com.mercurio.lms.util.FormatUtils;
import com.mercurio.lms.util.session.SessionUtils;

import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;

/**
 * Generated by: ADSM ActionGenerator 
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.rnc.registrarDisposicaoAction"
 */

public class RegistrarDisposicaoAction extends CrudAction {

	private AcaoCorretivaService acaoCorretivaService;
	private CausaNaoConformidadeService causaNaoConformidadeService;
	private DisposicaoService disposicaoService;
	private FilialService filialService;
	private MotivoDisposicaoService motivoDisposicaoService;
	private OcorrenciaNaoConformidadeService ocorrenciaNaoConformidadeService;
	private NegociacaoService negociacaoService;
	private NaoConformidadeService naoConformidadeService;

	
	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	public AcaoCorretivaService getAcaoCorretivaService() {
		return acaoCorretivaService;
	}
	public void setAcaoCorretivaService(AcaoCorretivaService acaoCorretivaService) {
		this.acaoCorretivaService = acaoCorretivaService;
	}
	public CausaNaoConformidadeService getCausaNaoConformidadeService() {
		return causaNaoConformidadeService;
	}
	public void setCausaNaoConformidadeService(CausaNaoConformidadeService causaNaoConformidadeService) {
		this.causaNaoConformidadeService = causaNaoConformidadeService;
	}
	public DisposicaoService getDisposicaoService() {
		return disposicaoService;
	}
	public void setDisposicaoService(DisposicaoService disposicaoService) {
		this.disposicaoService = disposicaoService;
	}
	public MotivoDisposicaoService getMotivoDisposicaoService() {
		return motivoDisposicaoService;
	}
	public void setMotivoDisposicaoService(MotivoDisposicaoService motivoDisposicaoService) {
		this.motivoDisposicaoService = motivoDisposicaoService;
	}
	public OcorrenciaNaoConformidadeService getOcorrenciaNaoConformidadeService() {
		return ocorrenciaNaoConformidadeService;
	}
	public void setOcorrenciaNaoConformidadeService(OcorrenciaNaoConformidadeService ocorrenciaNaoConformidadeService) {
		this.ocorrenciaNaoConformidadeService = ocorrenciaNaoConformidadeService;
	}
	public NegociacaoService getNegociacaoService() {
		return negociacaoService;
	}
	public void setNegociacaoService(NegociacaoService negociacaoService) {
		this.negociacaoService = negociacaoService;
	}
	public NaoConformidadeService getNaoConformidadeService() {
		return naoConformidadeService;
	}
	public void setNaoConformidadeService(NaoConformidadeService naoConformidadeService) {
		this.naoConformidadeService = naoConformidadeService;
	}
	
	
	/**
	 * Recupera uma instância de <code>Disposicao</code> a partir do ID.
	 *
	 * @param id representa a entidade que deve ser localizada.
	 * @return Instância que possui o id informado.
	 * @throws 
	 */
    public Disposicao findById(java.lang.Long id) {
        return (Disposicao)super.findById(id);
    }

	/**
	 * Apaga uma entidade através do Id.
	 *
	 * @param id indica a entidade que deverá ser removida.
	 */
    public void removeById(java.lang.Long id) {
        super.removeById(id);
    }

	/**
	 * Apaga várias entidades através do Id.
	 *
	 * @param ids lista com as entidades que deverão ser removida.
	 *
	 *
	 */
	@ParametrizedAttribute(type = java.lang.Long.class)
    public void removeByIds(List ids) {
        super.removeByIds(ids);
    }

	/**
	 * Insere, caso o id seja <code>null</code> ou atualiza uma entidade, caso contrário.
	 *
	 * @param bean entidade a ser armazenada.
	 * @return entidade que foi armazenada.
	 */
    public TypedFlatMap storeDisposicao(Map bean) {
    	
    	//bean
    	if (!bean.containsKey("idsOcorrenciaNaoConformidade")) throw new BusinessException("LMS-12011");
    	
    	//Persiste objeto...    	
    	Disposicao disposicao = (Disposicao) this.getDisposicaoService().storeRegistrarDisposicao(bean);
    	
    	TypedFlatMap mapDisposicao = new TypedFlatMap();
    	
    	mapDisposicao.put("idDisposicao", disposicao.getIdDisposicao());
    	mapDisposicao.put("dhDisposicao", disposicao.getDhDisposicao());
    	
        return mapDisposicao;
    }

    /**
     * Busca 'Ocorrencias de Não Conformidade' que sejam de uma 'Não conformidade'
     * em específico
     * 
     * @param criteria
     * @return
     */
    public List findOcorrenciaNaoConformidade(Map criteria) {
        
    	List campoOrdenacao = new ArrayList();
        campoOrdenacao.add("nrOcorrenciaNc:asc");
        campoOrdenacao.add("motivoAberturaNc_.dsMotivoAbertura:asc");
    	
        //Adiciona o criterio para pegar apenas ocorrencias que estejam abertas.
    	criteria.put("tpStatusOcorrenciaNc", "A");
    	List ocorrenciasNC = this.getOcorrenciaNaoConformidadeService().findListByCriteria(criteria, campoOrdenacao);
    	List newOcorrenciasNC = new ArrayList();
    	
    	if (ocorrenciasNC.size()<1) throw new BusinessException("LMS-12007");
    	
    	for (Iterator iter = ocorrenciasNC.iterator(); iter.hasNext();) {
    		OcorrenciaNaoConformidade onc = (OcorrenciaNaoConformidade) iter.next();
    		
    		Map mapOcorrenciasNC = new HashMap();
    		StringBuffer strOcorrencia = new StringBuffer()
	    		.append(onc.getNrOcorrenciaNc().toString())
	    		.append(" - ")
	    		.append(onc.getMotivoAberturaNc().getDsMotivoAbertura())
	    		.append(" - ")
	    		.append(onc.getFilialByIdFilialLegado().getSgFilial())
	    		.append(" ")
	    		.append(FormatUtils.formatLongWithZeros(Long.valueOf(onc.getNrOcorrenciaNc().intValue()), "00000000")); 

    		mapOcorrenciasNC.put("idOcorrenciaNaoConformidade", onc.getIdOcorrenciaNaoConformidade());
    		mapOcorrenciasNC.put("nrOcorrenciaNc", strOcorrencia.toString());
    		mapOcorrenciasNC.put("dsOcorrenciaNc", onc.getDsOcorrenciaNc());
    		
    		newOcorrenciasNC.add(mapOcorrenciasNC);
		}
    	
    	return newOcorrenciasNC; 
    }
    
    /**
     * Verifica se a Ocorrencia Não Conformidade possui uma negociação vinculada a 
     * ela.
     * 
     * @param id da Ocorrencia Não Conformidade
     * @return Map com o resultado "true" caso exista
     */
    public Map validateOcorrenciaNaoConformidade(Long id){
    	
    	Map criteria = new HashMap();
    	criteria.put("ocorrenciaNaoConformidade.idOcorrenciaNaoConformidade", id);
    	
    	List negociacoes = this.getNegociacaoService().find(criteria);
    	if (negociacoes.size()<1) throw new BusinessException("LMS-12008");
    	
    	//Caso exista 
    	Map mapOcorrenciaValida = new HashMap();
    	mapOcorrenciaValida.put("ocorrenciaNaoConformidade",  "true");
    	
    	return mapOcorrenciaValida;
    }
    
    /**
     * Carregas campos
     * Busca List com os Motivos Disposição relacionados com as 'Ocorrencia Não Conformidade'
     * 
     * @param criteria ids de 'Ocorrencia Não Conformidade'
     * @return List com os Motivos Disposição
     *  
     *
     */
	@ParametrizedAttribute(type = java.lang.Long.class)
    public Map findFieldsByOcorrenciaNC(List criteria) {
    	
    	List causasNaoConformidade = this.getCausaNaoConformidadeService().findCausasNaoConformidadeByOcorrenciaNC(criteria);
    	List acoesCorretivas = this.getAcaoCorretivaService().findAcoesCorretivasByOcorrenciaNC(criteria);
    	List motivosDisposicao = this.getMotivosDisposicaoEquivalentes(criteria, this.getMotivoDisposicaoService().findMotivoDisposicaoByOcorrenciaNC(criteria));
    	
    	List causasNaoConformidadeView = new ArrayList();
    	List acoesCorretivasView = new ArrayList();
    	List motivosDisposicaoView = new ArrayList();
    	
    	Map mapCausaNaoConformidade = null;
    	
    	for (Iterator iter = causasNaoConformidade.iterator(); iter.hasNext();) {
			CausaNaoConformidade causaNaoConformidade  = (CausaNaoConformidade) iter.next();
			
			mapCausaNaoConformidade = new HashMap();
			mapCausaNaoConformidade.put("idCausaNaoConformidade", causaNaoConformidade.getIdCausaNaoConformidade());
			mapCausaNaoConformidade.put("dsCausaNaoConformidade", causaNaoConformidade.getDsCausaNaoConformidade());
			
			causasNaoConformidadeView.add(mapCausaNaoConformidade);
		}
    	
    	Map mapAcaoCorretiva = null;
    	for (Iterator iter = acoesCorretivas.iterator(); iter.hasNext();) {
			AcaoCorretiva acaoCorretiva = (AcaoCorretiva) iter.next();
			
			mapAcaoCorretiva = new HashMap();
			mapAcaoCorretiva.put("idAcaoCorretiva", acaoCorretiva.getIdAcaoCorretiva());
			mapAcaoCorretiva.put("dsAcaoCorretiva", acaoCorretiva.getDsAcaoCorretiva());
			
			acoesCorretivasView.add(mapAcaoCorretiva);
		}
    	
    	Map mapMotivoDisposicao = null;
    	for (Iterator iter = motivosDisposicao.iterator(); iter.hasNext();) {
			MotivoDisposicao motivoDisposicao = (MotivoDisposicao) iter.next();
			
			mapMotivoDisposicao = new HashMap();
			mapMotivoDisposicao.put("idMotivoDisposicao", motivoDisposicao.getIdMotivoDisposicao());
			mapMotivoDisposicao.put("dsMotivo", motivoDisposicao.getDsMotivo());
			
			motivosDisposicaoView.add(mapMotivoDisposicao);
		}
    	
    	Map mapFields = new HashMap();
    	mapFields.put("causaNaoConformidade", causasNaoConformidadeView);
    	mapFields.put("acoesCorretivas", acoesCorretivasView);
    	mapFields.put("motivosDisposicao", motivosDisposicaoView);
    	
    	return mapFields;
    }

    /**
     * Busca os registros que sao equivalentes para os ids informados.
     * 
     * @param ids
     * @param resultQuery
     * @return
     */
    private List getMotivosDisposicaoEquivalentes(List ids, List resultQuery) {
    	
    	if (ids.size()==1) return resultQuery; 
    	
    	List result = new ArrayList();
	    Long idAnterior = Long.valueOf(0);
		int count = 0;
		
		for (Iterator iter = resultQuery.iterator(); iter.hasNext();) {
			MotivoDisposicao motivoDisposicao = (MotivoDisposicao) iter.next();
			
			if(idAnterior.intValue()==0) idAnterior = motivoDisposicao.getIdMotivoDisposicao(); 
			
			if (motivoDisposicao.getIdMotivoDisposicao().intValue()!=idAnterior.intValue()) {
				count = 1;
				idAnterior = motivoDisposicao.getIdMotivoDisposicao();
			} else {
				count++;
				if (ids.size()==count) result.add(motivoDisposicao);
			}
		}
		
		return result;
	}
    
    /**
     * Busca algums dos dados do usuario logado, que está na sessão.
     * 
     * @return map
     */
    public TypedFlatMap getDataUsuario() {
    	
    	TypedFlatMap usuarioData = new TypedFlatMap();
    	
    	usuarioData.put("usuario.idUsuario", SessionUtils.getUsuarioLogado().getIdUsuario());
    	usuarioData.put("usuario.nmUsuario", SessionUtils.getUsuarioLogado().getNmUsuario());
    	usuarioData.put("filial.idFilial", SessionUtils.getFilialSessao().getIdFilial());
    	usuarioData.put("filial.sgFilial", SessionUtils.getFilialSessao().getSgFilial());
    	usuarioData.put("filial.pessoa.nmPessoa", SessionUtils.getFilialSessao().getPessoa().getNmFantasia());
		
		return usuarioData;
    }

	/**
	 * Faz a validacao do PCE.
	 *  
	 * @param criteria
	 * @return
	 */
	public TypedFlatMap validatePCE(TypedFlatMap criteria) {
		Long idNaoConformidade = criteria.getLong("idNaoConformidade");
		return this.getNaoConformidadeService().validatePCE(idNaoConformidade);
	}
	
	
	
	public List findLookupBySgFilial(TypedFlatMap criteria) {
		return filialService.findLookupBySgFilial(criteria.getString("sgFilial"), criteria.getString("tpAcesso"));
	}
	
	public List findLookupNaoConformidade(Map criteria) {
		return naoConformidadeService.findLookup(criteria);
	}
	
	public List findOrderByDsMotivoDisposicao(Map criteria) {
		return motivoDisposicaoService.findOrderByDsMotivo(criteria);
	}
}