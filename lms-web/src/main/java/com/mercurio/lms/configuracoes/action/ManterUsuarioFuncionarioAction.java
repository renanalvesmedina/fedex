package com.mercurio.lms.configuracoes.action;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import org.apache.commons.lang.StringUtils;

import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.model.DomainValue;
import com.mercurio.adsm.framework.model.FindDefinition;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.configuracoes.ConfiguracoesFacade;
import com.mercurio.lms.configuracoes.model.Funcionario;
import com.mercurio.lms.configuracoes.model.Usuario;
import com.mercurio.lms.configuracoes.model.service.RHCargoService;
import com.mercurio.lms.configuracoes.model.service.UsuarioService;
/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.configuracoes.manterUsuarioFuncionarioAction"
 */
public class ManterUsuarioFuncionarioAction extends CrudAction {
	private static final String CODIGO_INSTRUTOR = "025";
	private UsuarioService usuarioService;
	private ConfiguracoesFacade configuracoesFacade;
	private RHCargoService rhCargoService;

	/**
	 * Andresa Vargas
	 * 
	 * Método criado para tratar os parâmetros recebidos da pesquisa de usuarios/funcionarios
	 * 
	 * @see lms.com.mercurio.lms.configuracoes.model.service.UsuarioService.findPaginatedCustom
	 */
	public ResultSetPage findPaginatedCustom(TypedFlatMap criteria) {
		Long idFilial = criteria.getLong("filial.idFilial");
		String nrMatricula = criteria.getString("nrMatricula");
		String nmFuncionario = criteria.getString("nmUsuario");
		String cdCargo = criteria.getString("codFuncao.cargo.codigo");
		String cdFuncao = criteria.getString("codFuncao.codigo");
		String cdMotorista = criteria.getString("codigoCargoMotorista");
		String tpSituacaoFuncionario = criteria.getString("tpSituacaoFuncionario");
		String cdSetor = criteria.getString("codSetor.codigo");
		String nrCpf = criteria.getString("pessoa.nrIdentificacao");

		if (StringUtils.isNotBlank(cdMotorista)) {
			cdCargo = (String)getConfiguracoesFacade().getValorParametro("CD_CARGO_MOTORISTA");
		}

		ResultSetPage rsp =  getUsuarioService().findPaginatedCustom(idFilial, 
	   												 nrMatricula,
	   												 nmFuncionario,
	   												 cdCargo,
	   												 cdFuncao,
	   												 tpSituacaoFuncionario,
	   												 cdSetor,
	   												 nrCpf,
	   												 true,
	   												 FindDefinition.createFindDefinition(criteria));
		
		List newList = new ArrayList();
		for(Iterator i = rsp.getList().iterator() ; i.hasNext() ; ) {
	   		Usuario usuario = (Usuario)i.next();
    		TypedFlatMap tfm = new TypedFlatMap();

       		Funcionario vfuncionario = usuario.getVfuncionario();
    		tfm.put("idUsuario", usuario.getIdUsuario());
       	 	tfm.put("nrMatricula", usuario.getNrMatricula());
    		tfm.put("nmUsuario", usuario.getNmUsuario());
    		tfm.put("login", usuario.getLogin());
    		if (vfuncionario != null){
    			tfm.put("nmFuncionario", vfuncionario.getNmFuncionario());
	    		tfm.put("nmFantasia",vfuncionario.getFilial().getPessoa().getNmFantasia());
	    		tfm.put("dsFuncao",vfuncionario.getDsFuncao());
	    		tfm.put("dsSituacao",vfuncionario.getDsSituacao()); 
	    		tfm.put("nrCpf", vfuncionario.getNrCpf());
	    		tfm.put("dtNascimento", vfuncionario.getDtNascimento());
	    		DomainValue tpSexo = vfuncionario.getTpSexo();
	    		if (tpSexo != null) {
	    			tfm.put("tpSexo", tpSexo.getValue());
	    		}
	    		tfm.put("nrRg", vfuncionario.getNrRg());
	    		tfm.put("dsOrgaoEmissor", vfuncionario.getDsOrgaoEmissor());
	    		tfm.put("dtEmissaoRg", vfuncionario.getDtEmissaoRg());
	    		tfm.put("nrCnh", vfuncionario.getNrCnh());
	    		tfm.put("tpCategoriaCnh", vfuncionario.getTpCategoriaCnh());
	    		tfm.put("dtVencimentoHabilitacao", vfuncionario.getDtVencimentoHabilitacao());
	    		tfm.put("dsEmail", vfuncionario.getDsEmail());
    		}
    		newList.add(tfm);
		}
		rsp.setList(newList);
	   	return rsp;
	}
	
	/**
	 * Andresa Vargas
	 * 
	 * Método criado para tratar os parâmetros recebidos da pesquisa de usuarios/funcionarios
	 * 
	 * @see lms.com.mercurio.lms.configuracoes.model.service.UsuarioService.getRowCountCustom
	 */	
	public Integer getRowCountCustom(TypedFlatMap criteria) {
		Long idFilial = criteria.getLong("filial.idFilial");
		String nrMatricula = criteria.getString("nrMatricula");
		String nmFuncionario = criteria.getString("nmUsuario");
		String cdCargo = criteria.getString("codFuncao.cargo.codigo");
		String cdFuncao = criteria.getString("codFuncao.codigo");
		String cdMotorista = criteria.getString("codigoCargoMotorista");
		String tpSituacaoFuncionario = criteria.getString("tpSituacaoFuncionario");
		String cdSetor = criteria.getString("codSetor.codigo");
		String nrCpf = criteria.getString("pessoa.nrIdentificacao");

		if (StringUtils.isNotBlank(cdMotorista)) {
			cdCargo = (String)getConfiguracoesFacade().getValorParametro("CD_CARGO_MOTORISTA");
		}

		return getUsuarioService().getRowCountCustom(idFilial, nrMatricula, nmFuncionario, 
			cdCargo, cdFuncao, tpSituacaoFuncionario, cdSetor, nrCpf, true);
	}
	
	
	/**
	 * LMS 7128
	 * 
	 * Método criado para tratar a busca por Instrutores de Motorista com Função de Instrutor ou Monitor de Motorista
	 * 
	 * 
	 */	
	public ResultSetPage findPaginatedInstrutores(TypedFlatMap criteria) {
		Long idFilial = criteria.getLong("filial.idFilial");
		String nrMatricula = criteria.getString("nrMatricula");
		String nmFuncionario = criteria.getString("nmUsuario");
		String cdCargo = criteria.getString("codFuncao.cargo.codigo");
		String cdFuncao = criteria.getString("codFuncao.codigo");
		String cdMotorista = criteria.getString("codigoCargoMotorista");
		String tpSituacaoFuncionario = criteria.getString("tpSituacaoFuncionario");
		String cdSetor = criteria.getString("codSetor.codigo");
		String nrCpf = criteria.getString("pessoa.nrIdentificacao");

		if (CODIGO_INSTRUTOR.equals(cdCargo)){
			cdFuncao = criteria.getString("codFuncaoInstMotorista");
		}
		
		if (StringUtils.isNotBlank(cdMotorista)) {
			cdCargo = (String)getConfiguracoesFacade().getValorParametro("CD_CARGO_MOTORISTA");
		}

		ResultSetPage rsp =  getUsuarioService().findPaginatedCustom(idFilial, 
	   												 nrMatricula,
	   												 nmFuncionario,
	   												 cdCargo,
	   												 cdFuncao,
	   												 tpSituacaoFuncionario,
	   												 cdSetor,
	   												 nrCpf,
	   												 true,
	   												 FindDefinition.createFindDefinition(criteria));
		
		List newList = new ArrayList();
		for(Iterator i = rsp.getList().iterator() ; i.hasNext() ; ) {
	   		Usuario usuario = (Usuario)i.next();
    		TypedFlatMap tfm = new TypedFlatMap();

       		Funcionario vfuncionario = usuario.getVfuncionario();
    		tfm.put("idUsuario", usuario.getIdUsuario());
       	 	tfm.put("nrMatricula", usuario.getNrMatricula());
    		tfm.put("nmUsuario", usuario.getNmUsuario());
    		tfm.put("login", usuario.getLogin());
    		if (vfuncionario != null){
    			tfm.put("nmFuncionario", vfuncionario.getNmFuncionario());
	    		tfm.put("nmFantasia",vfuncionario.getFilial().getPessoa().getNmFantasia());
	    		tfm.put("dsFuncao",vfuncionario.getDsFuncao());
	    		tfm.put("dsSituacao",vfuncionario.getDsSituacao()); 
	    		tfm.put("nrCpf", vfuncionario.getNrCpf());
	    		tfm.put("dtNascimento", vfuncionario.getDtNascimento());
	    		DomainValue tpSexo = vfuncionario.getTpSexo();
	    		if (tpSexo != null) {
	    			tfm.put("tpSexo", tpSexo.getValue());
	    		}
	    		tfm.put("nrRg", vfuncionario.getNrRg());
	    		tfm.put("dsOrgaoEmissor", vfuncionario.getDsOrgaoEmissor());
	    		tfm.put("dtEmissaoRg", vfuncionario.getDtEmissaoRg());
	    		tfm.put("nrCnh", vfuncionario.getNrCnh());
	    		tfm.put("tpCategoriaCnh", vfuncionario.getTpCategoriaCnh());
	    		tfm.put("dtVencimentoHabilitacao", vfuncionario.getDtVencimentoHabilitacao());
	    		tfm.put("dsEmail", vfuncionario.getDsEmail());
    		}
    		newList.add(tfm);
		}
		rsp.setList(newList);
	   	return rsp;
	}
	
	
	
	// --- LMS 7128 ----
	public Integer getRowCountInstrutores(TypedFlatMap criteria) {
		Long idFilial = criteria.getLong("filial.idFilial");
		String nrMatricula = criteria.getString("nrMatricula");
		String nmFuncionario = criteria.getString("nmUsuario");
		String cdCargo = criteria.getString("codFuncao.cargo.codigo");
		String cdFuncao = criteria.getString("codFuncao.codigo");
		String cdMotorista = criteria.getString("codigoCargoMotorista");
		String tpSituacaoFuncionario = criteria.getString("tpSituacaoFuncionario");
		String cdSetor = criteria.getString("codSetor.codigo");
		String nrCpf = criteria.getString("pessoa.nrIdentificacao");

		if (CODIGO_INSTRUTOR.equals(cdCargo)){
			cdFuncao = criteria.getString("codFuncaoInstMotorista");
		}
		
		if (StringUtils.isNotBlank(cdMotorista)) {
			cdCargo = (String)getConfiguracoesFacade().getValorParametro("CD_CARGO_MOTORISTA");
		}

		return getUsuarioService().getRowCountCustom(idFilial, nrMatricula, nmFuncionario, 
			cdCargo, cdFuncao, tpSituacaoFuncionario, cdSetor, nrCpf, true);
	}

	/**
	 * Andresa Vargas
	 * 
	 * FindCargo
	 * 
	 * @param criteria
	 * @return
	 */
	public List findCargo(TypedFlatMap criteria){
		return rhCargoService.findByOrder(criteria);
	}
	
	public RHCargoService getRhCargoService() {
		return rhCargoService;
	}

	public void setRhCargoService(RHCargoService rhCargoService) {
		this.rhCargoService = rhCargoService;
	}

	public UsuarioService getUsuarioService() {
		return usuarioService;
	}

	public void setUsuarioService(UsuarioService usuarioService) {
		this.usuarioService = usuarioService;
	}

	public ConfiguracoesFacade getConfiguracoesFacade() {
		return configuracoesFacade;
	}

	public void setConfiguracoesFacade(ConfiguracoesFacade configuracoesFacade) {
		this.configuracoesFacade = configuracoesFacade;
	}


}
