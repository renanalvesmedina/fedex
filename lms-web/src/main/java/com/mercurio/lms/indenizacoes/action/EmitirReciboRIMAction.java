package com.mercurio.lms.indenizacoes.action;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.mercurio.adsm.framework.model.DomainValue;
import com.mercurio.adsm.framework.model.FindDefinition;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.report.ReportActionSupport;
import com.mercurio.adsm.framework.util.FilterList;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.indenizacoes.model.ReciboIndenizacao;
import com.mercurio.lms.indenizacoes.model.service.DoctoServicoIndenizacaoService;
import com.mercurio.lms.indenizacoes.model.service.ReciboIndenizacaoService;
import com.mercurio.lms.indenizacoes.report.EmitirReciboRIMService;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.util.FormatUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.indenizacoes.emitirReciboRIMAction"
 */

public class EmitirReciboRIMAction extends ReportActionSupport {
	private FilialService filialService;
	private ReciboIndenizacaoService reciboIndenizacaoService;
	private DoctoServicoIndenizacaoService doctoServicoIndenizacaoService;

	private DoctoServicoIndenizacaoService getDoctoServicoIndenizacaoService() {
		return doctoServicoIndenizacaoService;
	}

	public void setDoctoServicoIndenizacaoService(
			DoctoServicoIndenizacaoService doctoServicoIndenizacaoService) {
		this.doctoServicoIndenizacaoService = doctoServicoIndenizacaoService;
	}

	private ReciboIndenizacaoService getReciboIndenizacaoService() {
		return reciboIndenizacaoService;
	}

	public void setReciboIndenizacaoService(
			ReciboIndenizacaoService reciboIndenizacaoService) {
		this.reciboIndenizacaoService = reciboIndenizacaoService;
	}

	private FilialService getFilialService() {
		return filialService;
	}

	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	
	public void setEmitirReciboRIMService(EmitirReciboRIMService emitirReciboRIMService) {
		this.reportServiceSupport = emitirReciboRIMService;
	}

	/**
	 * 
	 * @param tfm
	 * @return
	 */
	public ResultSetPage findDoctosServicosByRim(TypedFlatMap tfm ) {
		Long idRim = tfm.getLong("reciboIndenizacao.idReciboIndenizacao");
		return getDoctoServicoIndenizacaoService().findDoctoServicosByIdReciboIndenizacao(idRim, FindDefinition.createFindDefinition(tfm));
	}

	public Integer getRowCountDoctosServicosByRim(TypedFlatMap tfm ) {
		Long idRim = tfm.getLong("reciboIndenizacao.idReciboIndenizacao");
		return getDoctoServicoIndenizacaoService().getRowCountDoctoServicosByIdReciboIndenizacao(idRim);
	}

    /**
     * Consulta a filial pela sigla informada 
     * @param map
     * @return
     */
    public List findLookupFilial(Map map) {
    	FilterList filter = new FilterList(getFilialService().findLookup(map)) {
			public Map filterItem(Object item) {
				Filial filial = (Filial)item;
    			TypedFlatMap typedFlatMap = new TypedFlatMap();
	    		typedFlatMap.put("idFilial", filial.getIdFilial());
		    	typedFlatMap.put("sgFilial",  filial.getSgFilial());
		    	typedFlatMap.put("pessoa.nmFantasia",  filial.getPessoa().getNmFantasia());
				return typedFlatMap;
			}
    	};
    	return (List)filter.doFilter();
    }
    
    /**
     * Método que busca o recibo indenifação e os campos necessários para a 
     * tela de liberar rim 
     * @param criteria
     * @return
     */
    public List findReciboIndenizacao(TypedFlatMap criteria) {
    	Long idFilial = criteria.getLong("filial.idFilial");
    	Integer nrReciboIndenizacao = criteria.getInteger("nrReciboIndenizacao");
    	Long idReciboIndenizacao = criteria.getLong("idReciboIndenizacao");
    	List result = this.getReciboIndenizacaoService().findReciboIndenizacaoToProcessosRim(idFilial, nrReciboIndenizacao, idReciboIndenizacao);
    	TypedFlatMap typedFlatMap = new TypedFlatMap();
    	List retorno = new ArrayList();    	
    	if (result.size()>0){
    		typedFlatMap = (TypedFlatMap)result.get(0);
    		
    		String favorecidoNrIdentificacao = typedFlatMap.getString("pessoaByIdFavorecido.nrIdentificacao");
    		String favorecidoTpIdentificacao = typedFlatMap.getString("pessoaByIdFavorecido.tpIdentificacao.value");
    		String favorecidoNrIdentificacaoFormatado = "";
    		
    		if (StringUtils.isNotBlank(favorecidoNrIdentificacao) && StringUtils.isNotBlank(favorecidoTpIdentificacao)) {
    			favorecidoNrIdentificacaoFormatado = FormatUtils.formatIdentificacao(favorecidoTpIdentificacao, favorecidoNrIdentificacao);
    		}
    		
    		typedFlatMap.put("pessoaByIdFavorecido.nrIdentificacaoFormatado", favorecidoNrIdentificacaoFormatado);
    		
    		String beneficiarioNrIdentificacao = typedFlatMap.getString("pessoaByIdBeneficiario.nrIdentificacao");
    		String beneficiarioTpIdentificacao = typedFlatMap.getString("pessoaByIdBeneficiario.tpIdentificacao.value");
    		String beneficiarioNrIdentificacaoFormatado = FormatUtils.formatIdentificacao(beneficiarioTpIdentificacao, beneficiarioNrIdentificacao);
    		typedFlatMap.put("pessoaByIdBeneficiario.nrIdentificacaoFormatado", beneficiarioNrIdentificacaoFormatado);
    		retorno.add(typedFlatMap);
    	}
    	
    	return retorno;
    }
    
    /**
     * Método que chama a geração de evento_rim 
     * @param tfm
     */
    public DomainValue executeEmitirReciboRIM(TypedFlatMap tfm) {
    	Long idRim = tfm.getLong("reciboIndenizacao.idReciboIndenizacao");
    	ReciboIndenizacao rim = this.getReciboIndenizacaoService().findById(idRim);
    	this.getReciboIndenizacaoService().executeEmitirReciboRIM(rim);
    	DomainValue dv = this.getReciboIndenizacaoService().findById(idRim).getTpStatusIndenizacao();
    	return dv;

    }

}
