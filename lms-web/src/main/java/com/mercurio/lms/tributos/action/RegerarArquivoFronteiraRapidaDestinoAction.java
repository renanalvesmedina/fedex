package com.mercurio.lms.tributos.action;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.expedicao.model.service.ManifestoViagemNacionalService;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.tributos.model.service.GeraFronteiraRapidaDestinoService;
import com.mercurio.lms.util.session.SessionUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.tributos.regerarArquivoFronteiraRapidaDestinoAction"
 */

public class RegerarArquivoFronteiraRapidaDestinoAction extends CrudAction {

    GeraFronteiraRapidaDestinoService destinoService;
    FilialService filialService;
    ManifestoViagemNacionalService nacionalService;
    
    /**
     * Método que chama a service de geração do arquivo de Fronteira Rápida
     * @param map Critério : idManifesto
     */
    public String generateFronteiraRapidaDestino(TypedFlatMap map){
        
        Long idManifesto = map.getLong("manifesto.manifestoViagemNacional.idManifestoViagemNacional");
        
        String tpStatusManifesto = map.getString("tpStatusManifesto");
        
        if( !tpStatusManifesto.equals("ME") && !tpStatusManifesto.equals("EV") ){
        	throw new BusinessException("LMS-23011");
        }
        
        return getDestinoService().generateFronteiraRapidaDestino(idManifesto);
    }
    
    /**
     * 
     * Busca as filiais para a lookup de manifesto
     * 
     * @author José Rodrigo Moraes
     * @since 08/11/2006
     *
     * @param criteria Critérios de pesquisa
     * @return Lista de filiais
     */                
    public List findLookupManifestoDocumentFilialVN(Map criteria) {
    	List list = filialService.findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		Filial filial = (Filial)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idFilial", filial.getIdFilial());
    		typedFlatMap.put("sgFilial", filial.getSgFilial());
    		typedFlatMap.put("pessoa.nmFantasia",filial.getPessoa().getNmFantasia());
    		retorno.add(typedFlatMap);
    	}
    	return retorno;
    }
    
    /**
     * Find Lookup de Manifesto
     *
     * @author José Rodrigo Moraes
     * @since 08/11/2006
     *
     * @param criteria
     * @return
     */                
    public List findLookupManifestoDocumentNumberVN(TypedFlatMap criteria) {
    	String nrManifestoOrigem = criteria.getString("nrManifestoOrigem");
    	Long idFilial = criteria.getLong("manifesto.filialByIdFilialOrigem.idFilial");
    	return  getNacionalService().findLookupManifestoVNSpecific(nrManifestoOrigem, idFilial);
    }
    
    /**
     * Retorna a filial do usuário logado 
     *
     * @author Hector Julian Esnaola Junior
     * @since 26/02/2007
     *
     * @return
     *
     */
	public TypedFlatMap findFilialUsuarioLogado(){
		TypedFlatMap tfm = new TypedFlatMap();
		Filial filial = SessionUtils.getFilialSessao();		
		tfm.put("filial.idFilial",filial.getIdFilial());
		tfm.put("filial.sgFilial",filial.getSgFilial());
		tfm.put("filial.pessoa.nmFantasia",filial.getPessoa().getNmFantasia());
		return tfm;
	}
    
    public GeraFronteiraRapidaDestinoService getDestinoService() {
        return destinoService;
    }

    public void setDestinoService(GeraFronteiraRapidaDestinoService destinoService) {
        this.destinoService = destinoService;
    }

    public FilialService getFilialService() {
        return filialService;
    }

    public void setFilialService(FilialService filialService) {
        this.filialService = filialService;
    }

    public ManifestoViagemNacionalService getNacionalService() {
        return nacionalService;
    }

    public void setNacionalService(ManifestoViagemNacionalService nacionalService) {
        this.nacionalService = nacionalService;
    }

}
