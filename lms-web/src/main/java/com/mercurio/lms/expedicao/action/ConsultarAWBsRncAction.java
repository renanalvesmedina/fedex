package com.mercurio.lms.expedicao.action;

import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.expedicao.model.DoctoServico;
import com.mercurio.lms.expedicao.model.service.DoctoServicoService;
import com.mercurio.lms.rnc.model.NaoConformidade;
import com.mercurio.lms.rnc.model.service.NaoConformidadeService;
import com.mercurio.lms.rnc.model.service.OcorrenciaNaoConformidadeService;
import com.mercurio.lms.util.FormatUtils;
import com.mercurio.lms.vendas.model.Cliente;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.expedicao.consultarAWBsRncAction"
 */

public class ConsultarAWBsRncAction extends CrudAction {
	
	private NaoConformidadeService naoConformidadeService;
	private DoctoServicoService doctoServicoService;
	private OcorrenciaNaoConformidadeService ocorrenciaNaoConformidadeService;
	
	private static final Integer MOTIVO_TRINTA = 30; 
	private static final Integer MOTIVO_TRINTA_E_UM =  31;
	private static final Integer MOTIVO_TRINTA_E_DOIS = 32;
	private static final Integer MOTIVO_TRINTA_E_TRES = 33;
	private static final Integer MOTIVO_TRINTA_E_QUATRO = 34;
	private static final Integer MOTIVO_TRINTA_E_CINCO = 35;
	
	public ResultSetPage findPaginatedGridNaoConformidade(TypedFlatMap criteria) {
    	return getNaoConformidadeService().findPaginatedByAwb(criteria);
    }
	
	public Integer getRowCountGridNaoConformidade(TypedFlatMap criteria) {
    	return getNaoConformidadeService().getRowCountByAwb(criteria);
    }
	
	public TypedFlatMap findByIdRnc(java.lang.Long id) {
    	NaoConformidade nc = getNaoConformidadeService().findById(id);

    	TypedFlatMap tfm = new TypedFlatMap();
    	tfm.put("idNaoConformidade", nc.getIdNaoConformidade());
    	tfm.put("filial.idFilial", nc.getFilial().getIdFilial());
    	tfm.put("filial.sgFilial", nc.getFilial().getSgFilial());
    	tfm.put("nrNaoConformidade", nc.getNrNaoConformidade());
    	tfm.put("tpStatusNaoConformidade.description", nc.getTpStatusNaoConformidade().getDescription());

    	Cliente clienteByIdClienteDestinatario = nc.getClienteByIdClienteDestinatario();
    	if (clienteByIdClienteDestinatario != null) {
	    	tfm.put("clienteByIdClienteDestinatario.idCliente", clienteByIdClienteDestinatario.getIdCliente());
	    	tfm.put("clienteByIdClienteDestinatario.pessoa.nmPessoa", clienteByIdClienteDestinatario.getPessoa().getNmPessoa());
	    	tfm.put("clienteByIdClienteDestinatario.pessoa.tpIdentificacao", clienteByIdClienteDestinatario.getPessoa().getTpIdentificacao());
	    	tfm.put("clienteByIdClienteDestinatario.pessoa.nrIdentificacao", 
	    		FormatUtils.formatIdentificacao(clienteByIdClienteDestinatario.getPessoa().getTpIdentificacao().getValue(), 
    			clienteByIdClienteDestinatario.getPessoa().getNrIdentificacao()));
    	}

    	Cliente clienteByIdClienteRemetente = nc.getClienteByIdClienteRemetente();
    	if (clienteByIdClienteRemetente != null) {
	    	tfm.put("clienteByIdClienteRemetente.idCliente", clienteByIdClienteRemetente.getIdCliente());
	    	tfm.put("clienteByIdClienteRemetente.pessoa.nmPessoa", clienteByIdClienteRemetente.getPessoa().getNmPessoa());
	    	tfm.put("clienteByIdClienteRemetente.pessoa.tpIdentificacao", clienteByIdClienteRemetente.getPessoa().getTpIdentificacao());
	    	tfm.put("clienteByIdClienteRemetente.pessoa.nrIdentificacao", 
	    		FormatUtils.formatIdentificacao(clienteByIdClienteRemetente.getPessoa().getTpIdentificacao().getValue(), 
   				clienteByIdClienteRemetente.getPessoa().getNrIdentificacao()));
    	}

    	Object objDoctoServico = nc.getDoctoServico();
    	if (objDoctoServico != null) {
    		DoctoServico doctoServico = (DoctoServico)objDoctoServico;
    		tfm.put("doctoServico.idDoctoServico", doctoServico.getIdDoctoServico());
    		tfm.put("doctoServico.nrDoctoServico", doctoServico.getNrDoctoServico());
    		tfm.put("doctoServico.tpDocumentoServico.description", doctoServico.getTpDocumentoServico().getDescription());
			tfm.put("doctoServico.moeda.idMoeda", doctoServico.getMoeda().getIdMoeda());
			tfm.put("doctoServico.moeda.dsSimbolo", doctoServico.getMoeda().getSiglaSimbolo());
			tfm.put("doctoServico.moeda.sgMoeda", doctoServico.getMoeda().getSgMoeda());
			tfm.put("doctoServico.filialByIdFilialOrigem.idFilial", doctoServico.getFilialByIdFilialOrigem().getIdFilial());
			tfm.put("doctoServico.filialByIdFilialOrigem.sgFilial", doctoServico.getFilialByIdFilialOrigem().getSgFilial());

        	TypedFlatMap mapDataDoctoServico = getDoctoServicoService().findDoctoServicoByTpDocumento(doctoServico.getIdDoctoServico());
        	tfm.put("qtVolumesDoctoServico", mapDataDoctoServico.getInteger("qtVolumes"));
        	tfm.put("destinoDoctoServico", mapDataDoctoServico.getString("filialByIdFilialDestino.sgFilial"));
        	tfm.put("vlTotalDocServico", mapDataDoctoServico.getBigDecimal("vlTotalDocServico"));
        	tfm.put("doctoServico.dhEmissao", mapDataDoctoServico.getDateTime("dhEmissao"));
    	}
    	
    	if(nc.getTpModal() != null){
    		tfm.put("tpModal", nc.getTpModal().getDescriptionAsString());
    	}
    	
		tfm.put("blExisteOcorrenciaAberta", 
				ocorrenciaNaoConformidadeService.validateExisteOcorrenciaAbertaByIdNaoConformidade(id));

		/*
		 * LMS-3240 
		 */
		tfm.put("blExisteOcorrenciNaoConformidade", !ocorrenciaNaoConformidadeService.findOcorreciasByIdNaoConformidadeAndMotivoAberturaNc(id, MOTIVO_TRINTA, MOTIVO_TRINTA_E_UM, MOTIVO_TRINTA_E_DOIS, MOTIVO_TRINTA_E_TRES, MOTIVO_TRINTA_E_QUATRO, MOTIVO_TRINTA_E_CINCO).isEmpty());

    	return tfm;
    }

	public NaoConformidadeService getNaoConformidadeService() {
		return naoConformidadeService;
	}

	public void setNaoConformidadeService(
			NaoConformidadeService naoConformidadeService) {
		this.naoConformidadeService = naoConformidadeService;
	}

	public DoctoServicoService getDoctoServicoService() {
		return doctoServicoService;
	}

	public void setDoctoServicoService(DoctoServicoService doctoServicoService) {
		this.doctoServicoService = doctoServicoService;
	}

	public OcorrenciaNaoConformidadeService getOcorrenciaNaoConformidadeService() {
		return ocorrenciaNaoConformidadeService;
	}

	public void setOcorrenciaNaoConformidadeService(
			OcorrenciaNaoConformidadeService ocorrenciaNaoConformidadeService) {
		this.ocorrenciaNaoConformidadeService = ocorrenciaNaoConformidadeService;
	}
}
