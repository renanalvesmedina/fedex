package com.mercurio.lms.municipios.action;

import java.util.List;
import java.util.Map;

import org.joda.time.YearMonthDay;

import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;
import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.Municipio;
import com.mercurio.lms.municipios.model.MunicipioFilial;
import com.mercurio.lms.municipios.model.UnidadeFederativa;
import com.mercurio.lms.municipios.model.service.EmpresaService;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.municipios.model.service.MunicipioFilialCliOrigemService;
import com.mercurio.lms.municipios.model.service.MunicipioFilialFilOrigemService;
import com.mercurio.lms.municipios.model.service.MunicipioFilialIntervCepService;
import com.mercurio.lms.municipios.model.service.MunicipioFilialSegmentoService;
import com.mercurio.lms.municipios.model.service.MunicipioFilialService;
import com.mercurio.lms.municipios.model.service.MunicipioFilialUFOrigemService;
import com.mercurio.lms.municipios.model.service.MunicipioService;
import com.mercurio.lms.municipios.model.service.PaisService;
import com.mercurio.lms.municipios.model.service.UnidadeFederativaService;
import com.mercurio.lms.util.FormatUtils;
import com.mercurio.lms.util.JTVigenciaUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.municipios.manterMunicipiosAtendidosAction"
 */ 

public class ManterMunicipiosAtendidosAction extends CrudAction {
	private MunicipioFilialSegmentoService municipioFilialSegmentoService;
	private MunicipioFilialIntervCepService municipioFilialIntervCepService;
	private MunicipioFilialFilOrigemService municipioFilialFilOrigemService;
	private MunicipioFilialCliOrigemService municipioFilialCliOrigemService;
	private MunicipioFilialUFOrigemService municipioFilialUFOrigemService;
	private EmpresaService empresaService;
	private FilialService filialService;
	private MunicipioService municipioService;
	private UnidadeFederativaService unidadeFederativaService;
	private PaisService paisService;

	public void removeById(java.lang.Long id) {
		getMunicipioFilialService().removeById(id);
	}

	/**
	 *
	 */
	@ParametrizedAttribute(type = java.lang.Long.class)
	public void removeByIds(List ids) {
		getMunicipioFilialService().removeByIds(ids);
	}

	public ResultSetPage findPaginatedCustom(TypedFlatMap criteria) {
		return getMunicipioFilialService().findPaginatedCustom(criteria);
	}

	public Integer getRowCountCustom(TypedFlatMap criteria) {
		return getMunicipioFilialService().getRowCountCustom(criteria);
	}

	public TypedFlatMap findById(java.lang.Long id) {
		MunicipioFilial bean = getMunicipioFilialService().findById(id);
		TypedFlatMap retorno = bean2map(bean);
		Integer acaoVigencia = JTVigenciaUtils.getIntegerAcaoVigencia(bean);
		retorno.put("acaoVigenciaAtual", acaoVigencia);

		verifyRestricaoAtendimento(retorno, bean);
		return retorno;
	}

	private void verifyRestricaoAtendimento(Map<String, Object> result, MunicipioFilial municipioFilial) {
		Long idMunicipio = municipioFilial.getMunicipio().getIdMunicipio();
		Long idFilial = municipioFilial.getFilial().getIdFilial();
		YearMonthDay dtVigencia = municipioFilial.getDtVigenciaInicial();

		boolean blRestricaoAtendimentoCliente = municipioFilialCliOrigemService.validateMunicipioVigenciaFutura(idMunicipio, idFilial, dtVigencia);
		boolean blRestricaoAtendimentoSegmento = municipioFilialSegmentoService.validateMunicipioVigenciaFutura(idMunicipio, idFilial, dtVigencia);
		boolean blRestricaoAtendimentoFilial = municipioFilialFilOrigemService.validateMunicipioVigenciaFutura(idMunicipio, idFilial, dtVigencia);
		boolean blRestricaoAtendimentoIntervaloCep = municipioFilialIntervCepService.validateMunicipioVigenciaFutura(idMunicipio, idFilial, dtVigencia);
		boolean blRestricaoAtendimentoUf = municipioFilialUFOrigemService.validateMunicipioVigenciaFutura(idMunicipio, idFilial, dtVigencia);

		if (!blRestricaoAtendimentoCliente
				&& !blRestricaoAtendimentoSegmento
				&& !blRestricaoAtendimentoFilial
				&& !blRestricaoAtendimentoIntervaloCep
				&& !blRestricaoAtendimentoUf
		) {
			boolean blDisableAtendimento = !municipioFilial.getBlRestricaoAtendimento();
			result.put("blDisableAtendimentoCliente", blDisableAtendimento);
			result.put("blDisableAtendimentoSegmento", blDisableAtendimento);
			result.put("blDisableAtendimentoFilial", blDisableAtendimento);
			result.put("blDisableAtendimentoIntervaloCep", blDisableAtendimento);
			result.put("blDisableAtendimentoUf", blDisableAtendimento);
		} else {
			result.put("blDisableAtendimentoCliente", !blRestricaoAtendimentoCliente);
			result.put("blDisableAtendimentoSegmento", !blRestricaoAtendimentoSegmento);
			result.put("blDisableAtendimentoFilial", !blRestricaoAtendimentoFilial);
			result.put("blDisableAtendimentoIntervaloCep", !blRestricaoAtendimentoIntervaloCep);
			result.put("blDisableAtendimentoUf", !blRestricaoAtendimentoUf);
		}
	}

	private TypedFlatMap bean2map(MunicipioFilial municipioFilial){
		TypedFlatMap map = new TypedFlatMap(); 

		map.put("idMunicipioFilial", municipioFilial.getIdMunicipioFilial());
		map.put("nrDistanciaChao", municipioFilial.getNrDistanciaChao());
		map.put("nrDistanciaAsfalto", municipioFilial.getNrDistanciaAsfalto());
		map.put("nrGrauDificuldade", municipioFilial.getNrGrauDificuldade());
		map.put("blRecebeColetaEventual", municipioFilial.getBlRecebeColetaEventual());
		map.put("blDificuldadeEntrega", municipioFilial.getBlDificuldadeEntrega());
		map.put("blPadraoMcd", municipioFilial.getBlPadraoMcd());
		map.put("blRestricaoAtendimento", municipioFilial.getBlRestricaoAtendimento());
		map.put("blRestricaoTransporte", municipioFilial.getBlRestricaoTransporte());
		map.put("nmMunicipioAlternativo", municipioFilial.getNmMunicipioAlternativo());
		map.put("dtVigenciaInicial", municipioFilial.getDtVigenciaInicial());
		map.put("dtVigenciaFinal", municipioFilial.getDtVigenciaFinal());

		Filial filial = municipioFilial.getFilial();
		map.put("filial.empresa.idEmpresa", filial.getEmpresa().getIdEmpresa());
		map.put("filial.empresa.pessoa.nrIdentificacao", filial.getEmpresa().getPessoa().getNrIdentificacao()); 
		map.put("filial.empresa.pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(filial.getEmpresa().getPessoa().getTpIdentificacao(), filial.getEmpresa().getPessoa().getNrIdentificacao()));
		map.put("filial.empresa.pessoa.nmPessoa", filial.getEmpresa().getPessoa().getNmPessoa());
		map.put("filial.empresa.tpEmpresa", filial.getEmpresa().getTpEmpresa().getValue());
		map.put("filial.idFilial", filial.getIdFilial());
		map.put("filial.sgFilial", filial.getSgFilial());
		map.put("filial.siglaNomeFilial", filial.getSiglaNomeFilial());
		map.put("filial.pessoa.nmFantasia", filial.getPessoa().getNmFantasia());

		Municipio municipio = municipioFilial.getMunicipio();
		map.put("municipio.nmMunicipio", municipio.getNmMunicipio());
		map.put("municipio.idMunicipio", municipio.getIdMunicipio());
		map.put("municipio.blDistrito", municipio.getBlDistrito());

		UnidadeFederativa unidadeFederativa = municipio.getUnidadeFederativa();	
		map.put("municipio.unidadeFederativa.sgUnidadeFederativa", unidadeFederativa.getSgUnidadeFederativa());
		map.put("municipio.unidadeFederativa.idUnidadeFederativa", unidadeFederativa.getIdUnidadeFederativa());
		map.put("municipio.unidadeFederativa.nmUnidadeFederativa", unidadeFederativa.getNmUnidadeFederativa());
		map.put("municipio.unidadeFederativa.siglaDescricao", unidadeFederativa.getSiglaDescricao());
		map.put("municipio.unidadeFederativa.pais.idPais", unidadeFederativa.getPais().getIdPais());
		map.put("municipio.unidadeFederativa.pais.nmPais", unidadeFederativa.getPais().getNmPais());

		if (municipio.getMunicipioDistrito() != null){
			map.put("municipio.municipioDistrito.nmMunicipio", municipio.getMunicipioDistrito().getNmMunicipio());
			map.put("municipio.municipioDistrito.idMunicipio", municipio.getMunicipioDistrito().getIdMunicipio());
		}

		return map;
	}

	public Map store(TypedFlatMap bean) {
		MunicipioFilial municipioFilial = new MunicipioFilial();

		municipioFilial.setIdMunicipioFilial(bean.getLong("idMunicipioFilial"));

		Filial filial = new Filial();
		filial.setIdFilial(bean.getLong("filial.idFilial"));
		municipioFilial.setFilial(filial);

		Municipio municipio = new Municipio();
		municipio.setIdMunicipio(bean.getLong("municipio.idMunicipio"));
		municipioFilial.setMunicipio(municipio);

		municipioFilial.setNmMunicipioAlternativo(bean.getString("nmMunicipioAlternativo"));
		municipioFilial.setNrDistanciaAsfalto(bean.getInteger("nrDistanciaAsfalto"));
		municipioFilial.setNrDistanciaChao(bean.getInteger("nrDistanciaChao"));
		municipioFilial.setNrGrauDificuldade(bean.getInteger("nrGrauDificuldade"));
		municipioFilial.setBlRecebeColetaEventual(bean.getBoolean("blRecebeColetaEventual"));
		municipioFilial.setBlDificuldadeEntrega(bean.getBoolean("blDificuldadeEntrega"));
		municipioFilial.setBlPadraoMcd(bean.getBoolean("blPadraoMcd"));
		municipioFilial.setBlRestricaoAtendimento(bean.getBoolean("blRestricaoAtendimento"));
		municipioFilial.setBlRestricaoTransporte(bean.getBoolean("blRestricaoTransporte"));
		municipioFilial.setDtVigenciaInicial(bean.getYearMonthDay("dtVigenciaInicial"));
		municipioFilial.setDtVigenciaFinal(bean.getYearMonthDay("dtVigenciaFinal"));

		Boolean blVerificaRestricaoAtendimento = bean.getBoolean("blVerificaRestricaoAtendimento");
		getMunicipioFilialService().store(municipioFilial, blVerificaRestricaoAtendimento);

		bean.put("idMunicipioFilial", municipioFilial.getIdMunicipioFilial());
		bean.put("acaoVigenciaAtual", JTVigenciaUtils.getIntegerAcaoVigencia(municipioFilial));

		verifyRestricaoAtendimento(bean, municipioFilial);
		return bean;
	}

	public List findLookupEmpresa(Map criteria) {
		return empresaService.findLookup(criteria);
	}

	public List findLookupFilial(TypedFlatMap criteria) {
		return filialService.findLookupAsPaginated(criteria);
	}

	public List findLookupMunicipio(Map criteria) {
		return municipioService.findLookup(criteria);
	}
    
    public List findLookupUnidadeFederativa(Map criteria) {
    	return unidadeFederativaService.findLookup(criteria);
    }
    
    public List findLookupPais(Map criteria) {
    	return paisService.findLookup(criteria);
    }
    
	public void setMunicipioFilialService(MunicipioFilialService municipioFilialService) {
		this.defaultService = municipioFilialService;
	}
	private final MunicipioFilialService getMunicipioFilialService() {
		return (MunicipioFilialService)this.defaultService;
	}
	/**
	 * @param municipioFilialCliOrigemService The municipioFilialCliOrigemService to set.
	 */
	public void setMunicipioFilialCliOrigemService(MunicipioFilialCliOrigemService municipioFilialCliOrigemService) {
		this.municipioFilialCliOrigemService = municipioFilialCliOrigemService;
	}
	/**
	 * @param municipioFilialFilOrigemService The municipioFilialFilOrigemService to set.
	 */
	public void setMunicipioFilialFilOrigemService(MunicipioFilialFilOrigemService municipioFilialFilOrigemService) {
		this.municipioFilialFilOrigemService = municipioFilialFilOrigemService;
	}
	/**
	 * @param municipioFilialIntervCepService The municipioFilialIntervCepService to set.
	 */
	public void setMunicipioFilialIntervCepService(MunicipioFilialIntervCepService municipioFilialIntervCepService) {
		this.municipioFilialIntervCepService = municipioFilialIntervCepService;
	}
	/**
	 * @param municipioFilialSegmentoService The municipioFilialSegmentoService to set.
	 */
	public void setMunicipioFilialSegmentoService(MunicipioFilialSegmentoService municipioFilialSegmentoService) {
		this.municipioFilialSegmentoService = municipioFilialSegmentoService;
	}
	/**
	 * @param municipioFilialUFOrigemService The municipioFilialUFOrigemService to set.
	 */
	public void setMunicipioFilialUFOrigemService(MunicipioFilialUFOrigemService municipioFilialUFOrigemService) {
		this.municipioFilialUFOrigemService = municipioFilialUFOrigemService;
	}
	public void setEmpresaService(EmpresaService empresaService) {
		this.empresaService = empresaService;
	}
	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	public void setMunicipioService(MunicipioService municipioService) {
		this.municipioService = municipioService;
	}
	public void setUnidadeFederativaService(UnidadeFederativaService unidadeFederativaService) {
		this.unidadeFederativaService = unidadeFederativaService;
	}
	public void setPaisService(PaisService paisService) {
		this.paisService = paisService;
	}
}
