package com.mercurio.lms.portaria.action;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.util.FilterResultSetPage;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.portaria.model.ConfiguracaoAuditoria;
import com.mercurio.lms.portaria.model.service.ConfiguracaoAuditoriaService;
import com.mercurio.lms.util.JTVigenciaUtils;

import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;

/**
 * Generated by: ADSM ActionGenerator 
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.portaria.manterConfiguracaoAuditoriasAction"
 */

public class ManterConfiguracaoAuditoriasAction extends CrudAction {
	
	private FilialService filialService;
	
	public TypedFlatMap store(TypedFlatMap tfm) {
		Filial filial = new Filial();
	    filial.setIdFilial(tfm.getLong("filial.idFilial"));

	    ConfiguracaoAuditoria configuracaoAuditoria = new ConfiguracaoAuditoria();
	    configuracaoAuditoria.setIdConfiguracaoAuditoria(tfm.getLong("idConfiguracaoAuditoria"));
	    configuracaoAuditoria.setFilial(filial);
	    configuracaoAuditoria.setDtVigenciaInicial(tfm.getYearMonthDay("dtVigenciaInicial"));
	    configuracaoAuditoria.setDtVigenciaFinal(tfm.getYearMonthDay("dtVigenciaFinal"));
	    configuracaoAuditoria.setHrConfiguracaoInicial(tfm.getTimeOfDay("hrConfiguracaoInicial"));
	    configuracaoAuditoria.setHrConfiguracaoFinal(tfm.getTimeOfDay("hrConfiguracaoFinal"));
	    // transformando horas em minutos
	    configuracaoAuditoria.setHrTempoAuditoria(
	    						Integer.valueOf(( 
	    								new BigDecimal(tfm.getDouble("hrTempoAuditoria").doubleValue()).multiply(
	    										new BigDecimal(60))).intValue())
	    	);
	    configuracaoAuditoria.setNrPrazoAuditoria(tfm.getShort("nrPrazoAuditoria"));
	    configuracaoAuditoria.setQtVeiculosProprios(tfm.getShort("qtVeiculosProprios"));
	    configuracaoAuditoria.setQtVeiculosTerceiros(tfm.getShort("qtVeiculosTerceiros"));
	    configuracaoAuditoria.setTpOperacao(tfm.getDomainValue("tpOperacao"));
	    getConfiguracaoAuditoriaService().store(configuracaoAuditoria);
	    tfm.put("acaoVigenciaAtual", JTVigenciaUtils.getIntegerAcaoVigencia(configuracaoAuditoria));
	    tfm.put("idConfiguracaoAuditoria",configuracaoAuditoria.getIdConfiguracaoAuditoria());
	    
		return tfm; 
	}
	
	public ResultSetPage findPaginated(Map criteria) {
		ResultSetPage rs = getConfiguracaoAuditoriaService().findPaginated(criteria);
		FilterResultSetPage filterResultSetPage = new FilterResultSetPage(rs){
			public Map filterItem(Object item) {
				TypedFlatMap row = new TypedFlatMap();
				ConfiguracaoAuditoria configuracaoAuditoria = (ConfiguracaoAuditoria) item;
				
				row.put("idConfiguracaoAuditoria", configuracaoAuditoria.getIdConfiguracaoAuditoria());
				row.put("dtVigenciaInicial", configuracaoAuditoria.getDtVigenciaInicial());
				row.put("dtVigenciaFinal", configuracaoAuditoria.getDtVigenciaFinal());
				row.put("tpOperacao.description", configuracaoAuditoria.getTpOperacao().getDescription());
				row.put("hrConfiguracaoInicial", configuracaoAuditoria.getHrConfiguracaoInicial());
				row.put("hrConfiguracaoFinal", configuracaoAuditoria.getHrConfiguracaoFinal());
				row.put("qtVeiculosProprios", configuracaoAuditoria.getQtVeiculosProprios());
				row.put("qtVeiculosTerceiros", configuracaoAuditoria.getQtVeiculosTerceiros());
				
				row.put("filial.sgFilial", configuracaoAuditoria.getFilial().getSgFilial());
				row.put("filial.pessoa.nmFantasia", configuracaoAuditoria.getFilial().getPessoa().getNmFantasia());
				
				return row;
			};
		};
		
		return (ResultSetPage)filterResultSetPage.doFilter();
	}
	
	public List findLookupFilial(Map tfm) {
		return getFilialService().findLookupFilial(tfm);
	}
	
	public void setConfiguracaoAuditoriaService(ConfiguracaoAuditoriaService configuracaoAuditoriaService) {
		this.defaultService = configuracaoAuditoriaService;
	}
	
	public ConfiguracaoAuditoriaService getConfiguracaoAuditoriaService() {
		return (ConfiguracaoAuditoriaService)this.defaultService;
	}
	
    public void removeById(java.lang.Long id) {        
    	getConfiguracaoAuditoriaService().removeById(id);
    }

	/**
	 *
	 */
	@ParametrizedAttribute(type = java.lang.Long.class)
    public void removeByIds(List ids) {    	
    	getConfiguracaoAuditoriaService().removeByIds(ids);
    }

    public ConfiguracaoAuditoria findById(java.lang.Long id) {
    	ConfiguracaoAuditoria ca = ((ConfiguracaoAuditoriaService)defaultService).findById(id);
		
    	// dividindo minutos em horas
    	Integer hrTempoAuditoria = Integer.valueOf(
				new BigDecimal(ca.getHrTempoAuditoria().doubleValue()).divide(
						new BigDecimal(60), BigDecimal.ROUND_HALF_EVEN).intValue());
    	
		ca.setHrTempoAuditoria(hrTempoAuditoria);
    	return ca;
    }
    
    public TypedFlatMap findByIdMap(java.lang.Long id) {
    	ConfiguracaoAuditoria ca = ((ConfiguracaoAuditoriaService)defaultService).findById(id);
    	
    	
    	// dividindo minutos em horas
    	Integer hrTempoAuditoria = Integer.valueOf(
				new BigDecimal(ca.getHrTempoAuditoria().doubleValue()).divide(
						new BigDecimal(60), BigDecimal.ROUND_HALF_EVEN).intValue());
    	
		ca.setHrTempoAuditoria(hrTempoAuditoria);
		
		Integer acaoVigencia = JTVigenciaUtils.getIntegerAcaoVigencia(ca);
        TypedFlatMap mapConfiguracaoAuditoria = new TypedFlatMap();
        
        mapConfiguracaoAuditoria.put("acaoVigenciaAtual", acaoVigencia);
        
        mapConfiguracaoAuditoria.put("filial.idFilial", ca.getFilial().getIdFilial());
        mapConfiguracaoAuditoria.put("filial.sgFilial", ca.getFilial().getSgFilial());
        mapConfiguracaoAuditoria.put("filial.pessoa.nmFantasia", ca.getFilial().getPessoa().getNmFantasia());
        mapConfiguracaoAuditoria.put("tpOperacao", ca.getTpOperacao().getValue());
        
        mapConfiguracaoAuditoria.put("hrConfiguracaoInicial", ca.getHrConfiguracaoInicial());
        mapConfiguracaoAuditoria.put("hrConfiguracaoFinal", ca.getHrConfiguracaoFinal());
        mapConfiguracaoAuditoria.put("qtVeiculosProprios", ca.getQtVeiculosProprios());
        
        mapConfiguracaoAuditoria.put("qtVeiculosTerceiros", ca.getQtVeiculosTerceiros());
        
        
        mapConfiguracaoAuditoria.put("nrPrazoAuditoria", ca.getNrPrazoAuditoria());
        mapConfiguracaoAuditoria.put("hrTempoAuditoria", ca.getHrTempoAuditoria());
        mapConfiguracaoAuditoria.put("dtVigenciaInicial", ca.getDtVigenciaInicial());
        mapConfiguracaoAuditoria.put("dtVigenciaFinal", ca.getDtVigenciaFinal());
        mapConfiguracaoAuditoria.put("idConfiguracaoAuditoria",ca.getIdConfiguracaoAuditoria());

        return mapConfiguracaoAuditoria;
    }
    
	public FilialService getFilialService() {
		return filialService;
	}

	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
}
