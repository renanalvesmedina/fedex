package com.mercurio.lms.portaria.action;

import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.util.FilterList;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.contratacaoveiculos.model.ModeloMeioTransporte;
import com.mercurio.lms.contratacaoveiculos.model.service.MarcaMeioTransporteService;
import com.mercurio.lms.contratacaoveiculos.model.service.ModeloMeioTransporteService;
import com.mercurio.lms.contratacaoveiculos.model.service.TipoMeioTransporteService;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.portaria.model.ControleEntSaidaTerceiro;
import com.mercurio.lms.portaria.model.MeioTransporteTerceiro;
import com.mercurio.lms.portaria.model.MotoristaTerceiro;
import com.mercurio.lms.portaria.model.Portaria;
import com.mercurio.lms.portaria.model.service.ControleEntSaidaTerceiroService;
import com.mercurio.lms.portaria.model.service.InformarChegadaService;
import com.mercurio.lms.portaria.model.service.MeioTransporteTerceiroService;
import com.mercurio.lms.portaria.model.service.MotoristaTerceiroService;
import com.mercurio.lms.portaria.model.service.PortariaService;
import com.mercurio.lms.util.JTDateTimeUtils;
import com.mercurio.lms.util.PessoaUtils;
import com.mercurio.lms.util.ValidateUtils;
import com.mercurio.lms.util.session.SessionUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.portaria.selecionarMeiosTransporteChegadaAction"
 */

public class SelecionarMeiosTransporteChegadaAction extends CrudAction {

	private PortariaService portariaService;
	private TipoMeioTransporteService tipoMeioTransporteService;
	private MarcaMeioTransporteService marcaMeioTransporteService;
	private ModeloMeioTransporteService modeloMeioTransporteService;
	private InformarChegadaService informarChegadaService;
	private MeioTransporteTerceiroService meioTransporteTerceiroService;
	private MotoristaTerceiroService motoristaTerceiroService;
	private ControleEntSaidaTerceiroService controleEntSaidaTerceiroService;
	private FilialService filialService;
	
	public List findGridColetaEntrega(TypedFlatMap parametros){
		Long idFilial = parametros.getLong("idFilial");
		List result = getInformarChegadaService().findControleCargaChegada(idFilial);
		List result2 = getInformarChegadaService().findOrdemSaidaChegada(idFilial);
		
		result.addAll(result2);
		
		return result;
	}
	
	public List findLookupFilial(Map map) {
    	FilterList filter = new FilterList(filialService.findLookup(map)) {
			public Map filterItem(Object item) {
				Filial filial = (Filial)item;
    			TypedFlatMap typedFlatMap = new TypedFlatMap();
	    		typedFlatMap.put("idFilial", filial.getIdFilial());
		    	typedFlatMap.put("sgFilial",  filial.getSgFilial());
		    	typedFlatMap.put("pessoa.nmFantasia",  filial.getPessoa().getNmFantasia());
				return typedFlatMap;
			}
    	};
    	return (List)filter.doFilter();
    }
	
	public TypedFlatMap findFilialSessao(){
		
		TypedFlatMap retorno  = new TypedFlatMap();
		Filial filial = SessionUtils.getFilialSessao();
		
		retorno.put("idFilial", filial.getIdFilial());
		retorno.put("sgFilial", filial.getSgFilial());
		retorno.put("pessoa.nmFantasia", filial.getPessoa().getNmFantasia());
		
		return retorno;
	}
	
	public List findGridViagemChegada(TypedFlatMap parametros){
		Long idFilial = parametros.getLong("idFilial");
		return getInformarChegadaService().findGridViagemChegada(idFilial);
	}
	
	public List findMeioTransporteTerceiro(Map parametros){
		return getMeioTransporteTerceiroService().findLookup(parametros);		
	}
	
	public List findUltimoMotorista(TypedFlatMap parametros){
		return getControleEntSaidaTerceiroService().findMotoristaUltimaEntradaMeioTransporte(parametros.getLong("idMeioTransporte"));
	}
	 
	public List findFilial(TypedFlatMap tfm){
		return filialService.findComboByUsuarioLogado();
	}
	
	public List findPortaria(TypedFlatMap parametros){
		return getPortariaService().findByFilial(parametros.getLong("idFilial"));
	}
	
	public List findTipoMeioTransporte(TypedFlatMap parametros){
		parametros.put("tpMeioTransporte", "R");
		return getTipoMeioTransporteService().find(parametros);
	}
	
	public List findMarcaMeioTransporte(TypedFlatMap parametros){
		parametros.put("tpMeioTransporte", "R");
		return getMarcaMeioTransporteService().find(parametros);
	}
	
	public List findModeloMeioTransporte(TypedFlatMap parametros){
		return getModeloMeioTransporteService().find(parametros);
	}
		
	public List findMotoristaTerceiro(TypedFlatMap parameters){
		if (StringUtils.isNotBlank(parameters.getString("nrRg"))) {
			PessoaUtils.validateIdentificacao(parameters.getString("nrRg"));
		}
		if (StringUtils.isNotBlank(parameters.getString("nrCpf"))) {
			if (ValidateUtils.validateCpfOrCnpj(parameters.getString("nrCpf"))) {
				PessoaUtils.validateIdentificacao(parameters.getString("nrCpf"));
			}
		}
		return getMotoristaTerceiroService().find(parameters);		
	}
	
	public boolean validaOperacaoFedex(TypedFlatMap parametros) {
		return getInformarChegadaService().validaOperacaoFedex(parametros);
	}
	
	public boolean validaTransito(TypedFlatMap parametros) {
		return getInformarChegadaService().validaTransito(parametros);
	}
	
	public boolean validarBloqueio(TypedFlatMap parametros) {
		return getInformarChegadaService().validarBloqueio(parametros);
	}
	
	public boolean validateTempoEspera(TypedFlatMap parametros){
		return (Boolean)getInformarChegadaService().validateTempoEsperaConhecimento(parametros).get("validado");
	}
	
	public List findGridChegadaSaida(TypedFlatMap parametros){
		return getInformarChegadaService().findGridChegadaSaida(parametros.getLong("idMeioTransporte"));
	}
	
	public void storeMtAvulso(TypedFlatMap parametros){
		
		if (!"".equals(parametros.get("meioTransporteTerceiro.idMeioTransporteTerceiro")) &&
			 controleEntSaidaTerceiroService.validateSaidaMeioTransporte(parametros.getLong("meioTransporteTerceiro.idMeioTransporteTerceiro"))){
			throw new BusinessException("LMS-06026");
		}
		
		Long idMeioTransporteTerceiro = storeMeioTransporteTerceiro(parametros);
		Long idMotoristaTerceiro = storeMotoristaTerceiro(parametros);
		storeControleEntSaidaTerceiro(idMeioTransporteTerceiro, idMotoristaTerceiro, parametros);
	}
	
	private void storeControleEntSaidaTerceiro(Long idMeioTransporteTerceiro, Long idMotoristaTerceiro, TypedFlatMap parametros) {
		ControleEntSaidaTerceiro controleEntSaidaTerceiro = new ControleEntSaidaTerceiro();
		controleEntSaidaTerceiro.setDhEntrada(JTDateTimeUtils.getDataHoraAtual());
				
		MeioTransporteTerceiro meioTransporteTerceiro = new MeioTransporteTerceiro();
		meioTransporteTerceiro.setIdMeioTransporteTerceiro(idMeioTransporteTerceiro);
		
		controleEntSaidaTerceiro.setMeioTransporteTerceiro(meioTransporteTerceiro);
		
		MotoristaTerceiro motoristaTerceiro = new MotoristaTerceiro();
		motoristaTerceiro.setIdMotoristaTerceiro(idMotoristaTerceiro);
		controleEntSaidaTerceiro.setMotoristaTerceiro(motoristaTerceiro);
		
		Portaria portaria = new Portaria();
		portaria.setIdPortaria(parametros.getLong("portaria.idPortaria"));
		controleEntSaidaTerceiro.setPortaria(portaria);
		
		controleEntSaidaTerceiro.setNrIdentificacaoSemiReboque(parametros.getString("nrIdentificacaoSemiReboque"));
		
		getControleEntSaidaTerceiroService().store(controleEntSaidaTerceiro);
	}

	private Long storeMotoristaTerceiro(TypedFlatMap parametros) {
		
		Long idMotoristaTerceiro = parametros.getLong("motoristaTerceiro.idMotoristaTerceiro");

		MotoristaTerceiro motoristaTerceiro = new MotoristaTerceiro();
		
		motoristaTerceiro.setIdMotoristaTerceiro(idMotoristaTerceiro);
		motoristaTerceiro.setNmMotorista(parametros.getString("motoristaTerceiro.nmMotorista"));
		motoristaTerceiro.setNrCnh(parametros.getLong("motoristaTerceiro.nrCnh"));
		motoristaTerceiro.setNrCpf(parametros.getLong("motoristaTerceiro.nrCpf"));
		motoristaTerceiro.setNrRg(parametros.getString("motoristaTerceiro.nrRg"));
		
		return (Long) getMotoristaTerceiroService().store(motoristaTerceiro);
		
	}

	private Long storeMeioTransporteTerceiro(TypedFlatMap parametros) {
		
		Long idMeioTransporteTerceiro = parametros.getLong("meioTransporteTerceiro.idMeioTransporteTerceiro");
		
		if (idMeioTransporteTerceiro == null) {
			MeioTransporteTerceiro meioTransporteTerceiro = new MeioTransporteTerceiro();
						
			meioTransporteTerceiro.setNmTransportadora(parametros.getString("meioTransporteTerceiro.nmTransportadora"));
			meioTransporteTerceiro.setNrAno(parametros.getShort("meioTransporteTerceiro.nrAno"));
			meioTransporteTerceiro.setNrIdentificao(parametros.getString("meioTransporteTerceiro.nrIdentificao"));
			
			ModeloMeioTransporte modeloMeioTransporte = new ModeloMeioTransporte();
			modeloMeioTransporte.setIdModeloMeioTransporte(parametros.getLong("meioTransporteTerceiro.modeloMeioTransporte.idModeloMeioTransporte"));
			meioTransporteTerceiro.setModeloMeioTransporte(modeloMeioTransporte);
			
			return (Long) getMeioTransporteTerceiroService().store(meioTransporteTerceiro);
		} 
		
		return idMeioTransporteTerceiro;
	}

	/**
	 * @return Returns the portariaService.
	 */
	public PortariaService getPortariaService() {
		return portariaService;
	}

	/**
	 * @param portariaService The portariaService to set.
	 */
	public void setPortariaService(PortariaService portariaService) {
		this.portariaService = portariaService;
	}


	/**
	 * @return Returns the tipoMeioTransporteService.
	 */
	public TipoMeioTransporteService getTipoMeioTransporteService() {
		return tipoMeioTransporteService;
	}


	/**
	 * @param tipoMeioTransporteService The tipoMeioTransporteService to set.
	 */
	public void setTipoMeioTransporteService(
			TipoMeioTransporteService tipoMeioTransporteService) {
		this.tipoMeioTransporteService = tipoMeioTransporteService;
	}


	/**
	 * @return Returns the marcaMeioTransporteService.
	 */
	public MarcaMeioTransporteService getMarcaMeioTransporteService() {
		return marcaMeioTransporteService;
	}


	/**
	 * @param marcaMeioTransporteService The marcaMeioTransporteService to set.
	 */
	public void setMarcaMeioTransporteService(
			MarcaMeioTransporteService marcaMeioTransporteService) {
		this.marcaMeioTransporteService = marcaMeioTransporteService;
	}


	/**
	 * @return Returns the modeloMeioTransporteService.
	 */
	public ModeloMeioTransporteService getModeloMeioTransporteService() {
		return modeloMeioTransporteService;
	}


	/**
	 * @param modeloMeioTransporteService The modeloMeioTransporteService to set.
	 */
	public void setModeloMeioTransporteService(
			ModeloMeioTransporteService modeloMeioTransporteService) {
		this.modeloMeioTransporteService = modeloMeioTransporteService;
	}


	/**
	 * @return Returns the informarChegadaService.
	 */
	public InformarChegadaService getInformarChegadaService() {
		return informarChegadaService;
	}


	/**
	 * @param informarChegadaService The informarChegadaService to set.
	 */
	public void setInformarChegadaService(
			InformarChegadaService informarChegadaService) {
		this.informarChegadaService = informarChegadaService;
	}

	/**
	 * @return Returns the meioTransporteTerceiroService.
	 */
	public MeioTransporteTerceiroService getMeioTransporteTerceiroService() {
		return meioTransporteTerceiroService;
	}

	/**
	 * @param meioTransporteTerceiroService The meioTransporteTerceiroService to set.
	 */
	public void setMeioTransporteTerceiroService(
			MeioTransporteTerceiroService meioTransporteTerceiroService) {
		this.meioTransporteTerceiroService = meioTransporteTerceiroService;
	}

	/**
	 * @return Returns the motoristaTerceiroService.
	 */
	public MotoristaTerceiroService getMotoristaTerceiroService() {
		return motoristaTerceiroService;
	}

	/**
	 * @param motoristaTerceiroService The motoristaTerceiroService to set.
	 */
	public void setMotoristaTerceiroService(
			MotoristaTerceiroService motoristaTerceiroService) {
		this.motoristaTerceiroService = motoristaTerceiroService;
	}

	/**
	 * @return Returns the controleEntSaidaTerceiroService.
	 */
	public ControleEntSaidaTerceiroService getControleEntSaidaTerceiroService() {
		return controleEntSaidaTerceiroService;
	}

	/**
	 * @param controleEntSaidaTerceiroService The controleEntSaidaTerceiroService to set.
	 */
	public void setControleEntSaidaTerceiroService(
			ControleEntSaidaTerceiroService controleEntSaidaTerceiroService) {
		this.controleEntSaidaTerceiroService = controleEntSaidaTerceiroService;
	}

	public FilialService getFilialService() {
		return filialService;
	}

	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	


}
