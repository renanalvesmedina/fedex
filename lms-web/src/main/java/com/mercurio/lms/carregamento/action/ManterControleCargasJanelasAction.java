package com.mercurio.lms.carregamento.action;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;
import com.mercurio.adsm.framework.model.DomainValue;
import com.mercurio.adsm.framework.model.FindDefinition;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.model.service.DomainValueService;
import com.mercurio.adsm.framework.util.FilterList;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.carregamento.model.CargoOperacional;
import com.mercurio.lms.carregamento.model.ControleCarga;
import com.mercurio.lms.carregamento.model.ControleTrecho;
import com.mercurio.lms.carregamento.model.EquipeOperacao;
import com.mercurio.lms.carregamento.model.IntegranteEqOperac;
import com.mercurio.lms.carregamento.model.LacreControleCarga;
import com.mercurio.lms.carregamento.model.LocalTroca;
import com.mercurio.lms.carregamento.model.Manifesto;
import com.mercurio.lms.carregamento.model.PagtoProprietarioCc;
import com.mercurio.lms.carregamento.model.service.CargoOperacionalService;
import com.mercurio.lms.carregamento.model.service.ControleCargaService;
import com.mercurio.lms.carregamento.model.service.ControleTrechoService;
import com.mercurio.lms.carregamento.model.service.EquipeOperacaoService;
import com.mercurio.lms.carregamento.model.service.EquipeService;
import com.mercurio.lms.carregamento.model.service.IntegranteEqOperacService;
import com.mercurio.lms.carregamento.model.service.LacreControleCargaService;
import com.mercurio.lms.carregamento.model.service.LocalTrocaService;
import com.mercurio.lms.carregamento.model.service.ManifestoService;
import com.mercurio.lms.carregamento.model.service.MotoristaControleCargaService;
import com.mercurio.lms.carregamento.model.service.PagtoPedagioCcService;
import com.mercurio.lms.carregamento.model.service.PagtoProprietarioCcService;
import com.mercurio.lms.carregamento.model.service.SemiReboqueCcService;
import com.mercurio.lms.carregamento.model.service.VeiculoControleCargaService;
import com.mercurio.lms.configuracoes.model.Moeda;
import com.mercurio.lms.configuracoes.model.service.MoedaService;
import com.mercurio.lms.configuracoes.model.service.PessoaService;
import com.mercurio.lms.configuracoes.model.service.UsuarioService;
import com.mercurio.lms.contratacaoveiculos.model.MeioTransporte;
import com.mercurio.lms.contratacaoveiculos.model.SolicitacaoContratacao;
import com.mercurio.lms.contratacaoveiculos.model.service.MeioTranspProprietarioService;
import com.mercurio.lms.contratacaoveiculos.model.service.MeioTransporteService;
import com.mercurio.lms.contratacaoveiculos.model.service.MotoristaService;
import com.mercurio.lms.contratacaoveiculos.model.service.SolicitacaoContratacaoService;
import com.mercurio.lms.expedicao.model.service.ConhecimentoService;
import com.mercurio.lms.expedicao.model.service.CtoInternacionalService;
import com.mercurio.lms.expedicao.model.service.DoctoServicoService;
import com.mercurio.lms.fretecarreteirocoletaentrega.model.service.TipoTabelaColetaEntregaService;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.service.EmpresaService;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.municipios.model.service.MeioTransporteRotaViagemService;
import com.mercurio.lms.municipios.model.service.MunicipioService;
import com.mercurio.lms.municipios.model.service.PontoParadaService;
import com.mercurio.lms.municipios.model.service.RodoviaService;
import com.mercurio.lms.pendencia.model.service.MdaService;
import com.mercurio.lms.util.FormatUtils;
import com.mercurio.lms.util.JTDateTimeUtils;
import com.mercurio.lms.util.session.SessionUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.carregamento.manterControleCargasJanelasAction"
 */

public class ManterControleCargasJanelasAction {
	
	private ConhecimentoService conhecimentoService;
	private CtoInternacionalService ctoInternacionalService;
	private MdaService mdaService;

	private CargoOperacionalService cargoOperacionalService;
	private ControleCargaService controleCargaService;
	private ControleTrechoService controleTrechoService;
	private DoctoServicoService doctoServicoService;
	private DomainValueService domainValueService;
	private EmpresaService empresaService;
	private EquipeOperacaoService equipeOperacaoService;
	private EquipeService equipeService;
	private FilialService filialService;
	private IntegranteEqOperacService integranteEqOperacService;
	private LacreControleCargaService lacreControleCargaService;
	private LocalTrocaService localTrocaService;
	private ManifestoService manifestoService;
	private MeioTransporteRotaViagemService meioTransporteRotaViagemService;
	private MeioTransporteService meioTransporteService;
	private MeioTranspProprietarioService meioTranspProprietarioService;
	private MoedaService moedaService;
	private MotoristaControleCargaService motoristaControleCargaService;
	private MotoristaService motoristaService;
	private MunicipioService municipioService;
	private PagtoPedagioCcService pagtoPedagioCcService;
	private PagtoProprietarioCcService pagtoProprietarioCcService;
	private PessoaService pessoaService;
	private PontoParadaService pontoParadaService;
	private RodoviaService rodoviaService;
	private SemiReboqueCcService semiReboqueCcService;
	private SolicitacaoContratacaoService solicitacaoContratacaoService;
	private TipoTabelaColetaEntregaService tipoTabelaColetaEntregaService;
	private UsuarioService usuarioService;
	private VeiculoControleCargaService veiculoControleCargaService;


	public void setPagtoPedagioCcService(PagtoPedagioCcService pagtoPedagioCcService) {
		this.pagtoPedagioCcService = pagtoPedagioCcService;
	}
	public void setTipoTabelaColetaEntregaService(TipoTabelaColetaEntregaService tipoTabelaColetaEntregaService) {
		this.tipoTabelaColetaEntregaService = tipoTabelaColetaEntregaService;
	}
	public void setMeioTransporteRotaViagemService(MeioTransporteRotaViagemService meioTransporteRotaViagemService) {
		this.meioTransporteRotaViagemService = meioTransporteRotaViagemService;
	}
	public void setConhecimentoService(ConhecimentoService conhecimentoService) {
		this.conhecimentoService = conhecimentoService;
	}
	public void setCtoInternacionalService(CtoInternacionalService ctoInternacionalService) {
		this.ctoInternacionalService = ctoInternacionalService;
	}
	public void setMdaService(MdaService mdaService) {
		this.mdaService = mdaService;
	}
	public void setDoctoServicoService(DoctoServicoService doctoServicoService) {
		this.doctoServicoService = doctoServicoService;
	}
	public void setManifestoService(ManifestoService manifestoService) {
		this.manifestoService = manifestoService;
	}
	public void setControleCargaService(ControleCargaService controleCargaService) {
		this.controleCargaService = controleCargaService;
	}
	public void setUsuarioService(UsuarioService usuarioService) {
		this.usuarioService = usuarioService;
	}
	public void setEmpresaService(EmpresaService empresaService) {
		this.empresaService = empresaService;
	}
	public void setCargoOperacionalService(CargoOperacionalService cargoOperacionalService) {
		this.cargoOperacionalService = cargoOperacionalService;
	}
	public void setPessoaService(PessoaService pessoaService) {
		this.pessoaService = pessoaService;
	}
	public void setIntegranteEqOperacService(IntegranteEqOperacService integranteEqOperacService) {
		this.integranteEqOperacService = integranteEqOperacService;
	}
	public void setEquipeOperacaoService(EquipeOperacaoService equipeOperacaoService) {
		this.equipeOperacaoService = equipeOperacaoService;
	}
	public void setEquipeService(EquipeService equipeService) {
		this.equipeService = equipeService;
	}
	public void setDomainValueService(DomainValueService domainValueService) {
		this.domainValueService = domainValueService;
	}
	public void setLacreControleCargaService(LacreControleCargaService lacreControleCargaService) {
		this.lacreControleCargaService = lacreControleCargaService;
	}
	public void setMoedaService(MoedaService moedaService) {
		this.moedaService = moedaService;
	}
	public void setPagtoProprietarioCcService(PagtoProprietarioCcService pagtoProprietarioCcService) {
		this.pagtoProprietarioCcService = pagtoProprietarioCcService;
	}
	public void setMotoristaService(MotoristaService motoristaService) {
		this.motoristaService = motoristaService;
	}
	public void setMeioTranspProprietarioService(MeioTranspProprietarioService meioTranspProprietarioService) {
		this.meioTranspProprietarioService = meioTranspProprietarioService;
	}
	public void setControleTrechoService(ControleTrechoService controleTrechoService) {
		this.controleTrechoService = controleTrechoService;
	}
	public void setPontoParadaService(PontoParadaService pontoParadaService) {
		this.pontoParadaService = pontoParadaService;
	}
	public void setMunicipioService(MunicipioService municipioService) {
		this.municipioService = municipioService;
	}
	public void setRodoviaService(RodoviaService rodoviaService) {
		this.rodoviaService = rodoviaService;
	}
	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	public void setSolicitacaoContratacaoService(SolicitacaoContratacaoService solicitacaoContratacaoService) {
		this.solicitacaoContratacaoService = solicitacaoContratacaoService;
	}
	public void setMeioTransporteService(MeioTransporteService meioTransporteService) {
		this.meioTransporteService = meioTransporteService;
	}
	public void setLocalTrocaService(LocalTrocaService localTrocaService) {
		this.localTrocaService = localTrocaService;
	}
	public void setMotoristaControleCargaService(MotoristaControleCargaService motoristaControleCargaService) {
		this.motoristaControleCargaService = motoristaControleCargaService;
	}
	public void setSemiReboqueCcService(SemiReboqueCcService semiReboqueCcService) {
		this.semiReboqueCcService = semiReboqueCcService;
	}
	public void setVeiculoControleCargaService(VeiculoControleCargaService veiculoControleCargaService) {
		this.veiculoControleCargaService = veiculoControleCargaService;
	}


	/**
     * 
     * @param criteria
     * @return
     */
    public ResultSetPage findPaginatedVeiculo(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
    	ResultSetPage rsp = veiculoControleCargaService.findPaginatedByIdControleCarga(idControleCarga, FindDefinition.createFindDefinition(criteria));
    	for (Iterator iter = rsp.getList().iterator(); iter.hasNext(); ){
    		TypedFlatMap map = (TypedFlatMap)iter.next();
    		String sgFilialOrigem = map.getString("sgFilialOrigem");
    		String sgFilialDestino = map.getString("sgFilialDestino");
    		if (sgFilialOrigem != null && !sgFilialOrigem.equals("") && sgFilialDestino != null && !sgFilialDestino.equals("")) {
    			map.put("trecho", sgFilialOrigem + " - " + sgFilialDestino);
    			map.remove("sgFilialOrigem");
    			map.remove("sgFilialDestino");
    		}
    	}
    	return rsp;
    }

    /**
     * 
     * @param criteria
     * @return
     */
    public Integer getRowCountVeiculo(TypedFlatMap criteria) {
    	return veiculoControleCargaService.getRowCountFindPaginatedByIdControleCarga(criteria.getLong("controleCarga.idControleCarga"));
    }


    
	/**
     * 
     * @param criteria
     * @return
     */
    public ResultSetPage findPaginatedSemiReboque(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
    	ResultSetPage rsp = semiReboqueCcService.findPaginatedByIdControleCarga(idControleCarga, FindDefinition.createFindDefinition(criteria));
    	for (Iterator iter = rsp.getList().iterator(); iter.hasNext(); ){
    		TypedFlatMap map = (TypedFlatMap)iter.next();
    		String sgFilialOrigem = map.getString("sgFilialOrigem");
    		String sgFilialDestino = map.getString("sgFilialDestino");
    		if (sgFilialOrigem != null && !sgFilialOrigem.equals("") && sgFilialDestino != null && !sgFilialDestino.equals("")) {
    			map.put("trecho", sgFilialOrigem + " - " + sgFilialDestino);
    			map.remove("sgFilialOrigem");
    			map.remove("sgFilialDestino");
    		}
    	}
    	return rsp;
    }

    /**
     * 
     * @param criteria
     * @return
     */
    public Integer getRowCountSemiReboque(TypedFlatMap criteria) {
    	return semiReboqueCcService.getRowCountFindPaginatedByIdControleCarga(criteria.getLong("controleCarga.idControleCarga"));
    }

    
    
	/**
     * 
     * @param criteria
     * @return
     */
    public ResultSetPage findPaginatedMotorista(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
    	ResultSetPage rsp = motoristaControleCargaService.findPaginatedByIdControleCarga(idControleCarga, FindDefinition.createFindDefinition(criteria));
    	for (Iterator iter = rsp.getList().iterator(); iter.hasNext(); ){
    		TypedFlatMap map = (TypedFlatMap)iter.next();
    		String sgFilialOrigem = map.getString("sgFilialOrigem");
    		String sgFilialDestino = map.getString("sgFilialDestino");
    		if (sgFilialOrigem != null && !sgFilialOrigem.equals("") && sgFilialDestino != null && !sgFilialDestino.equals("")) {
    			map.put("trecho", sgFilialOrigem + " - " + sgFilialDestino);
    			map.remove("sgFilialOrigem");
    			map.remove("sgFilialDestino");
    		}
    		map.put("nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(map.getString("tpIdentificacao.value"), map.getString("nrIdentificacao")) );
    		map.remove("nrIdentificacao");
    	}
    	return rsp;
    }

    /**
     * 
     * @param criteria
     * @return
     */
    public Integer getRowCountMotorista(TypedFlatMap criteria) {
    	return motoristaControleCargaService.getRowCountFindPaginatedByIdControleCarga(criteria.getLong("controleCarga.idControleCarga"));
    }


    public String findDescricaoLocalTroca(Long idLocalTroca) {
    	LocalTroca localTroca = localTrocaService.findById(idLocalTroca);
    	return localTroca.getDsTroca();
    }


    public List findLookupMeioTransporteSemiRebocado(Map criteria) {
    	criteria.put("tipoMeioTransporte", "semiRebocado");
    	return findLookupMeioTransporte(criteria);
    }


    public List findLookupMeioTransporteTransportado(Map criteria) {
    	criteria.put("tipoMeioTransporte", "transportado");
    	return findLookupMeioTransporte(criteria);
    }
    

    private List findLookupMeioTransporte(Map criteria) {
    	List list = meioTransporteService.findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		MeioTransporte meioTransporte = (MeioTransporte)iter.next();
    		TypedFlatMap tfm = new TypedFlatMap();
    		tfm.put("idMeioTransporte", meioTransporte.getIdMeioTransporte());
    		tfm.put("nrIdentificador", meioTransporte.getNrIdentificador());
    		tfm.put("nrFrota", meioTransporte.getNrFrota());
    		tfm.put("tpVinculo", meioTransporte.getTpVinculo().getValue());
    		tfm.put("modeloMeioTransporte.tipoMeioTransporte.idTipoMeioTransporte", 
    				meioTransporte.getModeloMeioTransporte().getTipoMeioTransporte().getIdTipoMeioTransporte());
    		retorno.add(tfm);
    	}
    	return retorno;
    }


    public List findLookupFilial(Map criteria) {
    	List list = filialService.findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		Filial filial = (Filial)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idFilial", filial.getIdFilial());
    		typedFlatMap.put("sgFilial", filial.getSgFilial());
    		typedFlatMap.put("pessoa.nmFantasia", filial.getPessoa().getNmFantasia());
    		retorno.add(typedFlatMap);
    	}
    	return retorno;
    }

    
	public List findLookupSolicitacaoContratacao(Map criteria) {
		Map mapMeioTransp = (Map)criteria.get("nrIdentificacaoMeioTransp");
		if (mapMeioTransp != null) {
			criteria.put("nrIdentificacaoMeioTransp", mapMeioTransp.get("nrPlaca"));
		}
		List list = solicitacaoContratacaoService.findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		SolicitacaoContratacao solicitacaoContratacao = (SolicitacaoContratacao)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idSolicitacaoContratacao", solicitacaoContratacao.getIdSolicitacaoContratacao());
    		typedFlatMap.put("nrSolicitacaoContratacao", solicitacaoContratacao.getNrSolicitacaoContratacao());
    		typedFlatMap.put("filial.idFilial", solicitacaoContratacao.getFilial().getIdFilial());
    		typedFlatMap.put("filial.sgFilial", solicitacaoContratacao.getFilial().getSgFilial());
    		typedFlatMap.put("filial.pessoa.nmFantasia", solicitacaoContratacao.getFilial().getPessoa().getNmFantasia());
    		retorno.add(typedFlatMap);
    	}
    	return retorno;
    }

	
	public List findLookupMunicipio(Map criteria){
		return municipioService.findLookup(criteria);
	}

	public List findLookupRodovia(Map criteria) {
		return rodoviaService.findLookup(criteria);
	}

    public List findLookupMotorista(Map criteria) {
    	return motoristaService.findLookup(criteria);
    }
	
	public List findControleTrecho(TypedFlatMap criteria) {
		List lista = controleTrechoService.findControleTrechoByControleCarga(criteria.getLong("idControleCarga"), null, null, null);
		List retorno = new ArrayList();
		for (Iterator iter = lista.iterator(); iter.hasNext();) {
			ControleTrecho controleTrecho = (ControleTrecho)iter.next();
			TypedFlatMap map = new TypedFlatMap();
			map.put("idControleTrecho", controleTrecho.getIdControleTrecho());
			map.put("trecho", 	controleTrecho.getFilialByIdFilialOrigem().getSgFilial() + " - " + 
								controleTrecho.getFilialByIdFilialDestino().getSgFilial());
			retorno.add(map);
		}
		return retorno;
	}

	
	public List findPontoParada(Long idRotaIdaVolta) {
		return pontoParadaService.findPontoParadaByRotaIdaVolta(idRotaIdaVolta);
	}
	
	
	public TypedFlatMap getDataLocalTroca(TypedFlatMap criteria) {
		TypedFlatMap map = new TypedFlatMap();
		map.put("dhAtual", JTDateTimeUtils.getDataHoraAtual());
		return map;
	}


    public TypedFlatMap findDadosVeiculo(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("idControleCarga");
    	Long idMeioTransporte = criteria.getLong("idMeioTransporte");
    	Long idTipoMeioTransporteTransportado = criteria.getLong("idTipoMeioTransporteTransportado");
    	String tpVinculo = criteria.getString("tpVinculo");
    	Long idProprietarioNovoVeiculo = null;

    	// valida o veículo
    	controleCargaService.validateVeiculoControleCarga(idMeioTransporte, false);

    	TypedFlatMap tfm = new TypedFlatMap();
    	Map mapResultado = meioTranspProprietarioService.findProprietarioByMeioTransporte(idMeioTransporte);
    	if (mapResultado != null) {
	    	Map mapProprietario = (Map)mapResultado.get("proprietario");
	    	if (mapProprietario != null) {
	    		Map mapPessoa = (Map)mapProprietario.get("pessoa");
	    		tfm.put("proprietario.idProprietario", mapProprietario.get("idProprietario"));
	    		tfm.put("proprietario.pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(
		    			(String)((Map)mapPessoa.get("tpIdentificacao")).get("value"), (String)mapPessoa.get("nrIdentificacao"))); 
		    	tfm.put("proprietario.pessoa.nmPessoa", mapPessoa.get("nmPessoa"));
		    	idProprietarioNovoVeiculo = (Long)mapProprietario.get("idProprietario");
		    }
    	}
   		ControleCarga cc = controleCargaService.findByIdControleCarga(idControleCarga);
   		String tpControleCarga = cc.getTpControleCarga().getValue();

    	TypedFlatMap mapVeiculoAtual = veiculoControleCargaService.findVeiculoAtualByIdControleCarga(idControleCarga);
   		tfm.put("idVeiculoControleCarga", mapVeiculoAtual.getLong("idVeiculoControleCarga"));
   		
    	boolean blDesabilitaSolicitContratacao = true;
    	if (tpControleCarga.equals("V")) { 
	    	if (tpVinculo.equals("E")) {
	    		blDesabilitaSolicitContratacao = false;
	    	}
	    	else
	        if (tpVinculo.equals("A") || tpVinculo.equals("P")) {
	        	if (cc.getTpRotaViagem().getValue().equals("EV"))
	        	{
	        		if (mapVeiculoAtual.getString("tpVinculo.value").equals("E"))
	        			blDesabilitaSolicitContratacao = false;
	        		else
	    			if (mapVeiculoAtual.getLong("idProprietario").compareTo(idProprietarioNovoVeiculo) != 0)
	    				blDesabilitaSolicitContratacao = false;
	        	}
	        	else
	        	if (cc.getTpRotaViagem().getValue().equals("EX") || cc.getTpRotaViagem().getValue().equals("EC"))
	        	{
	        		if (tpVinculo.equals("P") && !idTipoMeioTransporteTransportado.equals( 
	        			cc.getRotaIdaVolta().getRotaViagem().getTipoMeioTransporte().getIdTipoMeioTransporte()))
	        		{
	        			blDesabilitaSolicitContratacao = false;
	        		}
	        		else {
	            		Boolean blExisteVeiculoCadastradoParaRotaViagem = meioTransporteRotaViagemService.
		    				validateMeioTransporteWithRotaViagem(cc.getRotaIdaVolta().getRotaViagem().getIdRotaViagem(), idMeioTransporte);
	        			
	        			if (tpVinculo.equals("A") && !blExisteVeiculoCadastradoParaRotaViagem)
	        				blDesabilitaSolicitContratacao = false;
	        		}
	        	}
	        }
    	}
    	else {
    		tfm.put("tabelas", tipoTabelaColetaEntregaService.findTipoTabelaColetaEntregaWithTabelaColetaEntrega(
    				SessionUtils.getFilialSessao().getIdFilial(), idMeioTransporte, cc.getRotaColetaEntrega().getIdRotaColetaEntrega()));
    	}

    	tfm.put("blDesabilitaSolicitContratacao", Boolean.valueOf(blDesabilitaSolicitContratacao));
    	return tfm;
    }


    /**
     * 
     * @param map
     * @return
     */
    public TypedFlatMap storeTrocarVeiculo(TypedFlatMap map) {
    	
    	Boolean isUsuarioDivop = Boolean.FALSE;
    	if(!controleCargaService.validateManutencaoEspecialCC(SessionUtils.getUsuarioLogado())){
			isUsuarioDivop = Boolean.TRUE;
		}

    	veiculoControleCargaService.storeTrocarVeiculo( map.getInteger("nrKmRodoviaTroca"),
										    			map.getString("dsTroca"),
										    			map.getDateTime("dhTroca"),
										    			map.getLong("municipio.idMunicipio"),
										    			map.getLong("controleTrecho.idControleTrecho"),
										    			map.getLong("pontoParada.idPontoParada"),
										    			map.getLong("rodovia.idRodovia"),
										    			map.getLong("idVeiculoControleCarga"),
										    			map.getLong("idControleCarga"), 
										    			map.getLong("meioTransporte.idMeioTransporte"), 
										    			map.getLong("solicitacaoContratacao.idSolicitacaoContratacao"),
										    			map.getLong("proprietario.idProprietario"),
										    			map.getLong("tabelaColetaEntrega.idTabelaColetaEntrega"),
										    			map.getLong("tipoTabelaColetaEntrega.idTipoTabelaColetaEntrega"),
										    			isUsuarioDivop);

    	TypedFlatMap tfm = new TypedFlatMap();
    	if (pagtoPedagioCcService.validateExisteCartaoPedagioNaoPreenchidoByIdControleCarga(map.getLong("idControleCarga"))) {
    		tfm.put("blNecessitaCartaoPedagio", Boolean.TRUE);
    	}
    	return tfm;
    }


    /**
     * 
     * @param map
     * @return
     */
    public TypedFlatMap storeTrocarSemiReboque(TypedFlatMap map) {
    	semiReboqueCcService.storeTrocarSemiReboque(map.getInteger("nrKmRodoviaTroca"),
										    		map.getString("dsTroca"),
									    			map.getDateTime("dhTroca"),
									    			map.getLong("municipio.idMunicipio"),
									    			map.getLong("controleTrecho.idControleTrecho"),
									    			map.getLong("pontoParada.idPontoParada"),
									    			map.getLong("rodovia.idRodovia"),
									    			map.getLong("idControleCarga"), 
									    			map.getLong("meioTransporte.idMeioTransporte"));

    	TypedFlatMap tfm = new TypedFlatMap();
    	if (pagtoPedagioCcService.validateExisteCartaoPedagioNaoPreenchidoByIdControleCarga(map.getLong("idControleCarga"))) {
    		tfm.put("blNecessitaCartaoPedagio", Boolean.TRUE);
    	}
    	return tfm;
    }


    public void storeTrocarMotorista(TypedFlatMap map) {
    	motoristaControleCargaService.storeTrocarMotorista( map.getInteger("nrKmRodoviaTroca"),
												    		map.getString("dsTroca"),
											    			map.getDateTime("dhTroca"),
											    			map.getLong("municipio.idMunicipio"),
											    			map.getLong("controleTrecho.idControleTrecho"),
											    			map.getLong("pontoParada.idPontoParada"),
											    			map.getLong("rodovia.idRodovia"),
											    			map.getLong("idControleCarga"),
											    			map.getLong("motorista.idMotorista"));
    }


	/**
     * 
     * @param criteria
     * @return
     */
    public ResultSetPage findPaginatedPagtoProprietario(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
    	ResultSetPage rsp = pagtoProprietarioCcService.findPaginatedPagtoProprietarioCc(idControleCarga, FindDefinition.createFindDefinition(criteria));
    	for (Iterator iter = rsp.getList().iterator(); iter.hasNext(); ){
    		TypedFlatMap map = (TypedFlatMap)iter.next();
    		if (map.getString("moeda.sgMoeda") != null && map.getBigDecimal("vlPagamento") != null) {
    			map.put("moeda.siglaSimbolo", map.getString("moeda.sgMoeda") + " " + map.getString("moeda.dsSimbolo"));
    			map.remove("moeda.sgMoeda");
    			map.remove("moeda.dsSimbolo");
    		}
    		map.put("proprietario.pessoa.nrIdentificacaoFormatado", 
    				FormatUtils.formatIdentificacao(map.getString("proprietario.pessoa.tpIdentificacao.value"), 
    						map.getString("proprietario.pessoa.nrIdentificacao")) );
    		map.remove("proprietario.pessoa.nrIdentificacao");
    	}
    	return rsp;
    }

    
    /**
     * 
     * @param criteria
     * @return
     */
    public Integer getRowCountPagtoProprietario(TypedFlatMap criteria) {
    	return pagtoProprietarioCcService.getRowCountPagtoProprietarioCc(criteria.getLong("controleCarga.idControleCarga"));
    }
    
    /**
     * 
     * @param criteria
     * @return
     */
    public List findMoeda(Map criteria) {
    	FilterList filter = new FilterList(moedaService.find(criteria)) {
			public Map filterItem(Object item) {
				Moeda moeda = (Moeda)item;
    			TypedFlatMap typedFlatMap = new TypedFlatMap();
	    		typedFlatMap.put("idMoeda", moeda.getIdMoeda());
	    		typedFlatMap.put("siglaSimbolo", moeda.getSiglaSimbolo());
		    	typedFlatMap.put("sgMoeda", moeda.getSgMoeda());
				return typedFlatMap;
			}
    	};
    	return (List)filter.doFilter();
    }


    public TypedFlatMap findByIdPagtoProprietario(Long idPagtoProprietarioCc) {
    	PagtoProprietarioCc bean = pagtoProprietarioCcService.findByIdByControleCarga(idPagtoProprietarioCc);
    	TypedFlatMap map = new TypedFlatMap();
    	map.put("idPagtoProprietarioCc", bean.getIdPagtoProprietarioCc());
    	if (bean.getControleCarga().getVlFreteCarreteiro() != null) {
	    	map.put("controleCarga.moeda.siglaSimbolo", bean.getControleCarga().getMoeda().getSiglaSimbolo());
	    	map.put("controleCarga.vlFreteCarreteiro", bean.getControleCarga().getVlFreteCarreteiro());
    	}
    	map.put("proprietario.idProprietario", bean.getProprietario().getIdProprietario());
    	map.put("proprietario.pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(bean.getProprietario().getPessoa()));
    	map.put("proprietario.pessoa.nmPessoa", bean.getProprietario().getPessoa().getNmPessoa());
    	if (bean.getVeiculoControleCarga().getSolicitacaoContratacao() != null) {
    		map.put("veiculoControleCarga.solicitacaoContratacao.filial.sgFilial", bean.getVeiculoControleCarga().getSolicitacaoContratacao().getFilial().getSgFilial());
    		map.put("veiculoControleCarga.solicitacaoContratacao.nrSolicitacaoContratacao", bean.getVeiculoControleCarga().getSolicitacaoContratacao().getNrSolicitacaoContratacao());
    	}
    	if (bean.getMoeda() != null) {
    		map.put("moeda.idMoeda", bean.getMoeda().getIdMoeda());
    	}
    	map.put("vlPagamento", bean.getVlPagamento());
    	map.put("tpVinculo", bean.getVeiculoControleCarga().getMeioTransporte().getTpVinculo().getValue());
    	return map;
    }

    
	/**
     * 
     * @param criteria
     * @return
     */
    public ResultSetPage findPaginatedLacre(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
    	ResultSetPage rsp = lacreControleCargaService.findPaginatedByControleCarga(idControleCarga, FindDefinition.createFindDefinition(criteria));
    	return rsp;
    }

    
    /**
     * 
     * @param criteria
     * @return
     */
    public Integer getRowCountLacre(TypedFlatMap criteria) {
    	return lacreControleCargaService.getRowCountByControleCarga(criteria.getLong("controleCarga.idControleCarga"));
    }
    

    public TypedFlatMap findByIdLacre(Long idLacreControleCarga) {
    	LacreControleCarga bean = lacreControleCargaService.findByIdByControleCarga(idLacreControleCarga);
    	TypedFlatMap map = new TypedFlatMap();
    	map.put("idLacreControleCarga", bean.getIdLacreControleCarga());
    	map.put("nrLacre", bean.getNrLacre());
    	map.put("dsLocalInclusao", bean.getDsLocalInclusao());
    	map.put("dsLocalConferencia", bean.getDsLocalConferencia());
    	map.put("obInclusaoLacre", bean.getObInclusaoLacre());
    	map.put("obConferenciaLacre", bean.getObConferenciaLacre());
    	map.put("tpStatusLacre", bean.getTpStatusLacre().getDescription().toString());
    	map.put("filialByIdFilialInclusao.sgFilial", bean.getFilialByIdFilialInclusao().getSgFilial());
    	map.put("filialByIdFilialInclusao.pessoa.nmFantasia", bean.getFilialByIdFilialInclusao().getPessoa().getNmFantasia());
    	if (bean.getFilialByIdFilialAlteraStatus() != null) {
	    	map.put("filialByIdFilialAlteraStatus.sgFilial", bean.getFilialByIdFilialAlteraStatus().getSgFilial());
	    	map.put("filialByIdFilialAlteraStatus.pessoa.nmFantasia", bean.getFilialByIdFilialAlteraStatus().getPessoa().getNmFantasia());
    	}
    	return map;
    }

    
    public void storeLacres(TypedFlatMap criteria) {
    	lacreControleCargaService.storeByControleCarga(	criteria.getLong("controleCarga.idControleCarga"),
    													criteria.getString("nrLacres"),
    													criteria.getString("obInclusaoLacre"), 
    													criteria.getString("dsLocalInclusao"));
    }
    
    /**
     * 
     * @param criteria
     * @return
     */
    public TypedFlatMap getDadosIniciaisByLacre(TypedFlatMap criteria) {
    	Filial filialUsuario = SessionUtils.getFilialSessao();
    	TypedFlatMap tfm = new TypedFlatMap();
    	tfm.put("filialUsuario.idFilial", filialUsuario.getIdFilial());
    	tfm.put("filialUsuario.sgFilial", filialUsuario.getSgFilial());
    	tfm.put("filialUsuario.pessoa.nmFantasia", filialUsuario.getPessoa().getNmFantasia());

    	DomainValue dv = domainValueService.findDomainValueByValue("DM_STATUS_LACRE_VEICULO", "FE");
    	tfm.put("tpStatusLacre", dv.getDescription().toString());

    	return tfm;
    }


    public List findTipoStatusLacre(Map criteria) {
    	List dominiosValidos = new ArrayList();
    	dominiosValidos.add("CA");
    	dominiosValidos.add("NE");
    	dominiosValidos.add("NC");
    	dominiosValidos.add("RA");
    	dominiosValidos.add("VI");
    	List retorno = domainValueService.findByDomainNameAndValues("DM_STATUS_LACRE_VEICULO", dominiosValidos);
    	return retorno;
    }
    

    public void storeConferenciaLacre(TypedFlatMap criteria) {
    	lacreControleCargaService.storeByConferenciaLacre(	criteria.getLong("idLacreControleCarga"),
															criteria.getString("tpStatusLacre"),
															criteria.getString("dsLocalConferencia"), 
															criteria.getString("obConferenciaLacre"));
    }


    public void storePagamentoProprietario(TypedFlatMap criteria) {
    	pagtoProprietarioCcService.storeByControleCarga(criteria.getLong("idPagtoProprietarioCc"),
    	    											criteria.getLong("moeda.idMoeda"),
    	    											criteria.getBigDecimal("vlPagamento"));
    }




    
    

	public List findLookupEquipe(Map criteria) {
		return equipeService.findLookup(criteria);
	}


	public ResultSetPage findPaginatedEquipe(TypedFlatMap criteria) {
		Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
		ResultSetPage rsp = equipeOperacaoService.findPaginatedByIdControleCarga(
				null, idControleCarga, null, Boolean.TRUE, FindDefinition.createFindDefinition(criteria));
		List retorno = new ArrayList();
		for (Iterator iter = rsp.getList().iterator(); iter.hasNext();) {
			EquipeOperacao equipeOperacao = (EquipeOperacao) iter.next();
			TypedFlatMap map = new TypedFlatMap();
			map.put("idEquipeOperacao", equipeOperacao.getIdEquipeOperacao());
			map.put("equipe.dsEquipe", equipeOperacao.getEquipe().getDsEquipe());
			map.put("dhInicioOperacao", equipeOperacao.getDhInicioOperacao());
			map.put("dhFimOperacao", equipeOperacao.getDhFimOperacao());
			retorno.add(map);
		}
		rsp.setList(retorno);
		return rsp; 
	}


	public Integer getRowCountEquipe(TypedFlatMap criteria) {
		Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
		Integer integer = equipeOperacaoService.getRowCountByIdControleCarga(null, idControleCarga);
		return integer;
	}

	public List findLookupPessoa(TypedFlatMap criteria) {
		Map pessoa = new HashMap();
		pessoa.put("tpPessoa", criteria.getString("pessoa.tpPessoa"));
		pessoa.put("nrIdentificacao", criteria.getString("pessoa.nrIdentificacao"));
		pessoa.put("tpIdentificacao", criteria.getString("pessoa.tpIdentificacao"));
		pessoa.remove("pessoa.nrIdentificacao");
		pessoa.remove("pessoa.tpIdentificacao");
		return pessoaService.findLookup(pessoa);
	}
	
	public ResultSetPage findPaginatedIntegranteEqOperac(TypedFlatMap criteria) {
		Long idEquipeOperacao = criteria.getLong("idEquipeOperacao");
		ResultSetPage rsp = integranteEqOperacService.findPaginatedByIdEquipeOperacao(idEquipeOperacao, FindDefinition.createFindDefinition(criteria));
		
		List retorno = new ArrayList();
		for (Iterator iter = rsp.getList().iterator(); iter.hasNext();) {
			IntegranteEqOperac bean = (IntegranteEqOperac)iter.next();
			TypedFlatMap map = new TypedFlatMap();
			map.put("idIntegranteEqOperac", bean.getIdIntegranteEqOperac());
			map.put("tpIntegrante", bean.getTpIntegrante());

			if (bean.getUsuario() != null) {
				map.put("nmIntegranteEquipe", bean.getUsuario().getNmUsuario());
				map.put("usuario.nrMatricula", bean.getUsuario().getNrMatricula());
	        }
			else
			if (bean.getPessoa() != null) {
				map.put("nmIntegranteEquipe", bean.getPessoa().getNmPessoa());
				map.put("pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(bean.getPessoa()) );
				map.put("pessoa.dhInclusao", bean.getPessoa().getDhInclusao() );
	        }

			if (bean.getCargoOperacional() != null) {
	        	map.put("cargoOperacional.dsCargo", bean.getCargoOperacional().getDsCargo());
	        }
	        if (bean.getEmpresa() != null) {
	        	map.put("empresa.pessoa.nmPessoa", bean.getEmpresa().getPessoa().getNmPessoa());
	        }
			retorno.add(map);
		}
		rsp.setList(retorno);
		return rsp;
	}

	public Integer getRowCountIntegranteEqOperac(TypedFlatMap criteria){
		Long idEquipeOperacao = criteria.getLong("idEquipeOperacao");
				return integranteEqOperacService.getRowCountByIdEquipeOperacao(idEquipeOperacao);
	}

	public TypedFlatMap findByIdEquipeOperacao(Long id) {
		EquipeOperacao equipeOperacao = equipeOperacaoService.findById(id);
		TypedFlatMap map = new TypedFlatMap();
		map.put("idEquipeOperacao", equipeOperacao.getIdEquipeOperacao());
		map.put("equipe.idEquipe", equipeOperacao.getEquipe().getIdEquipe());
		map.put("equipe.dsEquipe", equipeOperacao.getEquipe().getDsEquipe());
		map.put("dhInicioOperacao", equipeOperacao.getDhInicioOperacao());
		map.put("dhFimOperacao", equipeOperacao.getDhFimOperacao());
		return map;
	}
	
	public List findCargo(Map criteria) {
		return cargoOperacionalService.findCargo(criteria);
	}
	
	public List findLookupEmpresa(Map criteria) {
		return empresaService.findLookup(criteria);
	}

    public List findLookupUsuarioFuncionario(TypedFlatMap tfm){
    	String nrMatricula = tfm.getString("nrMatricula");
    	if (!StringUtils.isBlank(nrMatricula)){
    		nrMatricula = StringUtils.leftPad(nrMatricula, 9, '0');
    	}
    	return usuarioService.findLookupUsuarioFuncionario(tfm.getLong("idUsuario"), nrMatricula, null, null, null, null, true);
    }

    
    public List findCargoOperacional(Map criteria) {
    	List list = cargoOperacionalService.findCargo(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		CargoOperacional cargoOperacional = (CargoOperacional)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idCargoOperacional", cargoOperacional.getIdCargoOperacional());
    		typedFlatMap.put("dsCargo", cargoOperacional.getDsCargo());
    		retorno.add(typedFlatMap);
    	}
    	return retorno;
    }
	
	
    public TypedFlatMap findByIdIntegranteEqOperac(Long id) {
    	IntegranteEqOperac bean = integranteEqOperacService.findById(id);
    	TypedFlatMap map = new TypedFlatMap();
    	map.put("idIntegranteEqOperac", bean.getIdIntegranteEqOperac());
    	map.put("versao", bean.getVersao());
        map.put("tpIntegrante.value", bean.getTpIntegrante().getValue());
        map.put("equipeOperacao.idEquipeOperacao", bean.getEquipeOperacao().getIdEquipeOperacao());

        if (bean.getTpIntegrante().getValue().equals("F")) {
              map.put("usuario.idUsuario", bean.getUsuario().getIdUsuario());
              map.put("usuario.nrMatricula", bean.getUsuario().getNrMatricula());
              map.put("usuario.nmUsuario", bean.getUsuario().getNmUsuario());
        }
        else
        	if (bean.getTpIntegrante().getValue().equals("T")) {
				map.put("pessoa.idPessoa", bean.getPessoa().getIdPessoa());
				map.put("pessoa.pessoa.nrIdentificacao", bean.getPessoa().getNrIdentificacao());
				map.put("pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(bean.getPessoa()));
				map.put("pessoa.tpIdentificacao", bean.getPessoa().getTpIdentificacao().getValue());
				map.put("pessoa.nmPessoa", bean.getPessoa().getNmPessoa());
				map.put("pessoa.dhInclusao", bean.getPessoa().getDhInclusao());
        	}  

        if (bean.getCargoOperacional() != null) {
              map.put("cargoOperacional.idCargoOperacional", bean.getCargoOperacional().getIdCargoOperacional());
              map.put("cargoOperacional.dsCargo", bean.getCargoOperacional().getDsCargo());
        }  
        if (bean.getEmpresa() != null) {
              map.put("empresa.idEmpresa", bean.getEmpresa().getIdEmpresa());
              map.put("empresa.pessoa.nmPessoa", bean.getEmpresa().getPessoa().getNmPessoa());
              map.put("empresa.pessoa.nrIdentificacao", bean.getEmpresa().getPessoa().getNrIdentificacao());
              map.put("empresa.pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(bean.getEmpresa().getPessoa()));
        }
    	return map;
    }


    public TypedFlatMap storeIntegranteEqOperac(IntegranteEqOperac bean) {
    	bean.setEquipeOperacao( equipeOperacaoService.findById(bean.getEquipeOperacao().getIdEquipeOperacao()) );
    	if (bean.getTpIntegrante().getValue().equals("T"))
    		bean.setUsuario(null);

    	Long idIntegranteEqOperac = (Long)integranteEqOperacService.store(bean);
    	bean = integranteEqOperacService.findById(idIntegranteEqOperac);
    	TypedFlatMap map = new TypedFlatMap();
    	map.put("idIntegranteEqOperac", idIntegranteEqOperac);
    	map.put("versao", bean.getVersao());
    	return map;
    }

    
	/**
	 *
	 */
	@ParametrizedAttribute(type = java.lang.Long.class)
    public void removeByIdsIntegranteEqOperac(List ids) {
    	integranteEqOperacService.removeByIds(ids);
    }
    
    
    public TypedFlatMap generateTrocaEquipe(TypedFlatMap criteria) {
    	Map map = equipeOperacaoService.generateTrocaEquipeByControleCarga(criteria.getLong("idEquipe"), criteria.getLong("idControleCarga"));
    	EquipeOperacao equipeOperacao = (EquipeOperacao)map.get("equipeOperacao");

		TypedFlatMap tfm = new TypedFlatMap();
		tfm.put("idEquipeOperacao", equipeOperacao.getIdEquipeOperacao());
		tfm.put("equipe.idEquipe", equipeOperacao.getEquipe().getIdEquipe());
		tfm.put("equipe.dsEquipe", equipeOperacao.getEquipe().getDsEquipe());
		tfm.put("dhInicioOperacao", equipeOperacao.getDhInicioOperacao());
		tfm.put("dhFimOperacao", equipeOperacao.getDhFimOperacao());
		return tfm;
    }
    
    
	/**
     * 
     * @param criteria
     * @return
     */
    public List findPaginatedManifestos(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("controleCarga.idControleCarga");
    	List lista = manifestoService.findPaginatedManifestoByControleCarga(idControleCarga);
    	return lista;
    }

    
    public TypedFlatMap findDadosControleCargaByManifesto(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("idControleCarga");
    	ControleCarga cc = controleCargaService.findById(idControleCarga);
    	
    	TypedFlatMap map = new TypedFlatMap();
    	if (cc.getVlTotalFrota() != null) {
    		map.put("vlTotalFrota", cc.getVlTotalFrota());
    		map.put("moeda.siglaSimbolo", cc.getMoeda().getSiglaSimbolo());
    	}
    	map.put("tpControleCarga", cc.getTpControleCarga().getValue());
    	if (cc.getMeioTransporteByIdTransportado() != null) {
	    	map.put("meioTransporteByIdTransportado.nrFrota", cc.getMeioTransporteByIdTransportado().getNrFrota());
	    	map.put("meioTransporteByIdTransportado.nrIdentificador", cc.getMeioTransporteByIdTransportado().getNrIdentificador());
    	}
    	return map;
    }

    /**
     * 
     * @param criteria
     * @return
     */
    public ResultSetPage findPaginatedDocumentos(TypedFlatMap criteria) {
    	String strDhEmissao = criteria.getString("dhEmissaoManifesto");
    	Boolean blPreManifesto = strDhEmissao == null || strDhEmissao.equals("");
    	ResultSetPage rsp = doctoServicoService.findPaginatedDoctoServicoByManifesto(
														    			criteria.getString("manifesto.tpManifesto.value"), 
														    			blPreManifesto, criteria.getLong("idManifesto"), 
														    			criteria.getLong("doctoServico.idDoctoServico"), 
														    			criteria.getString("doctoServico.tpDocumentoServico"), 
														    			criteria.getLong("doctoServico.filialByIdFilialOrigem.idFilial"),
														    			FindDefinition.createFindDefinition(criteria));
    	List lista = rsp.getList();
    	for (Iterator iter = lista.iterator(); iter.hasNext();) {
    		Map map = (Map)iter.next();
    		if (map.get("vlMercadoria") == null) {
    			map.remove("sgMoeda");
    			map.remove("dsSimbolo");
    		}
    		if (map.get("vlTotalDocServico") != null) {
    			map.put("sgMoedaVlTotal", map.get("sgMoeda"));
    			map.put("dsSimboloVlTotal", map.get("dsSimbolo"));
    		}
    	}
    	rsp.setList(lista);
    	return rsp;
    }

    /**
     * 
     * @param criteria
     * @return
     */
    public Integer getRowCountDocumentos(TypedFlatMap criteria) {
    	Boolean blPreManifesto = criteria.get("dhEmissaoManifesto") == null;
    	return doctoServicoService.getRowCountDoctoServicoByManifesto(criteria.getString("manifesto.tpManifesto.value"), 
    			blPreManifesto, criteria.getLong("idManifesto"), criteria.getLong("idDoctoServico"), 
    			criteria.getString("doctoServico.tpDocumentoServico"), criteria.getLong("filialByIdFilialOrigem.idFilial"));
    }


    /**
     * 
     * @param criteria
     * @return
     */
    public TypedFlatMap findDadosManifesto(TypedFlatMap criteria) {
    	Manifesto manifesto = manifestoService.findById(criteria.getLong("idManifesto"));

    	TypedFlatMap map = new TypedFlatMap();
    	Long nrManifesto = manifesto.getNrPreManifesto();
    	String tpManifesto = manifesto.getTpManifesto().getValue();
    	map.put("idManifesto", manifesto.getIdManifesto());
    	map.put("filialByIdFilialOrigem.sgFilial", manifesto.getFilialByIdFilialOrigem().getSgFilial());
    	map.put("dhEmissaoManifesto", manifesto.getDhEmissaoManifesto());

    	if (tpManifesto.equals("E")) {
    		map.put("tpManifesto.description", domainValueService.findDomainValueDescription("DM_TAG_MANIFESTO", "EN"));
    		if (manifesto.getDhEmissaoManifesto() != null) {
    			nrManifesto = Long.valueOf(manifesto.getManifestoEntrega().getNrManifestoEntrega().toString());
    		}
    	}
    	else {
    		tpManifesto += manifesto.getTpAbrangencia().getValue();
	    	if (tpManifesto.equals("VN")) {
	    		map.put("tpManifesto.description", domainValueService.findDomainValueDescription("DM_TAG_MANIFESTO", "VN"));
	    		if (manifesto.getDhEmissaoManifesto() != null) {
	    			nrManifesto = Long.valueOf(manifesto.getManifestoViagemNacional().getNrManifestoOrigem().toString());
	    		}
	    	}
	    	else
	    	if (tpManifesto.equals("VI")) {
	    		map.put("tpManifesto.description", domainValueService.findDomainValueDescription("DM_TAG_MANIFESTO", "VI"));
	    		if (manifesto.getDhEmissaoManifesto() != null) {
	    			nrManifesto = manifesto.getManifestoInternacional().getNrManifestoInt();
	    		}
	    	}
    	}
    	
    	map.put("nrManifesto", nrManifesto);
    	map.put("tpManifesto.value", tpManifesto);
    	return map;
    }
    
    /**
     * Método que popula a combo de tipos de documento apenas com CTR, NFT, CRT, MDA.
     * 
     * @param criteria
     * @return List
     */
    public List findTipoDocumentoServico(Map criteria) {
        List dominiosValidos = new ArrayList();
        dominiosValidos.add("CTR");
        dominiosValidos.add("NFT");
        dominiosValidos.add("CRT");
        dominiosValidos.add("MDA");
        List retorno = domainValueService.findByDomainNameAndValues("DM_TIPO_DOCUMENTO_SERVICO", dominiosValidos);
        return retorno;
    }

    /**
     * Busca a filial baseado no documento de serviço
     * @param criteria
     * @return
     */
    public List findLookupFilialByDocumentoServico(Map criteria) {
    	FilterList filter = new FilterList(filialService.findLookup(criteria)) {
			public Map filterItem(Object item) {
				Filial filial = (Filial)item;
    			TypedFlatMap typedFlatMap = new TypedFlatMap();
	    		typedFlatMap.put("idFilial", filial.getIdFilial());
		    	typedFlatMap.put("sgFilial", filial.getSgFilial());
				return typedFlatMap;
			}
    	};
    	return (List)filter.doFilter();
    }
    
    public List findLookupServiceDocumentFilialCTR(Map criteria) {
    	return findLookupFilialByDocumentoServico(criteria);
    }
    public List findLookupServiceDocumentFilialNFT(Map criteria) {
    	return findLookupFilialByDocumentoServico(criteria);
    }
    public List findLookupServiceDocumentFilialCRT(Map criteria) {
    	return findLookupFilialByDocumentoServico(criteria);
    }
    public List findLookupServiceDocumentFilialMDA(Map criteria) {
    	return findLookupFilialByDocumentoServico(criteria);
    }

    public List findLookupServiceDocumentNumberCTR(Map criteria) {
    	criteria.remove("idDoctoServico");
    	return conhecimentoService.findLookup(criteria);
    }
    public List findLookupServiceDocumentNumberNFT(Map criteria) {
    	criteria.remove("idDoctoServico");
    	return conhecimentoService.findLookup(criteria);
    }
    public List findLookupServiceDocumentNumberCRT(Map criteria) {
    	criteria.remove("idDoctoServico");
    	return ctoInternacionalService.findLookup(criteria);
    }
    public List findLookupServiceDocumentNumberMDA(Map criteria) {
    	criteria.remove("idDoctoServico");
    	return mdaService.findLookup(criteria);
    }


    public void validateSemiReboqueToLocalTroca(TypedFlatMap criteria) {
    	controleCargaService.validateSemiReboqueControleCarga(criteria.getLong("idMeioTransporte"));
    }
}