package com.mercurio.lms.vol.action;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.joda.time.DateTime;
import org.joda.time.DateTimeZone;


import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.model.service.DomainValueService;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.vol.model.VolRecusas;
import com.mercurio.lms.vol.model.service.VolEmailsRecusaService;
import com.mercurio.lms.vol.model.service.VolRecusaTratativasClienteService;
import com.mercurio.lms.vol.model.service.VolRecusasService;



/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.vol.recusaTratativasClienteAction"
 * 					
 */
public class RecusaTratativasClienteAction extends CrudAction{
	private VolRecusaTratativasClienteService volRecusaTratativasClienteService;
	private VolRecusasService volRecusasService;
	private DomainValueService domainValueService;
	private VolEmailsRecusaService volEmailsRecusaService;
	
	public VolRecusasService getVolRecusasService() {
		return volRecusasService;
	}

	public void setVolRecusasService(VolRecusasService volRecusasService) {
		this.volRecusasService = volRecusasService;
	}

	/**
	 * retorna a o número do documento da recusa, nome do recebedor e os contatos da recusa
	 * @param criteria
	 * @return 
	 */
	public List findRecusa(TypedFlatMap criteria){
		Long idRecusa = null;
		try{
			idRecusa = Long.parseLong(volRecusasService.decriptografaIdRecusa(criteria.getString("idRecusa")));
		}catch (Exception e) {
			throw new BusinessException("LMS-41012");
		}
		
		List result = this.getVolRecusaTratativasClienteService().findRecusa(idRecusa);
		List listRetorno = new ArrayList();
			
		for(Iterator it = result.iterator(); it.hasNext();){
			TypedFlatMap map = new TypedFlatMap();
			
			Map linha = (Map)it.next();
			if(linha.get("dhTratativa") != null){
				throw new BusinessException("LMS-41014");
			}else{
				map.put("documento", linha.get("nrConhecimento"));
				map.put("destinatario", linha.get("destinatario"));
				map.put("idEmailRecusa", linha.get("idEmailRecusa"));
				map.put("nmContato", linha.get("nmContato"));
				map.put("idFilial", linha.get("idFilial"));
				map.put("nrIdentificacao", linha.get("nrIdentificacao"));
				map.put("dhRecusa", linha.get("dhRecusa"));
				map.put("motivo", linha.get("dsOcorrenciaEntrega"));
								
			}
			
			listRetorno.add(map);
		}
		
		return listRetorno;
	}
	
	/**
	 * atualiza VolRecusa com os dados da tratativa do Cliente e
	 * envia email para o setor de recusa quando a tratativa é feita pelo cliente
	 * @param tela
	 */
	public void store(TypedFlatMap tela){
		VolRecusas volRecusas = null;
		Long idRecusa = Long.parseLong(volRecusasService.decriptografaIdRecusa(tela.getString("idRecusa")));
		volRecusas = getVolRecusasService().findById(idRecusa);
		volRecusas.setVolEmailsRecusa(getVolEmailsRecusaService().findById(tela.getLong("emailContato")));
		volRecusas.setDhTratativa(new DateTime(DateTimeZone.getDefault()));
		volRecusas.setTpRecusa(domainValueService.findDomainValueByValue("DM_STATUS_RECUSA", tela.getString("acao")));
		volRecusas.setObTratativa(tela.getString("observacoes"));
		
		getVolRecusasService().store(volRecusas);	
		
		sendEmail(tela);
		
	}
	
	/**
     * envia email para o setor de recusa e resposta de confirmação para o cliente quando a tratativa
     * é feita pelo cliente
     * @param criteria
     */
	public void sendEmail(TypedFlatMap criteria){
		
		this.getVolRecusaTratativasClienteService().sendEmailSetorRecusa(criteria);
		this.getVolRecusaTratativasClienteService().sendEmailCliente(criteria);
		
	}



	public VolRecusaTratativasClienteService getVolRecusaTratativasClienteService() {
		return volRecusaTratativasClienteService;
	}


	public void setVolRecusaTratativasClienteService(
			VolRecusaTratativasClienteService volRecusaTratativasClienteService) {
		this.volRecusaTratativasClienteService = volRecusaTratativasClienteService;
	}

	public DomainValueService getDomainValueService() {
		return domainValueService;
	}

	public void setDomainValueService(DomainValueService domainValueService) {
		this.domainValueService = domainValueService;
	}

	public VolEmailsRecusaService getVolEmailsRecusaService() {
		return volEmailsRecusaService;
	}

	public void setVolEmailsRecusaService(
			VolEmailsRecusaService volEmailsRecusaService) {
		this.volEmailsRecusaService = volEmailsRecusaService;
	}







}
