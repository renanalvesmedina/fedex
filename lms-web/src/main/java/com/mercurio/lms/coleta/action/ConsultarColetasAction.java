package com.mercurio.lms.coleta.action;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.MapUtils;
import org.apache.commons.lang.StringUtils;
import org.joda.time.DateTime;

import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;
import com.mercurio.adsm.framework.model.DomainValue;
import com.mercurio.adsm.framework.model.FindDefinition;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.coleta.model.EventoColeta;
import com.mercurio.lms.coleta.model.PedidoColeta;
import com.mercurio.lms.coleta.model.dto.ConsultarColetaDTO;
import com.mercurio.lms.coleta.model.service.DetalheColetaService;
import com.mercurio.lms.coleta.model.service.EventoColetaService;
import com.mercurio.lms.coleta.model.service.FuncionarioRegiaoService;
import com.mercurio.lms.coleta.model.service.PedidoColetaService;
import com.mercurio.lms.coleta.model.util.TpStatusColetaConstants;
import com.mercurio.lms.configuracoes.model.Servico;
import com.mercurio.lms.configuracoes.model.param.ConsultarUsuarioLMSParam;
import com.mercurio.lms.configuracoes.model.service.FuncionarioService;
import com.mercurio.lms.configuracoes.model.service.ServicoService;
import com.mercurio.lms.configuracoes.model.service.UsuarioLMSService;
import com.mercurio.lms.configuracoes.model.service.UsuarioService;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.RotaColetaEntrega;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.municipios.model.service.RegiaoColetaEntregaFilService;
import com.mercurio.lms.municipios.model.service.RotaColetaEntregaService;
import com.mercurio.lms.util.FormatUtils;
import com.mercurio.lms.util.JTDateTimeUtils;
import com.mercurio.lms.util.session.SessionUtils;
import com.mercurio.lms.vendas.model.Cliente;
import com.mercurio.lms.vendas.model.service.ClienteService;
;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.coleta.consultarColetasAction"
 */

public class ConsultarColetasAction {
	
	private PedidoColeta pedidoColeta;
	private PedidoColetaService pedidoColetaService;
	private RegiaoColetaEntregaFilService regiaoColetaEntregaFilService;
	private FilialService filialService;
	private RotaColetaEntregaService rotaColetaEntregaService;
	private DetalheColetaService detalheColetaService;
	private ClienteService clienteService;
	private ServicoService servicoService;
	private FuncionarioRegiaoService funcionarioRegiaoService;
	private FuncionarioService funcionarioService;
	private UsuarioLMSService usuarioLMSService;
	private UsuarioService usuarioService;
	private EventoColetaService eventoColetaService;
	
    public void setUsuarioService(UsuarioService usuarioService) {
		this.usuarioService = usuarioService;
	}

    public PedidoColeta getPedidoColeta() {
		return pedidoColeta;
	}
    
	public void setPedidoColeta(PedidoColeta pedidoColeta) {
		this.pedidoColeta = pedidoColeta;
	}
	
	public PedidoColetaService getPedidoColetaService() {
		return pedidoColetaService;
	}
	
	public void setPedidoColetaService(PedidoColetaService pedidoColetaService) {
		this.pedidoColetaService = pedidoColetaService;
	}
	
	public RegiaoColetaEntregaFilService getRegiaoColetaEntregaFilService() {
		return regiaoColetaEntregaFilService;
	}

	public void setRegiaoColetaEntregaFilService(
			RegiaoColetaEntregaFilService regiaoColetaEntregaFilService) {
		this.regiaoColetaEntregaFilService = regiaoColetaEntregaFilService;
	}
	
	public FilialService getFilialService() {
		return filialService;
	}

	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	
	public FuncionarioService getFuncionarioService() {
		return funcionarioService;
	}

	public void setFuncionarioService(FuncionarioService funcionarioService) {
		this.funcionarioService = funcionarioService;
	}

	public RotaColetaEntregaService getRotaColetaEntregaService() {
		return rotaColetaEntregaService;
	}

	public void setRotaColetaEntregaService(
			RotaColetaEntregaService rotaColetaEntregaService) {
		this.rotaColetaEntregaService = rotaColetaEntregaService;
	}

	public DetalheColetaService getDetalheColetaService() {
		return detalheColetaService;
	}

	public void setDetalheColetaService(DetalheColetaService detalheColetaService) {
		this.detalheColetaService = detalheColetaService;
	}

	public ClienteService getClienteService() {
		return clienteService;
	}

	public void setClienteService(ClienteService clienteService) {
		this.clienteService = clienteService;
	}

	public ServicoService getServicoService() {
		return servicoService;
	}

	public void setServicoService(ServicoService servicoService) {
		this.servicoService = servicoService;
	}

	public FuncionarioRegiaoService getFuncionarioRegiaoService() {
		return funcionarioRegiaoService;
	}

	public void setFuncionarioRegiaoService(
			FuncionarioRegiaoService funcionarioRegiaoService) {
		this.funcionarioRegiaoService = funcionarioRegiaoService;
	}

	
	/**
	 * Apaga uma entidade através do Id.
	 *
	 * @param id indica a entidade que deverá ser removida.
	 */
	public void removeById(java.lang.Long id) {
        this.getPedidoColetaService().removeById(id);
    }
	
	/**
	 * Apaga várias entidades através do Id.
	 * @param ids lista com as entidades que deverão ser removida.
	 * 
	 *
	 */
	@ParametrizedAttribute(type = java.lang.Long.class)
    public void removeByIds(List ids) {
    	getPedidoColetaService().removeByIds(ids);
    }

    /**
	 * Insere, caso o id seja <code>null</code> ou atualiza uma entidade, caso contrário.
	 *
	 * @param bean entidade a ser armazenada.
	 * @return entidade que foi armazenada.
	 */
    public Serializable store(PedidoColeta bean) {
        return this.getPedidoColetaService().store(bean);
    }
    
    
    public PedidoColeta findById(java.lang.Long id) {
    	return this.getPedidoColetaService().findById(id);
    }
    
    /**
     * Retorna um map com os objetos a serem mostrados na grid.
     * 
     * @param Map criteria
     * 
     * @return ResultSetPage
     */
    @SuppressWarnings("rawtypes")
	public ResultSetPage findPaginatedConsultarColetas(TypedFlatMap criteria) {
    	ResultSetPage resultSetPage = this.getPedidoColetaService().findPaginatedConsultarColeta(populateConsultarColetaDTO(criteria), FindDefinition.createFindDefinition(criteria));
    	
    	populateDsCancelamento(resultSetPage.getList());
    	
    	return resultSetPage;
    }
    
    /**
     * Constrói um objeto do tipo DTO com os filtros informados na tela.
     * 
     * @param criteria
     * @return ConsultarColetaDTO
     */
    private ConsultarColetaDTO populateConsultarColetaDTO(TypedFlatMap criteria){
    	ConsultarColetaDTO consultarColetaDTO = new ConsultarColetaDTO();
    	consultarColetaDTO.setIdFilial(criteria.getLong("filialByIdFilialResponsavel.idFilial"));
    	consultarColetaDTO.setIdRotaColetaEntrega(criteria.getLong("rotaColetaEntrega.idRotaColetaEntrega"));
    	consultarColetaDTO.setIdRegiaoColetaEntregaFil(criteria.getLong("regiaoColetaEntregaFil.idRegiaoColetaEntregaFil"));
    	consultarColetaDTO.setIdServico(criteria.getLong("detalheColetas.servico.idServico"));
    	consultarColetaDTO.setIdCliente(criteria.getLong("cliente.idCliente"));
    	consultarColetaDTO.setIdFilialDestino(criteria.getLong("detalheColetas.filial.idFilial"));
    	consultarColetaDTO.setIdDestino(criteria.getLong("detalheColetas.filial.idFilial"));
    	consultarColetaDTO.setIdUsuario(criteria.getLong("usuario.idUsuario"));
    	consultarColetaDTO.setNrColeta(criteria.getLong("nrColeta"));    	
    	consultarColetaDTO.setDhPedidoColetaInicial(criteria.getDateTime("dhPedidoColetaInicial"));
    	consultarColetaDTO.setDhPedidoColetaFinal(criteria.getDateTime("dhPedidoColetaFinal"));    	
    	consultarColetaDTO.setBlSemVinculoDoctoServico(criteria.getBoolean("blSemVinculoDoctoServico"));
    	consultarColetaDTO.setTpPedidoColeta(MapUtils.getString(criteria, "tpPedidoColeta"));
    	consultarColetaDTO.setBlProdutoPerigoso(criteria.getBoolean("blProdutoPerigoso"));
    	consultarColetaDTO.setBlProdutoControlado(criteria.getBoolean("blProdutoControlado"));
    	
    	/*
    	 * Define tipos de status da coleta. 
    	 */
    	List<String> listStatus = new ArrayList<String>();    	
    	addTpColeta(listStatus, criteria, "tpSCAberto", TpStatusColetaConstants.EM_ABERTO);    	
    	addTpColeta(listStatus, criteria, "tpSCTransmitida", TpStatusColetaConstants.TRANSMITIDA);
    	addTpColeta(listStatus, criteria, "tpSCManifestada",TpStatusColetaConstants.MANIFESTADA);
    	addTpColeta(listStatus, criteria, "tpSCExecutada", TpStatusColetaConstants.EXECUTADA);
    	addTpColeta(listStatus, criteria, "tpSCCancelada", TpStatusColetaConstants.CANCELADA);
    	addTpColeta(listStatus, criteria, "tpSCAguardandoDescarga", TpStatusColetaConstants.AGUARDANDO_DESCARGA);
    	addTpColeta(listStatus, criteria, "tpSCEmDescarga", TpStatusColetaConstants.EM_DESCARGA);
    	addTpColeta(listStatus, criteria, "tpSCNoTerminal", TpStatusColetaConstants.NO_TERMINAL);
    	addTpColeta(listStatus, criteria, "tpSCFinalizada", TpStatusColetaConstants.FINALIZADA);
    	addTpColeta(listStatus, criteria, "tpSCNoManifesto", TpStatusColetaConstants.NO_MANIFESTO);
		
    	consultarColetaDTO.setTpsStatusColeta(listStatus);
		
		return consultarColetaDTO;
    }
    
    /**
     * Adiciona um tipo de status de acordo com o valor do multicheckbox do filtro.
     * 
     * @param listStatus
     * @param criteria
     * @param key
     * @param tpStatusColeta
     */
    private void addTpColeta(List<String> listStatus, TypedFlatMap criteria, String key, TpStatusColetaConstants tpStatusColeta){
    	if(criteria.getBoolean((key))){
    		listStatus.add(tpStatusColeta.getValue());
    	}
    }
    
    private void populateDsCancelamento(List list){
    	for (Map map : (List<Map>)list) {
    		if ( (map.get("tpStatusColeta") != null) && (  ((DomainValue)map.get("tpStatusColeta") ).getValue().equals("CA") ) ){
    			Long idPedidoColeta = (Long)map.get("idPedidoColeta");
    			List<EventoColeta> listEventos = eventoColetaService.findEventoColetaByIdPedidoColeta(idPedidoColeta, "CA");
    			StringBuilder dsCancelamento = new StringBuilder();
    			for (EventoColeta eventoColeta : listEventos) {
					dsCancelamento.append(eventoColeta.getDsDescricao()).append(" ");
				}
    			map.put("dsCancelamento", dsCancelamento.toString());
    		}
		}
    }
    
    /**
     * Faz a consulta ao banco, retornando o numero de registros encontrados para determinados 
     * parametros.
     * 
     * @param TypedFlatMap
     * @return Integer
     */
    public Integer getRowCountConsultarColetas(TypedFlatMap criteria) {    	
    	return this.getPedidoColetaService().getRowCountConsultarColeta(populateConsultarColetaDTO(criteria));
    }
    
    
    /**
     * Finds padroes da tela de consultarColeta
     * 
     * @param TypedFlatMap
     * @return
     */
    public List findLookupFilial(Map criteria) {
    	List filiais = this.getFilialService().findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = filiais.iterator(); iter.hasNext();) {
			Filial filial = (Filial) iter.next();
			TypedFlatMap typedFlatMap = new TypedFlatMap();
			typedFlatMap.put("idFilial", filial.getIdFilial());
			typedFlatMap.put("sgFilial", filial.getSgFilial());
			typedFlatMap.put("pessoa.nmPessoa", filial.getPessoa().getNmPessoa());
			typedFlatMap.put("pessoa.nmFantasia", filial.getPessoa().getNmFantasia());
			retorno.add(typedFlatMap);
		}
    	
    	return retorno;
    }
        
    public List findLookupUsuario(TypedFlatMap tfm) {
		ConsultarUsuarioLMSParam cup = new ConsultarUsuarioLMSParam();
		
		cup.setNrMatricula(tfm.getString("nrMatricula"));
		cup.setNmUsuario(tfm.getString("nmUsuario"));
		cup.setTpCategoriaUsuario(tfm.getString("tpCategoriaUsuario"));

        return usuarioLMSService.findLookupSistema(cup);
    }
    
	public List findLookupUsuarioFuncionario(TypedFlatMap tfm) {

		Long idFilial = tfm.getLong("filial.idFilial");
		String nrMatricula = tfm.getString("nrMatricula");

		return usuarioService.findLookupUsuarioFuncionario(null,
				nrMatricula, idFilial, null, null, null, true);
	}
	
    public List findLookupRotaColetaEntrega(Map criteria){
    	((Map)criteria.get("filial")).remove("sgFilial");
    	((Map)criteria.get("filial")).remove("pessoa");
    	List rotas = this.getRotaColetaEntregaService().findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = rotas.iterator(); iter.hasNext();) {
			RotaColetaEntrega rotaColetaEntrega = (RotaColetaEntrega) iter.next();
			TypedFlatMap typedFlatMap = new TypedFlatMap();
			typedFlatMap.put("idRotaColetaEntrega", rotaColetaEntrega.getIdRotaColetaEntrega());
			typedFlatMap.put("nrRota", rotaColetaEntrega.getNrRota());
			typedFlatMap.put("dsRota", rotaColetaEntrega.getDsRota());
			retorno.add(typedFlatMap);
		}
    	return retorno;
    }

    public List findRegiaoColetaEntregaFil(TypedFlatMap criteria){
    	return this.getFuncionarioRegiaoService().findRegiaoColetaEntregaByFilial(criteria);
    }
    
    public List findDetalheColetas(Map criteria) {
    	return this.getDetalheColetaService().find(criteria);
    }
    
    public List findLookupCliente(Map criteria){
    	List clientes = this.getClienteService().findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = clientes.iterator(); iter.hasNext();) {
			Cliente cliente = (Cliente) iter.next();
			TypedFlatMap typedFlatMap = new TypedFlatMap();
			typedFlatMap.put("idCliente", cliente.getIdCliente());
			typedFlatMap.put("pessoa.nmPessoa", cliente.getPessoa().getNmPessoa());
			typedFlatMap.put("pessoa.nrIdentificacao", cliente.getPessoa().getNrIdentificacao());
			typedFlatMap.put("pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(cliente.getPessoa()));
			retorno.add(typedFlatMap);
		}
    	return retorno;
    }
    
    /**
     * Retorna o idServico e dsServico.
     * @param criteria
     * @return
     */
    public List findServico(Map criteria) {
    	List servicos = this.getServicoService().find(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = servicos.iterator(); iter.hasNext();) {
			Servico servico = (Servico) iter.next();
			TypedFlatMap typedFlatMap = new TypedFlatMap();
			typedFlatMap.put("idServico", servico.getIdServico());
			typedFlatMap.put("dsServico", servico.getDsServico());
			retorno.add(typedFlatMap);
		}
    	return retorno;
    }
    
    /**
     * Busca o usuario da sessao e retorna para a tela
     * 
     * @return
     */
    public TypedFlatMap findFilialUsuarioLogado() {
    	TypedFlatMap mapSessao = new TypedFlatMap();
    	
    	Filial filial = SessionUtils.getFilialSessao();    	    	
    	mapSessao.put("filial.idFilial", filial.getIdFilial());
    	mapSessao.put("filial.sgFilial", filial.getSgFilial());
    	mapSessao.put("filial.pessoa.nmFantasia", filial.getPessoa().getNmFantasia());
    	
    	DateTime dataHoraAtualMenos30Dias = JTDateTimeUtils.getDataHoraAtual();
    	dataHoraAtualMenos30Dias = dataHoraAtualMenos30Dias.minusDays(30);
    	mapSessao.put("dataHoraAtualMenos30Dias", dataHoraAtualMenos30Dias);
    	mapSessao.put("dataHoraAtual", JTDateTimeUtils.getDataHoraAtual());
    	    	
    	return mapSessao;
    }

	public void setUsuarioLMSService(UsuarioLMSService usuarioLMSService) {
		this.usuarioLMSService = usuarioLMSService;
	}

	public EventoColetaService getEventoColetaService() {
		return eventoColetaService;
}

	public void setEventoColetaService(EventoColetaService eventoColetaService) {
		this.eventoColetaService = eventoColetaService;
	}
	
	
}
