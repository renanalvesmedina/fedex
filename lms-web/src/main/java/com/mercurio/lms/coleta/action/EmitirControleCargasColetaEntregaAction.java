package com.mercurio.lms.coleta.action;

import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.model.masterdetail.ItemList;
import com.mercurio.adsm.framework.model.masterdetail.ItemListConfig;
import com.mercurio.adsm.framework.model.masterdetail.MasterDetailFactory;
import com.mercurio.adsm.framework.model.masterdetail.MasterEntry;
import com.mercurio.adsm.framework.model.masterdetail.MasterEntryConfig;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.carregamento.action.ControleCargaAction;
import com.mercurio.lms.carregamento.action.MdfeActionUtils;
import com.mercurio.lms.carregamento.model.ControleCarga;
import com.mercurio.lms.carregamento.model.EquipeOperacao;
import com.mercurio.lms.carregamento.model.IntegranteEqOperac;
import com.mercurio.lms.carregamento.model.PagtoPedagioCc;
import com.mercurio.lms.carregamento.model.PostoPassagemCc;
import com.mercurio.lms.carregamento.model.ReciboPostoPassagem;
import com.mercurio.lms.carregamento.model.service.CarregamentoDescargaService;
import com.mercurio.lms.carregamento.model.service.ControleCargaService;
import com.mercurio.lms.carregamento.model.service.EquipeOperacaoService;
import com.mercurio.lms.carregamento.model.service.IntegranteEqOperacService;
import com.mercurio.lms.carregamento.model.service.ReciboPostoPassagemService;
import com.mercurio.lms.configuracoes.ConfiguracoesFacade;
import com.mercurio.lms.configuracoes.model.ConteudoParametroFilial;
import com.mercurio.lms.configuracoes.model.service.ConteudoParametroFilialService;
import com.mercurio.lms.contratacaoveiculos.model.MeioTransporte;
import com.mercurio.lms.contratacaoveiculos.model.TipoMeioTransporte;
import com.mercurio.lms.contratacaoveiculos.model.service.MeioTranspProprietarioService;
import com.mercurio.lms.contratacaoveiculos.model.service.MeioTransporteService;
import com.mercurio.lms.contratacaoveiculos.model.service.TipoMeioTransporteService;
import com.mercurio.lms.expedicao.model.ManifestoEletronico;
import com.mercurio.lms.expedicao.model.service.ManifestoEletronicoService;
import com.mercurio.lms.fretecarreteirocoletaentrega.model.TabelaColetaEntrega;
import com.mercurio.lms.fretecarreteirocoletaentrega.model.TipoTabelaColetaEntrega;
import com.mercurio.lms.fretecarreteirocoletaentrega.model.service.TabelaColetaEntregaService;
import com.mercurio.lms.fretecarreteirocoletaentrega.model.service.TipoTabelaColetaEntregaService;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.sgr.dto.PlanoGerenciamentoRiscoDTO;
import com.mercurio.lms.sgr.model.FaixaDeValor;
import com.mercurio.lms.sgr.model.service.FaixaDeValorService;
import com.mercurio.lms.sgr.model.service.PlanoGerenciamentoRiscoService;
import com.mercurio.lms.sgr.model.service.ProcedimentoGerRiscoService;
import com.mercurio.lms.sgr.model.util.PlanoGerenciamentoRiscoUtils;
import com.mercurio.lms.util.FormatUtils;
import com.mercurio.lms.util.JTDateTimeUtils;
import com.mercurio.lms.util.session.SessionUtils;
import com.mercurio.lms.workflow.model.Pendencia;
import com.mercurio.lms.workflow.model.service.PendenciaService;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Nï¿½o inserir documentaï¿½ï¿½o apï¿½s ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviï¿½o.
 * @spring.bean id="lms.coleta.emitirControleCargasColetaEntregaAction"
 */

public class EmitirControleCargasColetaEntregaAction extends ControleCargaAction {


	private static final String PENDENCIA_APROVADA = "A";
	private static final String PENDENCIA_REPROVADA = "R";
	private static final String PEDENCIA_EM_APROVACAO = "E";
	private static final Long ID_EVENTO_WORKFLOW_CEMOP = 10L;
	private static final String PA_SGR_VAL_EXIST_PGR = "SGR_VAL_EXIST_PGR";
	
	private EquipeOperacaoService equipeOperacaoService;
	private FilialService filialService;
	private IntegranteEqOperacService integranteEqOperacService;
	private MeioTranspProprietarioService meioTranspProprietarioService;
	private MeioTransporteService meioTransporteService;
	private ProcedimentoGerRiscoService procedimentoGerRiscoService;
	private ReciboPostoPassagemService reciboPostoPassagemService;
	private TipoMeioTransporteService tipoMeioTransporteService;
	private TipoTabelaColetaEntregaService tipoTabelaColetaEntregaService;
	private TabelaColetaEntregaService tabelaColetaEntregaService;
	private ManifestoEletronicoService manifestoEletronicoService;
	private ConfiguracoesFacade configuracoesFacade;
	private FaixaDeValorService faixaDeValorService;
	private PendenciaService pendenciaService;
	private CarregamentoDescargaService carregamentoDescargaService;
	private PlanoGerenciamentoRiscoService planoGerenciamentoRiscoService;
	private PlanoGerenciamentoRiscoUtils planoUtils;
	
	private ConteudoParametroFilialService conteudoParametroFilialService;	
	private static final String PARAMETRO_FILIAL = "ATIVA_CALCULO_PADRAO";
	private static final String SIM = "S";

	public void setPendenciaService(PendenciaService pendenciaService) {
		this.pendenciaService = pendenciaService;
	}
	
	public void setFaixaDeValorService(FaixaDeValorService faixaDeValorService) {
		this.faixaDeValorService = faixaDeValorService;
	}

	public void setEquipeOperacaoService(EquipeOperacaoService equipeOperacaoService) {
		this.equipeOperacaoService = equipeOperacaoService;
	}
	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	public void setIntegranteEqOperacService(IntegranteEqOperacService integranteEqOperacService) {
		this.integranteEqOperacService = integranteEqOperacService;
	}
	public void setMeioTransporteService(MeioTransporteService meioTransporteService) {
		this.meioTransporteService = meioTransporteService;
	}
	public void setMeioTranspProprietarioService(MeioTranspProprietarioService meioTranspProprietarioService) {
		this.meioTranspProprietarioService = meioTranspProprietarioService;
	}
	public void setProcedimentoGerRiscoService(ProcedimentoGerRiscoService procedimentoGerRiscoService) {
		this.procedimentoGerRiscoService = procedimentoGerRiscoService;
	}
	public void setReciboPostoPassagemService(ReciboPostoPassagemService reciboPostoPassagemService) {
		this.reciboPostoPassagemService = reciboPostoPassagemService;
	}
	public void setTipoMeioTransporteService(TipoMeioTransporteService tipoMeioTransporteService) {
		this.tipoMeioTransporteService = tipoMeioTransporteService;
	}
	public void setTipoTabelaColetaEntregaService(TipoTabelaColetaEntregaService tipoTabelaColetaEntregaService) {
		this.tipoTabelaColetaEntregaService = tipoTabelaColetaEntregaService;
	}

	

	public List findLookupFilialByControleCarga(Map criteria) {
    	List list = filialService.findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		Filial filial = (Filial)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idFilial", filial.getIdFilial());
    		typedFlatMap.put("sgFilial", filial.getSgFilial());
    		typedFlatMap.put("pessoa.nmFantasia", filial.getPessoa().getNmFantasia());
    		retorno.add(typedFlatMap);
    	}
    	return retorno;
    }

	
    public List findLookupControleCarga(Map criteria) {
    	criteria.remove("tpControleCarga");
    	List list = ((ControleCargaService)super.getMasterService()).findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		ControleCarga controleCarga = (ControleCarga)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idControleCarga", controleCarga.getIdControleCarga());
    		typedFlatMap.put("nrControleCarga", controleCarga.getNrControleCarga());
    		typedFlatMap.put("tpControleCarga", controleCarga.getTpControleCarga());
    		if (controleCarga.getMeioTransporteByIdTransportado() != null) {
     			typedFlatMap.put("meioTransporteByIdTransportado.idMeioTransporte", controleCarga.getMeioTransporteByIdTransportado().getIdMeioTransporte());  
    			typedFlatMap.put("meioTransporteByIdTransportado.nrFrota", controleCarga.getMeioTransporteByIdTransportado().getNrFrota());
    			typedFlatMap.put("meioTransporteByIdTransportado.nrIdentificador", controleCarga.getMeioTransporteByIdTransportado().getNrIdentificador());
    		}
    		typedFlatMap.put("filialByIdFilialOrigem.idFilial", controleCarga.getFilialByIdFilialOrigem().getIdFilial());
    		typedFlatMap.put("filialByIdFilialOrigem.sgFilial", controleCarga.getFilialByIdFilialOrigem().getSgFilial());
    		
    		//LMS-5146
     		List<ManifestoEletronico> manifestoEletronicos = manifestoEletronicoService.findManifestoEletronicoByControleCargaAndTpSituacao(
     				controleCarga.getIdControleCarga(), null, null); 
     		if(manifestoEletronicos != null && !manifestoEletronicos.isEmpty()){
     			typedFlatMap.put("btnMdfe", "true");
     		}else{
     			typedFlatMap.put("btnMdfe", "false");
     		}
     		
    		retorno.add(typedFlatMap);
    		if (!controleCarga.getTpControleCarga().getValue().equals("C")) {
    			throw new BusinessException("LMS-05009");
    		}
    		putMasterInSession(controleCarga);
    	}
    	return retorno;
    }
    

    private List findTipoTabelaColetaEntrega(MeioTransporte meioTransporte, TipoTabelaColetaEntrega tipoTabelaColetaEntrega, Long idRotaColetaEntrega) {
    	if (meioTransporte == null)
    		return Collections.EMPTY_LIST;
 
    	if (tipoTabelaColetaEntrega != null) {
    		TipoTabelaColetaEntrega ttce = tipoTabelaColetaEntregaService.findById(tipoTabelaColetaEntrega.getIdTipoTabelaColetaEntrega());
    		
    		TypedFlatMap tfm = new TypedFlatMap();
    		tfm.put("idTipoTabelaColetaEntrega", ttce.getIdTipoTabelaColetaEntrega());
    		tfm.put("dsTipoTabelaColetaEntrega", ttce.getDsTipoTabelaColetaEntrega().toString());
    		tfm.put("blNormal", ttce.getBlNormal());

    		List lista = new ArrayList();
    		lista.add(tfm);
    		return lista;
    	}
    	try {
    		return tipoTabelaColetaEntregaService.findTipoTabelaColetaEntregaWithTabelaColetaEntrega(
    			SessionUtils.getFilialSessao().getIdFilial(), meioTransporte.getIdMeioTransporte(), idRotaColetaEntrega);
    	} catch (BusinessException be) {
    		return Collections.EMPTY_LIST;
    	}
    }

    
    
    
    

    /**
     * Retorna a os dados do controle de carga informado.
     * 
     * @param idControleCarga
     * @return
     */
    public TypedFlatMap findDataControleCarga(Long idControleCarga) {
    	ControleCarga cc = getControleCargaService().findById(idControleCarga);
    	putMasterInSession(cc);

    	TypedFlatMap tfm = getControleCargaService().findByIdByEmitirControleCargaColetaEntrega(cc);
    	List tabelas = findTipoTabelaColetaEntrega(cc.getMeioTransporteByIdTransportado(), cc.getTipoTabelaColetaEntrega(), cc.getRotaColetaEntrega().getIdRotaColetaEntrega());
    	for (Iterator iter = tabelas.iterator(); iter.hasNext();) {
    		TypedFlatMap map = (TypedFlatMap)iter.next();
    		Boolean blNormal = map.getBoolean("blNormal");
    		if (blNormal != null && blNormal) {
	    		tfm.put("idTipoTabelaColetaEntrega_blNormal", map.getLong("idTipoTabelaColetaEntrega"));
	    		break;
    		}
    	}
    	tfm.put("tabelas", tabelas);
    	if(tfm.get("tabelas")!=null && !((List) tfm.get("tabelas")).isEmpty()){
    		if(isCalculoPadrao()){
    			if(((Map)((List) tfm.get("tabelas")).get(0)).get("tpCalculo") == null){
    				tfm.put("tpCalculoTabelas", "PA");
    				((TypedFlatMap)tabelas.get(0)).put("dsTipoTabelaColetaEntrega","Calculo Padrão");
    			}else{
    				tfm.put("tpCalculoTabelas", ((Map)((List) tfm.get("tabelas")).get(0)).get("tpCalculo"));
    			}    			
    		}else{
    			tfm.put("tpCalculoTabelas", ((Map)((List) tfm.get("tabelas")).get(0)).get("tpCalculo"));    			
    		}
    		
    		
    		
		}
    	return tfm;
    }
    
    
    public List findLookupMeioTransporteTransportado(Map criteria) {
    	criteria.put("tipoMeioTransporte", "transportado");
    	return findLookupMeioTransporte(criteria);
    }
    
    public List findLookupMeioTransporteSemiRebocado(Map criteria) {
    	criteria.put("tipoMeioTransporte", "semiRebocado");
    	return findLookupMeioTransporte(criteria);
    }

	public void validateMeioTransporte(TypedFlatMap criteria) {
		validaMeioTransportePeloTipo(criteria.getLong("idMeioTransporte"), criteria.getString("tipoMeioTransporte"));
	}

	
	private void validaMeioTransportePeloTipo(Long idMeioTransporte, String tipoMeioTransporte) {
		if (tipoMeioTransporte.equals("transportado"))
			getControleCargaService().validateVeiculoControleCarga(idMeioTransporte, false);
    	else
    		getControleCargaService().validateSemiReboqueControleCarga(idMeioTransporte);
	}


	private List findLookupMeioTransporte(Map criteria) {
    	List list = meioTransporteService.findLookup(criteria);
    	List retorno = new ArrayList();
    	for (Iterator iter = list.iterator(); iter.hasNext();) {
    		MeioTransporte meioTransporte = (MeioTransporte)iter.next();
    		TypedFlatMap typedFlatMap = new TypedFlatMap();
    		typedFlatMap.put("idMeioTransporte", meioTransporte.getIdMeioTransporte());
    		typedFlatMap.put("nrIdentificador", meioTransporte.getNrIdentificador());
    		typedFlatMap.put("nrFrota", meioTransporte.getNrFrota());
    		typedFlatMap.put("tpVinculo", meioTransporte.getTpVinculo());
    		typedFlatMap.put("modeloMeioTransporte.tipoMeioTransporte.tpMeioTransporte.value", 
    				meioTransporte.getModeloMeioTransporte().getTipoMeioTransporte().getTpMeioTransporte().getValue());
    		retorno.add(typedFlatMap);
    	}
    	if (retorno.size() == 1) {
    		TypedFlatMap typedFlatMap = (TypedFlatMap)retorno.get(0);
    		validaMeioTransportePeloTipo(typedFlatMap.getLong("idMeioTransporte"), (String)criteria.get("tipoMeioTransporte"));
    	}
    	return retorno;
    }


	public TypedFlatMap findMeioTransporteBySolicitacaoContratacao(Map criteria) {
		TypedFlatMap typedFlatMap = new TypedFlatMap();
		if (criteria.get("nrIdentificacaoMeioTransporteTransportado") != null) {
			String nrIdentificador = (String)criteria.get("nrIdentificacaoMeioTransporteTransportado");
			if ( !StringUtils.isBlank(nrIdentificador) ) {
				Map map = new HashMap();
				map.put("nrIdentificador", nrIdentificador);
				List list = meioTransporteService.find(map);
				if (!list.isEmpty()) {
					MeioTransporte meioTransporte = (MeioTransporte)list.get(0);
					typedFlatMap.put("meioTransporteTransportado.idMeioTransporte", meioTransporte.getIdMeioTransporte());
					typedFlatMap.put("meioTransporteTransportado.nrFrota", meioTransporte.getNrFrota());
					typedFlatMap.put("meioTransporteTransportado.nrIdentificador", meioTransporte.getNrIdentificador());
				}
			}
		}
		if (criteria.get("nrIdentificacaoMeioTransporteSemiRebocado") != null) {
			String nrIdentificador = (String)criteria.get("nrIdentificacaoMeioTransporteSemiRebocado");
			if ( !StringUtils.isBlank(nrIdentificador) ) {
				Map map = new HashMap();
				map.put("nrIdentificador", nrIdentificador);
				List list = meioTransporteService.find(map);
				if (!list.isEmpty()) {
					MeioTransporte meioTransporte = (MeioTransporte)list.get(0);
					typedFlatMap.put("meioTransporteSemiRebocado.idMeioTransporte", meioTransporte.getIdMeioTransporte());
					typedFlatMap.put("meioTransporteSemiRebocado.nrFrota", meioTransporte.getNrFrota());
					typedFlatMap.put("meioTransporteSemiRebocado.nrIdentificador", meioTransporte.getNrIdentificador());
				}
			}
		}
		return typedFlatMap;
	}

	
    /**
     * Retorna a ï¿½ltima equipe operacao cadastrada de um controle de carga
     * 
     * @param idControleCarga
     * @return
     */
    public EquipeOperacao findEquipeOperacaoByIdControleCarga(Long idControleCarga){
    	return equipeOperacaoService.findByIdControleCargaColetaEntrega(idControleCarga);
    }
 

    public TypedFlatMap findDadosVeiculo(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("idControleCarga");
    	Long idMeioTransporteTransportado = criteria.getLong("idMeioTransporteTransportado");
    	Long idMeioTransporteSemiRebocado = criteria.getLong("idMeioTransporteSemiRebocado");
    	Long idRotaColetaEntrega = criteria.getLong("idRotaColetaEntrega");

    	TypedFlatMap tfm = new TypedFlatMap();
    	Map mapResultado = meioTranspProprietarioService.findProprietarioByMeioTransporte(idMeioTransporteTransportado);
    	if (mapResultado != null) {
	    	Map mapProprietario = (Map)mapResultado.get("proprietario");
	    	if (mapProprietario != null) {
	    		tfm.put("proprietario.idProprietario", mapProprietario.get("idProprietario"));
	    		Map mapPessoa = (Map)mapProprietario.get("pessoa");
	    		if (mapPessoa != null) {
		    		tfm.put("proprietario.pessoa.nrIdentificacaoFormatado", FormatUtils.formatIdentificacao(
		    			(String)((Map)mapPessoa.get("tpIdentificacao")).get("value"), (String)mapPessoa.get("nrIdentificacao"))); 
		    		tfm.put("proprietario.pessoa.nmPessoa", mapPessoa.get("nmPessoa"));
		    	}
		    }
		}
    	TipoMeioTransporte tipoMeioTransporte = tipoMeioTransporteService.findTipoMeioTransporteCompostoByIdMeioTransporte(idMeioTransporteTransportado);
    	if (tipoMeioTransporte != null) {
    		tfm.put("idTipoMeioTransporte", tipoMeioTransporte.getIdTipoMeioTransporte());
    	}

		tfm.put("tabelas",tipoTabelaColetaEntregaService.findTipoTabelaColetaEntregaWithTabelaColetaEntrega(
				SessionUtils.getFilialSessao().getIdFilial(), idMeioTransporteTransportado, idRotaColetaEntrega));
		if(tfm.get("tabelas")!=null && !((List) tfm.get("tabelas")).isEmpty()){
			tfm.put("tpCalculoTabelas", ((Map)((List) tfm.get("tabelas")).get(0)).get("tpCalculo"));
		}
		
		inicializaGridPostos(idControleCarga, idMeioTransporteTransportado, idMeioTransporteSemiRebocado, idRotaColetaEntrega);
    	return tfm;
    }

    public ResultSetPage<TypedFlatMap> findPaginatedExigenciasGerRisco(TypedFlatMap criteria) {
    	Long idControleCarga = criteria.getLong("idControleCarga");
    	return carregamentoDescargaService.findPaginatedExigenciasGerRisco(idControleCarga);
    }

    /**
     * 
     * @param blStore
     * @param idControleCarga
     * @param parameters
     */
    private void findDadosEquipeOperacao(Boolean blStore, Long idControleCarga, TypedFlatMap parameters) {
		EquipeOperacao equipeOperacao = findEquipeOperacaoByIdControleCarga(idControleCarga);
		if (equipeOperacao == null) {
			return;
		}
		Long idEquipe = equipeOperacao.getEquipe().getIdEquipe(); 
		Long idEquipeOperacao = equipeOperacao.getIdEquipeOperacao();
		parameters.put("idEquipe", idEquipe);
		parameters.put("idEquipeOperacao", idEquipeOperacao);
    }


    private Long getIdReciboPostoPassagem(Long idControleCarga) {
	    Map mapControleCarga = new HashMap();
		mapControleCarga.put("idControleCarga", idControleCarga);
		
		Map mapRecibo = new HashMap();
		mapRecibo.put("controleCarga", mapControleCarga);
		mapRecibo.put("tpStatusRecibo", "GE");
		
		List lista = reciboPostoPassagemService.find(mapRecibo);
		if (!lista.isEmpty())
			return ((ReciboPostoPassagem)lista.get(0)).getIdReciboPostoPassagem();
		return null;
    }



	public void updateReciboPostoPassagem(TypedFlatMap criteria) {
		Long idReciboPostoPassagem = criteria.getLong("idReciboPostoPassagem");
		reciboPostoPassagemService.updateReciboPostoPassagem(idReciboPostoPassagem);
	}
    
    /**
     * 
     * @param parameters
     */
    public TypedFlatMap generatePreEmissaoControleCarga(TypedFlatMap parameters) {
    	Long idControleCarga = parameters.getLong("idControleCarga");
    	Long idMeioTransporte = parameters.getLong("meioTransporteByIdTransportado.idMeioTransporte");
    	Long idRotaColetaEntrega = parameters.getLong("rotaColetaEntrega.idRotaColetaEntrega");
    	MasterEntry masterEntry = getMasterFromSession(idControleCarga, false);
    	ControleCarga controleCarga = (ControleCarga) masterEntry.getMaster();
    	
    	Boolean blEmissao = parameters.getBoolean("blEmissao");
    	
    	//LMS-05412 Problema na geração do CIOT, favor verificar monitoramento CIOT
		//Verificar se filial logada está parametrizada para bloquear emissão do controle de carga quando não há CIOT (VL_CONTEUDO_PARAMETRO_FILIAL = 'S' onde NM_PARAMETRO_FILIAL = 'BLOQUEIA_CIOT') 
		//e que exija CIOT neste controle de carga (BL_EXIGE_CIOT = 'S') 
		//Se não tenha CIOT gerado(CIOT.TP_SITUACAO <> 'G' onde cc.id_controle_carga = ciot.id_controle_carga e cc.id_transportado = ciot.id_meio_transporte
		if(blEmissao){
			getControleCargaService().validateGeracaoCiot(SessionUtils.getFilialSessao().getIdFilial(), controleCarga);
		}

		if (controleCarga.getMeioTransporteByIdTransportado() != null) {
			getControleCargaService().validateVeiculoControleCarga(controleCarga.getMeioTransporteByIdTransportado().getIdMeioTransporte(), controleCarga.getIdControleCarga(), false);
		}
		if (controleCarga.getTpControleCarga() != null && "C".equals(controleCarga.getTpControleCarga().getValue())) {
			getControleCargaService().validateParcelaColetaEntrega(controleCarga.getIdControleCarga());
		}
		
    	
    	ControleCarga contCarg = getControleCargaService().findByIdInitLazyProperties(idControleCarga, false);
    	
		boolean calculoPadrao = isCalculoPadrao();
			
		
		if(!calculoPadrao){			
			Boolean possuiTabelaColetaEntregaC1 = false;
			if( contCarg.getTabelaColetaEntrega() != null ){
				possuiTabelaColetaEntregaC1 = true;
			}
			
			//verifica se possui tabela Coleta Entrega C2
			List<TabelaColetaEntrega> tabelaColetaEntregaList = tabelaColetaEntregaService.findTabelaColetaEntregaVigentes( 
					SessionUtils.getFilialSessao().getIdFilial(), "A", idMeioTransporte, JTDateTimeUtils.getDataAtual(),
					null, idRotaColetaEntrega, "C2");
			
			if(tabelaColetaEntregaList.isEmpty() && !possuiTabelaColetaEntregaC1){
				throw new BusinessException("LMS-05323");
			}		
		}	
    	
    	getControleCargaService().generatePreEmissaoControleCarga(controleCarga.getIdControleCarga(), 
    			controleCarga.getTpStatusControleCarga().getValue(), blEmissao);
    	
    	TypedFlatMap retorno = new TypedFlatMap();
    	
    	/*PROCESSO DE ENQUADRAMENTOS E EXIGÊNCIAS PGR */
    	PlanoGerenciamentoRiscoDTO planoPGR =  new PlanoGerenciamentoRiscoDTO();		
		if (planoUtils.findParametroFilial(PA_SGR_VAL_EXIST_PGR)) {
			planoPGR = planoGerenciamentoRiscoService.executeVerificarEnquadramentoRegra(idControleCarga);
			planoGerenciamentoRiscoService.generateExigenciasGerRisco(planoPGR);
			TypedFlatMap mapRetornoPGR = getControleCargaService().validateEnquadramentosEWorkflows(planoPGR);

			if (!mapRetornoPGR.isEmpty()) {
				return mapRetornoPGR;
			}
		}
		getControleCargaService().generateSMP(idControleCarga, SessionUtils.getFilialSessao().getIdFilial(), planoPGR);

    	//LMS-5093
    	//Se ação for “Emissão”:
    	if (blEmissao) {
			//Se a filial que está emitindo o Controle de Cargas tiver o MDF-e  de Entrega implantado (parâmetro de filial “INDICADOR_MDFE_E” cadastrado para a filial e com o conteúdo “S”)
			if (getControleCargaService().isFilialMdfeE(SessionUtils.getFilialSessao().getIdFilial())) {
				boolean contingenciaConfirmada = Boolean.TRUE.equals(parameters.getBoolean("contingenciaConfirmada"));
				retorno = getControleCargaService().generateMdfe(idControleCarga, contingenciaConfirmada);
				if (Boolean.TRUE.equals(retorno.getBoolean("encerrarMdfesAutorizados")) || Boolean.TRUE.equals(retorno.get("aguardarAutorizacaoMdfe")) || Boolean.TRUE.equals(retorno.getBoolean("hasContingencia"))) {
					return retorno;
				}
			}
		}

    	
    	if (blEmissao) {
    		store(parameters);
    	}
		return retorno;
    }

	/**
	 * @return
	 */
	private boolean isCalculoPadrao() {
		boolean calculoPadrao = false;
			
		ConteudoParametroFilial conteudoParametroFilial = conteudoParametroFilialService.findByNomeParametro(SessionUtils.getFilialSessao().getIdFilial(), PARAMETRO_FILIAL, false, true);
		if (conteudoParametroFilial != null && SIM.equalsIgnoreCase(conteudoParametroFilial.getVlConteudoParametroFilial())) {
			calculoPadrao = true;
		}
		return calculoPadrao;
	}

    private void verifyAprovacoesPendentes(List exigencias, Long idControleCarga){
		if(exigencias.isEmpty()){
			throw new BusinessException("LMS-11320");
		}
    	
		for (Object object : exigencias) {
			TypedFlatMap regra = (TypedFlatMap) object;
			
			FaixaDeValor faixa = faixaDeValorService.findById((Long) regra.get("idFaixaDeValor"));
			if(faixa.getBlRequerLiberacaoCemop()){
				List<Pendencia> pendencias = pendenciaService.findPendenciaByEvento(idControleCarga, ID_EVENTO_WORKFLOW_CEMOP, PEDENCIA_EM_APROVACAO, PENDENCIA_APROVADA, PENDENCIA_REPROVADA);
				
				if(pendencias.isEmpty()){
					procedimentoGerRiscoService.generatePendencia(idControleCarga);
					throw new BusinessException("LMS-05031");
				}
				
				for (Pendencia pendencia : pendencias) {
					if(pendencia.getTpSituacaoPendencia().getValue().equals(PEDENCIA_EM_APROVACAO)){
						throw new BusinessException("LMS-05332");
					}
					if(pendencia.getTpSituacaoPendencia().getValue().equals(PENDENCIA_REPROVADA)){
						procedimentoGerRiscoService.generatePendencia(idControleCarga);
						throw new BusinessException("LMS-05332");
					}
				}
			}
		}
	}
	
    

	public TypedFlatMap encerrarMdfesAutorizados(TypedFlatMap parameters) {
        return getControleCargaService().executeEncerrarMdfesAutorizados(parameters.getLong("idControleCarga"));
    }
	
	public TypedFlatMap verificaAutorizacaoMdfe(TypedFlatMap parameters) {
	    return getControleCargaService().executeVerificaAutorizacaoMdfe(parameters);
	}
	
	public TypedFlatMap verificaEncerramentoMdfe(TypedFlatMap parameters) {
	    return getControleCargaService().executeVerificaEncerramentoMdfe(parameters.getLong("idManifestoEletronicoEncerrado"), parameters.getDateTime("dhEncerramento"));
	}
	
    /**
     * 
	 * @param parameters
	 * @return
	 */
	public File imprimirMDFe(TypedFlatMap parameters) {
		
		List list = parameters.getList("idsManifestoEletronico");
		
		List<Long> idsManifestoEletronico = new ArrayList<Long>();
		for (Object o: list) {
			if (o instanceof String) {
				idsManifestoEletronico.add(Long.valueOf(o.toString()));
			} else if (o instanceof Long) {
				idsManifestoEletronico.add((Long)o);
			} else {
				throw new IllegalArgumentException("idsManifestoEletronico");
			}
		}
		
		
		List<ManifestoEletronico> manifestos = new ArrayList<ManifestoEletronico>();
		
		for(Long idManifestoEletronico : idsManifestoEletronico){
			manifestos.add((ManifestoEletronico) manifestoEletronicoService.findById(idManifestoEletronico));
		}
		
		Object oObsContingMdfe1 = configuracoesFacade.getValorParametro("OBS_CONTING_MDFE1");
		String obsContingMdfe1 = oObsContingMdfe1 == null ? "" : oObsContingMdfe1.toString();
		Object oObsContingMdfe2 = configuracoesFacade.getValorParametro("OBS_CONTING_MDFE2");
		String obsContingMdfe2 = oObsContingMdfe2 == null ? "" : oObsContingMdfe2.toString();
		
		return MdfeActionUtils.imprimirMDFe(manifestos, obsContingMdfe1, obsContingMdfe2);

	}
	
    /**
     * 
     * @param criteria
     */
    public TypedFlatMap generatePosEmissaoControleCarga(TypedFlatMap criteria) {
    	getControleCargaService().generatePosEmissaoControleCarga(
    			//PODE_SE BUSCAR DIRETAMENTE DO CC
    			criteria.getLong("idControleCarga"), 
    			criteria.getLong("idMeioTransporte"),
    			criteria.getLong("idSemiReboque"),    			
    			criteria.getLong("idEquipeOperacao"), 
    			criteria.getBoolean("blEmissao"));
    	
    	TypedFlatMap map = new TypedFlatMap();
    	map.put("idReciboPostoPassagem", getIdReciboPostoPassagem(criteria.getLong("idControleCarga")) );
    	return map;
    }
    

    /**
     * Antes de salvar, inicializa os itemList que nï¿½o tinham sido inicializados. Eles podem nï¿½o ter sido inicializados, pq o 
     * usuï¿½rio pode salvar a tela sem ter entrado em todas as abas. 
     * 
     * @param blStore
     * @param idControleCarga
     * @param parameters
     * @param masterEntry
     * @param itemListIntegranteEqOperac
     * @param itemListPagtoPedagioCc
     * @param itemListPostoPassagemCc
     * @param itemListConfigPagtoPedagioCc
     * @param itemListConfigPostoPassagemCc
     */
    private void inicializaItemLists(Long idControleCarga, 
    								 TypedFlatMap parameters,
    								 MasterEntry masterEntry,
    								 ItemList itemListIntegranteEqOperac, 
    								 ItemList itemListPagtoPedagioCc, 
    								 ItemList itemListPostoPassagemCc,
    								 ItemListConfig itemListConfigPagtoPedagioCc,
    								 ItemListConfig itemListConfigPostoPassagemCc) 
    {
		if (!itemListIntegranteEqOperac.isInitialized()) {
			findDadosEquipeOperacao(parameters.getBoolean("blStore"), idControleCarga, parameters);
			if (parameters.getLong("idEquipe") != null) {
				inicializaItemListIntegranteEqOperac(parameters.getLong("idEquipe"), 
						parameters.getLong("idEquipeOperacao"), idControleCarga, itemListIntegranteEqOperac);
			}
		}
		else
		if (parameters.getLong("idEquipeOperacao") == null && parameters.getLong("idEquipe") == null) {
			findDadosEquipeOperacao(parameters.getBoolean("blStore"), idControleCarga, parameters);
		}

		if (!itemListPagtoPedagioCc.isInitialized()) {
			List lista = pagtoPedagioCcService.findPagtoPedagioCc(idControleCarga);
			populateListaPagtoPedagioCc(lista, masterEntry, itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc);
		}

		if (!itemListPostoPassagemCc.isInitialized()) {
			Long idMeioTransporteTransportado = parameters.getLong("meioTransporteByIdTransportado.idMeioTransporte");
			Long idMeioTransporteSemiRebocado = parameters.getLong("meioTransporteByIdSemiRebocado.idMeioTransporte");
			Long idRotaColetaEntrega = parameters.getLong("rotaColetaEntrega.idRotaColetaEntrega");
			List lista = postoPassagemCcService.findPostoPassagemCcByColetaEntrega(
					idControleCarga, idMeioTransporteTransportado, idMeioTransporteSemiRebocado, idRotaColetaEntrega, null);
			populateListaPostoPassagemCc(lista, masterEntry, itemListPostoPassagemCc, itemListConfigPostoPassagemCc);
		}
		
		atualizaDadosPostosNaSessao(idControleCarga, parameters, masterEntry, itemListPostoPassagemCc, itemListConfigPostoPassagemCc);
		atualizaDadosPagtosNaSessao(idControleCarga, parameters, masterEntry, 
				itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc, itemListPostoPassagemCc, itemListConfigPostoPassagemCc);
    }

    
	/***
	 * 
	 * @param parameters
	 * @return
	 */
	public TypedFlatMap store(TypedFlatMap parameters) {
		Long idControleCarga = parameters.getLong("idControleCarga");
    	MasterEntry masterEntry = getMasterFromSession(idControleCarga, false);
    	ControleCarga controleCarga = (ControleCarga) masterEntry.getMaster();

    	ItemList itemListIntegranteEqOperac = getItemsFromSession(masterEntry, "integrantes");
    	ItemList itemListPagtoPedagioCc = getItemsFromSession(masterEntry, "pagamentos");
    	ItemList itemListPostoPassagemCc = getItemsFromSession(masterEntry, "postos");
    	ItemListConfig itemListIntegranteEqOperacConfig = getMasterConfig().getItemListConfig("integrantes");
    	ItemListConfig itemListPagtoPedagioCcConfig = getMasterConfig().getItemListConfig("pagamentos");
    	ItemListConfig itemListPostoPassagemCcConfig = getMasterConfig().getItemListConfig("postos");

    	inicializaItemLists(idControleCarga, parameters, masterEntry, itemListIntegranteEqOperac, 
    			itemListPagtoPedagioCc, itemListPostoPassagemCc, itemListPagtoPedagioCcConfig, itemListPostoPassagemCcConfig);

    	TypedFlatMap map = getControleCargaService().
    							storeEmitirControleCargasColetaEntrega(
						    			parameters, controleCarga, 
						    			itemListIntegranteEqOperac, itemListIntegranteEqOperacConfig, 
						    			itemListPagtoPedagioCc, itemListPagtoPedagioCcConfig, 
						    			itemListPostoPassagemCc, itemListPostoPassagemCcConfig);

    	itemListIntegranteEqOperac.resetItemsState(); 
    	itemListPagtoPedagioCc.resetItemsState(); 
    	itemListPostoPassagemCc.resetItemsState(); 
		updateMasterInSession(masterEntry);
    	return map;
	}


	
	
	
    /************************************************************************************
     							INICIO - EQUIPE OPERACAO
     ************************************************************************************/
    /**
     * Faz a pesquisa da grid para o filho.
     * 
     * @param parameters
     * @return
     */
    public List findPaginatedIntegranteEqOperac(TypedFlatMap parameters) {
    	Long idControleCarga = parameters.getLong("idControleCarga");
    	Long idEquipe = parameters.getLong("idEquipe");
    	Long idEquipeOperacao = parameters.getLong("idEquipeOperacao");
    	if (idEquipe == null)
    		return Collections.EMPTY_LIST;
    	
    	MasterEntry masterEntry = getMasterFromSession(idControleCarga, false);
		ItemList itemList = masterEntry.getItems("integrantes");
		ItemListConfig itemListConfig = getMasterConfig().getItemListConfig("integrantes");

		if (!itemList.isInitialized()) {
			inicializaItemListIntegranteEqOperac(idEquipe, idEquipeOperacao, idControleCarga, itemList);
		}
		return getListaIntegrantesOrdenada(itemList.iterator(null, itemListConfig));
    }

    /**
     * 
     * @param idEquipe
     * @param idEquipeOperacao
     * @return
     */
	private List findIntegranteEqOperacao(Long idEquipe, Long idEquipeOperacao) {
		List listaIntegrantes = Collections.EMPTY_LIST;
		if (idEquipeOperacao != null) {
			listaIntegrantes = integranteEqOperacService.findByEmitirControleCargaDadosEquipe(idEquipeOperacao);
			for (Iterator iter = listaIntegrantes.iterator(); iter.hasNext();) {
				IntegranteEqOperac integranteEqOperac = (IntegranteEqOperac)iter.next();
				if (integranteEqOperac.getPessoa() != null) 
					integranteEqOperac.setNmIntegranteEquipe(integranteEqOperac.getPessoa().getNmPessoa());
				else 
					integranteEqOperac.setNmIntegranteEquipe(integranteEqOperac.getUsuario().getNmUsuario());
			}
		}
		if (listaIntegrantes.isEmpty())
			listaIntegrantes = integranteEqOperacService.findIntegranteEqOperacao(idEquipe);
 
		return listaIntegrantes;
	}
    

    /**
     * Remove uma lista de registros items.
     *  
     * @param ids ids dos registros item a serem removidos.
	 *
     */
	@ParametrizedAttribute(type = java.lang.Long.class)
    public void removeByIdsIntegranteEquipe(List ids) {
    	super.removeItemByIds(ids, "integrantes");
    }

    /**
     * 
     * @param idEquipe
     * @param idEquipeOperacao
     * @param masterId
     * @param itemList
     */
	private void inicializaItemListIntegranteEqOperac(Long idEquipe, Long idEquipeOperacao, Long masterId, ItemList itemList) {
		List listaIntegrantes = findIntegranteEqOperacao(idEquipe, idEquipeOperacao);
		if (idEquipeOperacao == null) {
			itemList.initialize(Collections.EMPTY_LIST);
			for (Iterator iter = listaIntegrantes.iterator(); iter.hasNext();) {
				IntegranteEqOperac integranteEqOperac = (IntegranteEqOperac)iter.next();
				integranteEqOperac.setIdIntegranteEqOperac(null);
				super.saveItemInstanceOnSession(masterId, integranteEqOperac, "integrantes");
			}
		}
		else
			itemList.initialize(listaIntegrantes);
	}
    
    /**
     * 
     * @param parameters
     */
    public void inicializaGridIntegranteEqOperac(TypedFlatMap parameters) {
    	Long idControleCarga = parameters.getLong("idControleCarga");
    	Long idEquipe = parameters.getLong("idEquipe");
    	Long idEquipeOperacao = parameters.getLong("idEquipeOperacao");

    	MasterEntry masterEntry = getMasterFromSession(idControleCarga, false);
		ItemList itemList = masterEntry.getItems("integrantes");

		if (!itemList.isInitialized()) {
			inicializaItemListIntegranteEqOperac(idEquipe, idEquipeOperacao, idControleCarga, itemList);
		} 
		else {
			List lista = findIntegranteEqOperacao(idEquipe, idEquipeOperacao);
	    	ItemListConfig itemListConfig = getMasterConfig().getItemListConfig("integrantes");
	    	resetaAtualizaItemList(idControleCarga, masterEntry, itemList, itemListConfig, lista);
		}
    }
    /************************************************************************************
								FIM - EQUIPE OPERACAO
	************************************************************************************/

    
    
    
    
    
    
    /************************************************************************************
     								INICIO - PagtoPedagioCc
	************************************************************************************/
    /**
     * Recebe da tela uma lista com os valores da grid pagamentos. Se algum registro foi alterado na grid, 
     * esse mï¿½todo atualiza na sessï¿½o.
     * Se nï¿½o receber da tela nenhuma lista da da grid pagamentos,  
     *    
     * @param idControleCarga
     * @param parameters
     * @param masterEntry
     * @param itemListPagtoPedagioCc
     * @param itemListConfigPagtoPedagioCc
     */
	private void atualizaDadosPagtosNaSessao(	Long idControleCarga, TypedFlatMap parameters, MasterEntry masterEntry, 
												ItemList itemListPagtoPedagioCc, ItemListConfig itemListConfigPagtoPedagioCc, 
												ItemList itemListPostoPassagemCc, ItemListConfig itemListConfigPostoPassagemCc) 
	{
		// Recebe a lista com os valores da grid pagamentos
		List listaPagamentos = parameters.getList("pagamentos");
		if (listaPagamentos != null) {
			atualizaDadosPagtosNaSessao(idControleCarga, 
					listaPagamentos, masterEntry, itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc); 
		}
		else 
		if (!parameters.getBoolean("veiculoInformadoManualmente").booleanValue()) {
			List listaPagtos = pagtoPedagioCcService.findPagtoPedagioCc(idControleCarga, 
					itemListPostoPassagemCc.iterator(idControleCarga, itemListConfigPostoPassagemCc), Boolean.TRUE);
			
			populateItemList(listaPagtos, masterEntry, itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc);
		}
	}


	/**
	 * Mï¿½todo responsï¿½vel por alterar os dados da grid pagtoPedagio de acordo com a grid postosPassagem. ï¿½ chamado quando algum
	 * valor da combo forma de pagamento da grid postosPassagem for alterado.
	 * 
	 * @param parameters
	 */
	public void generatePagtoPedagioCcByPostosPassagem(TypedFlatMap parameters) {
		Long idControleCarga = parameters.getLong("idControleCarga");
    	MasterEntry masterEntry = getMasterFromSession(idControleCarga, false);

    	ItemList itemListPagtoPedagioCc = getItemsFromSession(masterEntry, "pagamentos");
    	ItemList itemListPostoPassagemCc = getItemsFromSession(masterEntry, "postos");
    	ItemListConfig itemListConfigPagtoPedagioCc = getMasterConfig().getItemListConfig("pagamentos");
    	ItemListConfig itemListConfigPostoPassagemCc = getMasterConfig().getItemListConfig("postos");
    	
		atualizaDadosPostosNaSessao(idControleCarga, parameters, masterEntry, itemListPostoPassagemCc, itemListConfigPostoPassagemCc);
		atualizaDadosPagtosNaSessao(idControleCarga, parameters, masterEntry, 
				itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc, itemListPostoPassagemCc, itemListConfigPostoPassagemCc);

		List listaPagtos = pagtoPedagioCcService.findPagtoPedagioCc(idControleCarga, 
				itemListPostoPassagemCc.iterator(idControleCarga, itemListConfigPostoPassagemCc), Boolean.FALSE);

		resetaAtualizaItemList(idControleCarga, masterEntry, itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc, listaPagtos);
	}
    /************************************************************************************
     							FIM - PagtoPedagioCc
	************************************************************************************/







	/************************************************************************************
							INICIO - PostoPassagemCc
	************************************************************************************/
	/**
	 * 
	 * @param idControleCarga
	 * @param idMeioTransporteTransportado
	 * @param idMeioTransporteSemiRebocado
	 * @param idRotaColetaEntrega
	 */
    private void inicializaGridPostos(	Long idControleCarga, Long idMeioTransporteTransportado, 
    									Long idMeioTransporteSemiRebocado, Long idRotaColetaEntrega) 
    {
    	MasterEntry masterEntry = getMasterFromSession(idControleCarga, false);
		List listaPostos = postoPassagemCcService.findPostoPassagemCcByColetaEntrega(
				idControleCarga, idMeioTransporteTransportado, idMeioTransporteSemiRebocado, idRotaColetaEntrega, null);				

		ItemList itemListPostoPassagemCc = masterEntry.getItems("postos");
		ItemListConfig itemListConfigPostoPassagemCc = getMasterConfig().getItemListConfig("postos");
		if (!itemListPostoPassagemCc.isInitialized())
			populateListaPostoPassagemCc(listaPostos, masterEntry, itemListPostoPassagemCc, itemListConfigPostoPassagemCc);
		else
			resetaAtualizaItemList(idControleCarga, masterEntry, itemListPostoPassagemCc, itemListConfigPostoPassagemCc, listaPostos);


		ItemList itemListPagtoPedagioCc = getItemsFromSession(masterEntry, "pagamentos");
		ItemListConfig itemListConfigPagtoPedagioCc = getMasterConfig().getItemListConfig("pagamentos");

		List listaPagtos = pagtoPedagioCcService.findPagtoPedagioCc(idControleCarga,
				itemListPostoPassagemCc.iterator(idControleCarga, itemListConfigPagtoPedagioCc), Boolean.TRUE);

		if (!itemListPagtoPedagioCc.isInitialized())
			populateListaPagtoPedagioCc(listaPagtos, masterEntry, itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc);
		else
			resetaAtualizaItemList(idControleCarga, masterEntry, itemListPagtoPedagioCc, itemListConfigPagtoPedagioCc, listaPagtos);
    }
	/************************************************************************************
	 							FIM - PostoPassagemCc
	************************************************************************************/

    
    
    
    
    
    

    
	protected MasterEntryConfig createMasterConfig(MasterDetailFactory masterFactory) { 
		//Declaracao da classe pai
		MasterEntryConfig config = masterFactory.createMasterEntryConfig(ControleCarga.class, true);

		// Esta classe e reponsavel por ordenar a List dos filhos que estï¿½o em memoria de acordo com as regras de negocio
    	Comparator descComparatorIntegrantes = new Comparator() {
			public int compare(Object obj1, Object obj2) {
				IntegranteEqOperac integranteEqOperac1 = (IntegranteEqOperac)obj1;
				IntegranteEqOperac integranteEqOperac2 = (IntegranteEqOperac)obj2;
        		return integranteEqOperac1.getNmIntegranteEquipe().compareTo(integranteEqOperac2.getNmIntegranteEquipe());
			}    		
    	};

    	// Esta classe e reponsavel por ordenar a List dos filhos que estï¿½o em memoria de acordo com as regras de negocio
    	Comparator descComparator = new Comparator() {
			public int compare(Object obj1, Object obj2) {
				return 1;
			}    		
    	};




    	// Segunda aba
    	// Esta instancia ï¿½ responsavel por carregar os items filhos na sessï¿½o a partir do banco de dados.
    	ItemListConfig itemEquipeInit = new ItemListConfig() {

    		/**
    		 * Find paginated do filho
    		 * Passa por este ponto apenas na primeira vez em que a list filha e chamada.
    		 * Apos a primeira vez ela e carregada da memoria
    		 * 
    		 *  @param masterId id do pai
    		 *  @param parameters todos os parametros vindo da tela pai
    		 */
			public List initialize(Long masterId, Map parameters) {
				return null;
			}

			/**
			 * Busca rowCount da grid  da tela filha
			 * Passa por este ponto apenas na primeira vez em que a list filha e chamada.
    		 * Apos a primeira vez ela e carregada da memoria
			 * 
			 * @param masterId id do pai
			 */
			public Integer getRowCount(Long masterId, Map parameters) {
				return Integer.valueOf(1);
			}			

			/**
			 * Seta um pai para o itemConfig de Integrante
			 */
			public void setMasterOnItem(Object master, Object itemBean) {
				((IntegranteEqOperac) itemBean).setEquipeOperacao(new EquipeOperacao());
			}			
			
			/**
			 * Todos os dados a serem carregados na grid pelo form passam antes por este
			 * metodo. Para se fazer uma validacao...
			 * Recomenda-se que o bean em questao seja gerado nesta classe a partir dos
			 * parametros enviados da tela para se evitar um 'ReflectionUtils'
			 * 
			 * @param parameters 
			 * @param bean a ser istanciado
			 * @return Object bean instanciado
			 */
			public Object populateNewItemInstance(Map parameters, Object object) {
				return populateNewItemInstanceIntegranteEqOperac(parameters, object);
			}
			
			/**
			 * Chama esta funcao depois de editar um item da grid filho
			 * E retira atributos desnecessarios para o filho
			 * 
			 * @param newBean 
			 * @param oldBean 
			 */
			public void modifyItemValues(Object newBean, Object oldBean) {
				modifyItemValuesEquipeOperacao(newBean, oldBean);
			}

			/**
			 * Mapeia atributos de dominio do pojo filho
			 */
			public Map configItemDomainProperties() {
				return null;
			}
    	};




    	// Terceira aba - 1a grid
    	// Esta instancia ï¿½ responsavel por carregar os items filhos na sessï¿½o a partir do banco de dados.
    	ItemListConfig itemPagamentoInit = new ItemListConfig() {

    		/**
    		 * Esse mï¿½todo ï¿½ chamado somente na primeira vez em que o mï¿½todo findPaginatedItemList for executado.
    		 * Apï¿½s a primeira vez ela ï¿½ carregada na memï¿½ria, e o item list fica inicializado.
    		 * Nesse caso estï¿½ retornando uma lista vazia, porque a grid de pagto ï¿½ povoada a partir da grid postos.
    		 * 
    		 * @param masterId id do pai
    		 * @param parameters
    		 * @return
    		 */
			public List initialize(Long masterId, Map parameters) {
				return Collections.EMPTY_LIST;
			}

			/**
			 * Busca rowCount da grid pagto.
			 * Passa por este ponto apenas na primeira vez em que a list filha ï¿½ chamada.
    		 * Apï¿½s a primeira vez ela ï¿½ carregada da memï¿½ria. 
    		 * Estï¿½ retornando um valor qualquer, porque neste caso nï¿½o teremos paginaï¿½ï¿½o e o getRowCount nï¿½o serï¿½ usado.
			 * 
			 * @param masterId id do pai
			 * @return
			 */
			public Integer getRowCount(Long masterId, Map parameters) {
				return Integer.valueOf(1);
			}			

			/**
			 * Todos os dados a serem carregados na grid pelo form passam antes por este mï¿½todo.
			 * Recomenda-se que o bean em questï¿½o seja gerado nesta classe a partir dos parï¿½etros enviados da tela para se 
			 * evitar um 'ReflectionUtils'.
			 * 
			 * @param parameters 
			 * @param bean a ser istanciado
			 * @return Object bean instanciado
			 */
			public Object populateNewItemInstance(Map parameters, Object object) {
				return populateNewItemInstancePagtoPedagioCc(parameters, object);
			}

			/**
			 * Mï¿½todo chamado quando um item da grid for alterado. Os atributos desnecessï¿½rios para o filho sï¿½o removidos.
			 * 
			 * @param newBean 
			 * @param oldBean 
			 */
			public void modifyItemValues(Object newBean, Object oldBean) {
				modifyItemValuesPagtoPedagioCc(newBean, oldBean);
			}

			/**
			 * Mapeia atributos de dominio do pojo filho
			 */
			public Map configItemDomainProperties() {
				return null;
			}
    	};




    	// Terceira aba - 2a grid
    	// Esta instancia ï¿½ responsavel por carregar os items filhos na sessï¿½o a partir do banco de dados.
    	ItemListConfig itemPostoPassagemInit = new ItemListConfig() {

    		/**
    		 * Esse mï¿½todo ï¿½ chamado somente na primeira vez em que o mï¿½todo findPaginatedItemList for executado.
    		 * Apï¿½s a primeira vez ela ï¿½ carregada na memï¿½ria, e o item list fica inicializado.
    		 * 
    		 * @param masterId id do pai
    		 * @param parameters
    		 * @return
    		 */
			public List initialize(Long masterId, Map parameters) {
				if (parameters.isEmpty())
					return Collections.EMPTY_LIST;

				TypedFlatMap map = (TypedFlatMap)parameters;
				Long idControleCarga = map.getLong("idControleCarga");
				Long idMeioTransporteTransportado = map.getLong("_meioTransporteByIdTransportado_idMeioTransporte");
				Long idMeioTransporteSemiRebocado = map.getLong("_meioTransporteByIdSemiRebocado_idMeioTransporte");
				Long idRotaColetaEntrega = map.getLong("_rotaColetaEntrega_idRotaColetaEntrega");
				List result = postoPassagemCcService.findPostoPassagemCcByColetaEntrega(idControleCarga, 
						idMeioTransporteTransportado, idMeioTransporteSemiRebocado, idRotaColetaEntrega, null);				

				int id = -1;
				for (Iterator iter = result.iterator(); iter.hasNext();) {
					PostoPassagemCc ppCC = (PostoPassagemCc)iter.next();
					if (ppCC.getIdPostoPassagemCc() == null) {
						ppCC.setIdPostoPassagemCc(Long.valueOf(id--));
					}
				}
				return result;
			}

			/**
			 * Busca rowCount da grid postos.
			 * Passa por este ponto apenas na primeira vez em que a list filha ï¿½ chamada.
    		 * Apï¿½s a primeira vez ela ï¿½ carregada da memï¿½ria. 
    		 * Estï¿½ retornando um valor qualquer, porque neste caso nï¿½o teremos paginaï¿½ï¿½o e o getRowCount nï¿½o serï¿½ usado.
    		 * 
    		 * @param masterId
    		 * @param parameters
    		 * @return
			 */
			public Integer getRowCount(Long masterId, Map parameters) {
				return Integer.valueOf(1);
			}			

			/**
			 * Todos os dados a serem carregados na grid pelo form passam antes por este mï¿½todo.
			 * Recomenda-se que o bean em questï¿½o seja gerado nesta classe a partir dos parï¿½etros enviados da tela para se 
			 * evitar um 'ReflectionUtils'.
			 * 
			 * @param parameters 
			 * @param bean a ser istanciado
			 * @return Object bean instanciado
			 */
			public Object populateNewItemInstance(Map parameters, Object object) {
				return populateNewItemInstancePostoPassagemCc(parameters, object);
			}

			/**
			 * Mï¿½todo chamado quando um item da grid for alterado. Os atributos desnecessï¿½rios para o filho sï¿½o removidos.
			 * 
			 * @param newBean 
			 * @param oldBean 
			 */
			public void modifyItemValues(Object newBean, Object oldBean) {
				modifyItemValuesPostoPassagemCc(newBean, oldBean);
			}

			/**
			 * Mapeia atributos de dominio do pojo filho
			 */
			public Map configItemDomainProperties() {
				return null;
			}
    	};
    	
    	//Seta as configuracoes do filho...
		config.addItemConfig("integrantes", IntegranteEqOperac.class, itemEquipeInit, descComparatorIntegrantes);
		config.addItemConfig("pagamentos", PagtoPedagioCc.class, itemPagamentoInit, descComparator);
		config.addItemConfig("postos", PostoPassagemCc.class, itemPostoPassagemInit, descComparator);
		return config;
	}
	public void setTabelaColetaEntregaService(TabelaColetaEntregaService tabelaColetaEntregaService) {
		this.tabelaColetaEntregaService = tabelaColetaEntregaService;
	}
	
	public void setManifestoEletronicoService(ManifestoEletronicoService manifestoEletronicoService) {
		this.manifestoEletronicoService = manifestoEletronicoService;
	}
	
	public void setConfiguracoesFacade(ConfiguracoesFacade configuracoesFacade) {
		this.configuracoesFacade = configuracoesFacade;
	}

	public CarregamentoDescargaService getCarregamentoDescargaService() {
		return carregamentoDescargaService;
	}

	public void setCarregamentoDescargaService(CarregamentoDescargaService carregamentoDescargaService) {
		this.carregamentoDescargaService = carregamentoDescargaService;
	}

	public void setPlanoGerenciamentoRiscoService(PlanoGerenciamentoRiscoService planoGerenciamentoRiscoService) {
		this.planoGerenciamentoRiscoService = planoGerenciamentoRiscoService;
	}

	public void setPlanoUtils(PlanoGerenciamentoRiscoUtils planoUtils) {
		this.planoUtils = planoUtils;
	}

	public ConteudoParametroFilialService getConteudoParametroFilialService() {
		return conteudoParametroFilialService;
	}

	public void setConteudoParametroFilialService(
			ConteudoParametroFilialService conteudoParametroFilialService) {
		this.conteudoParametroFilialService = conteudoParametroFilialService;
	}

	
	
}