package com.mercurio.lms.expedicao.swt.action;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.annotations.ParametrizedAttribute;
import com.mercurio.adsm.framework.model.CrudAction;
import com.mercurio.adsm.framework.model.FindDefinition;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.model.masterdetail.MasterDetailAction;
import com.mercurio.lms.configuracoes.ConfiguracoesFacade;
import com.mercurio.lms.expedicao.model.Awb;
import com.mercurio.lms.expedicao.model.Conhecimento;
import com.mercurio.lms.expedicao.model.CtoInternacional;
import com.mercurio.lms.expedicao.model.Dimensao;
import com.mercurio.lms.expedicao.model.service.DimensaoService;
import com.mercurio.lms.expedicao.util.AwbUtils;
import com.mercurio.lms.expedicao.util.ConstantesExpedicao;
import com.mercurio.lms.expedicao.util.CtoInternacionalUtils;
import com.mercurio.lms.util.CompareUtils;
import com.mercurio.lms.util.IntegerUtils;
import com.mercurio.lms.vendas.model.Cotacao;
import com.mercurio.lms.vendas.util.ConstantesVendas;
import com.mercurio.lms.vendas.util.VendasUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.expedicao.swt.digitarDimensoesAction"
 */

public class DigitarDimensoesAction extends CrudAction {
	private static int cont = 0;
	private DimensaoService dimensaoService;
	private ConfiguracoesFacade configuracoesFacade;

	public void setDimensaoService(DimensaoService dimensaoService) {
		this.dimensaoService = dimensaoService;
	}

	public void setConfiguracoesFacade(ConfiguracoesFacade configuracoesFacade) {
		this.configuracoesFacade = configuracoesFacade;
	}

	/**
	 *
	 */
	@ParametrizedAttribute(type = java.lang.Long.class)
	public Map removeByIds(Map parameters) {
		List ids = (List) parameters.get("ids");
		String tpDocumentoServico = (String) parameters.get(ConstantesExpedicao.TP_DOCUMENTO_IN_SESSION);
		Conhecimento conhecimento = (Conhecimento) parameters.get("conhecimento");
		
		List dimensoes = this.getDimensoesInSession(tpDocumentoServico, conhecimento);
		if(dimensoes != null) {
			if(ids != null) {
				for(Iterator iter = ids.iterator(); iter.hasNext();) {
					Long id = (Long) iter.next();
					removeDimensao(dimensoes, id, tpDocumentoServico);
				}
				setDimensoesInSession(dimensoes, tpDocumentoServico, conhecimento);
			}
		}
		parameters = new LinkedHashMap<String, Object>();
		parameters.put("conhecimento", conhecimento);
		return parameters;
	}

	private void removeDimensao(List dimensoes, Long id, String tpDocumentoServico) {
		for(Iterator iter = dimensoes.iterator(); iter.hasNext();) {
			Dimensao dimensao = (Dimensao) iter.next();
			if(CompareUtils.eq(id, dimensao.getIdDimensao())) {
				if(ConstantesExpedicao.AIRWAY_BILL.equals(tpDocumentoServico)) {
					dimensao.setAwb(null);
				} else {
					iter.remove();
				}
			}
		}
	}

	public Dimensao findById(java.lang.Long id, String tpDocumentoServico, Conhecimento conhecimento) {
		List dimensoes = this.getDimensoesInSession(tpDocumentoServico, conhecimento);
		if(dimensoes != null) {
			for(Iterator iter = dimensoes.iterator(); iter.hasNext();) {
				Dimensao dimensao = (Dimensao) iter.next();
				if(CompareUtils.eq(dimensao.getIdDimensao(), id)) {
					return dimensao;
				}
			}
		}
		return null;
	}

	public Integer getRowCount(Map criteria) {
		String tpDocumentoServico = (String)criteria.get(ConstantesExpedicao.TP_DOCUMENTO_IN_SESSION);
		Conhecimento conhecimento = (Conhecimento) criteria.get("conhecimento");
		
		List dimensoes = this.getDimensoesInSession(tpDocumentoServico, conhecimento);
		if(dimensoes != null) {
			return Integer.valueOf(dimensoes.size());
		}
		return IntegerUtils.ZERO;
	}

	public ResultSetPage findPaginated(Map criteria) {
		String tpDocumentoServico = (String)criteria.get(ConstantesExpedicao.TP_DOCUMENTO_IN_SESSION);
		String idDocumento = (String)criteria.get("idDocumento");
		Conhecimento conhecimento = (Conhecimento) criteria.get("conhecimento");

		if(ConstantesVendas.COTACAO.equals(tpDocumentoServico)) {
			if(StringUtils.isNotBlank(idDocumento)) {
				return dimensaoService.findPaginatedByIdCotacao(Long.valueOf(idDocumento), criteria);
			}
		} else if(ConstantesExpedicao.CONHECIMENTO_INTERNACIONAL.equals(tpDocumentoServico)) {
			if(StringUtils.isNotBlank(idDocumento)) {
				return dimensaoService.findPaginatedByIdCtoInternacional(Long.valueOf(idDocumento), criteria);
			}
		} else if(ConstantesExpedicao.AIRWAY_BILL.equals(tpDocumentoServico)) {
			List<Dimensao> dimensoes = this.getDimensoesInSession(tpDocumentoServico, conhecimento);
			List<Dimensao> result = new ArrayList<Dimensao>();
			for (Dimensao dimensao : dimensoes) {
				if(dimensao.getAwb() != null) {
					Awb awb = new Awb();
					awb.setIdAwb(dimensao.getAwb().getIdAwb());
					dimensao.setAwb(awb);
					result.add(dimensao);
				}
			}
			FindDefinition findDef = FindDefinition.createFindDefinition(criteria);
			return MasterDetailAction.getResultSetPage(result, findDef.getCurrentPage(), findDef.getPageSize(), null);
		}

		List dimensoes = this.getDimensoesInSession(tpDocumentoServico, conhecimento);
		if(dimensoes != null) {
			FindDefinition findDef = FindDefinition.createFindDefinition(criteria);
			return MasterDetailAction.getResultSetPage(dimensoes, findDef.getCurrentPage(), findDef.getPageSize(), null);
		}
		return ResultSetPage.EMPTY_RESULTSET;
	}

	public Map storeInSession(Map parameters) {
		Dimensao dimensao = new Dimensao();
		dimensao.setIdDimensao((Long)parameters.get("idDimensao"));
		dimensao.setNrAltura((Integer)parameters.get("nrAltura"));
		dimensao.setNrComprimento((Integer)parameters.get("nrComprimento"));
		dimensao.setNrLargura((Integer)parameters.get("nrLargura"));
		dimensao.setNrQuantidade((Integer)parameters.get("nrQuantidade"));

		Conhecimento conhecimento = (Conhecimento) parameters.get("conhecimento");
		String tpDocumentoServico = (String)parameters.get(ConstantesExpedicao.TP_DOCUMENTO_IN_SESSION);
		
		this.validateDimensao(dimensao);

		List dimensoes = getDimensoesInSession(tpDocumentoServico, conhecimento);
		if(dimensoes == null) {
			dimensoes = new ArrayList();
		}
		if(dimensao.getIdDimensao() == null) {
			if(ConstantesExpedicao.AIRWAY_BILL.equals(tpDocumentoServico)) {
				Awb awb = AwbUtils.getAwbInSession();
				dimensao.setAwb(awb);
			}
			dimensao.setIdDimensao(Long.valueOf(--cont));
			dimensoes.add(dimensao);
		} else {
			Dimensao dimensaoAux = findById(dimensao.getIdDimensao(), tpDocumentoServico, conhecimento);
			if(dimensaoAux != null) {
				dimensaoAux.setNrAltura(dimensao.getNrAltura());
				dimensaoAux.setNrComprimento(dimensao.getNrComprimento());
				dimensaoAux.setNrLargura(dimensao.getNrLargura());
				dimensaoAux.setNrQuantidade(dimensao.getNrQuantidade());	
			}
		}
		setDimensoesInSession(dimensoes, tpDocumentoServico, conhecimento);
		Map result = new LinkedHashMap<String, Object>();
		result.put("conhecimento", conhecimento);
		return result;
	}

	private void validateDimensao(Dimensao dimensao) {
		if(!IntegerUtils.hasValue(dimensao.getNrAltura())) {
			throw new BusinessException("LMS-04153", new Object[]{configuracoesFacade.getMensagem("altura")});
		}
		if(!IntegerUtils.hasValue(dimensao.getNrComprimento())) {
			throw new BusinessException("LMS-04153", new Object[]{configuracoesFacade.getMensagem("comprimento")});
		}
		if(!IntegerUtils.hasValue(dimensao.getNrLargura())) {
			throw new BusinessException("LMS-04153", new Object[]{configuracoesFacade.getMensagem("largura")});
		}
		if(!IntegerUtils.hasValue(dimensao.getNrQuantidade())) {
			throw new BusinessException("LMS-04153", new Object[]{configuracoesFacade.getMensagem("quantidade")});
		}
	}

	private List getDimensoesInSession(String tpDocumentoServico, Conhecimento conhecimento) {

		if(isConhecimentoNacional(tpDocumentoServico)) {
			return conhecimento.getDimensoes();
		}
		if(ConstantesExpedicao.CONHECIMENTO_INTERNACIONAL.equals(tpDocumentoServico)) {
			return CtoInternacionalUtils.getCtoInternacionalInSession().getDimensoes();
		}
		if(ConstantesExpedicao.AIRWAY_BILL.equals(tpDocumentoServico)) {
			return AwbUtils.getAwbInSession().getDimensoes();
		}
		if(ConstantesVendas.COTACAO.equals(tpDocumentoServico)) {
			return VendasUtils.getCotacaoInSession().getDimensoes();
		}
		return null;
	}

	private void setDimensoesInSession(List dimensoes, String tpDocumentoServico, Conhecimento conhecimento) {

		if(isConhecimentoNacional(tpDocumentoServico)) {
			conhecimento.setDimensoes(dimensoes);
		} else if(ConstantesExpedicao.CONHECIMENTO_INTERNACIONAL.equals(tpDocumentoServico)) {
			CtoInternacional ctoInternacional = CtoInternacionalUtils.getCtoInternacionalInSession();
			ctoInternacional.setDimensoes(dimensoes);
			CtoInternacionalUtils.setCtoInternacionalInSession(ctoInternacional);
		} else if(ConstantesExpedicao.AIRWAY_BILL.equals(tpDocumentoServico)) {
			Awb awb = AwbUtils.getAwbInSession();
			awb.setDimensoes(dimensoes);
			AwbUtils.setAwbInSession(awb);
		} else if(ConstantesVendas.COTACAO.equals(tpDocumentoServico)) {
			Cotacao cotacao = VendasUtils.getCotacaoInSession();
			cotacao.setDimensoes(dimensoes);
			VendasUtils.setCotacaoInSession(cotacao);
		}
	}

	private Boolean isConhecimentoNacional(String tpDocumentoServico) {
		 return ConstantesExpedicao.CONHECIMENTO_NACIONAL.equals(tpDocumentoServico) ||
				ConstantesExpedicao.NOTA_FISCAL_TRANSPORTE.equals(tpDocumentoServico);
	}
}
