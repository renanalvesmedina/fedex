package com.mercurio.lms.coleta.swt.action;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.mercurio.adsm.framework.BusinessException;
import com.mercurio.adsm.framework.model.ResultSetPage;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.carregamento.model.ControleCarga;
import com.mercurio.lms.coleta.model.ManifestoColeta;
import com.mercurio.lms.coleta.model.service.ManifestoColetaService;
import com.mercurio.lms.configuracoes.model.Moeda;
import com.mercurio.lms.contratacaoveiculos.model.MeioTransporte;
import com.mercurio.lms.municipios.model.Filial;
import com.mercurio.lms.municipios.model.RotaColetaEntrega;
import com.mercurio.lms.municipios.model.service.FilialService;
import com.mercurio.lms.municipios.model.service.RotaColetaEntregaService;
import com.mercurio.lms.util.session.SessionUtils;

/**
 * Generated by: ADSM ActionGenerator
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.coleta.swt.consultarManifestosColetaAction"
 */

public class ConsultarManifestosColetaAction {
    
	private ManifestoColetaService manifestoColetaService;
	private FilialService filialService;
	private RotaColetaEntregaService rotaColetaEntregaService;


	public ManifestoColetaService getManifestoColetaService() {
		return manifestoColetaService;
	}
	public void setManifestoColetaService(ManifestoColetaService manifestoColetaService) {
		this.manifestoColetaService = manifestoColetaService;
	}
	public FilialService getFilialService() {
		return filialService;
	}
	public void setFilialService(FilialService filialService) {
		this.filialService = filialService;
	}
	public RotaColetaEntregaService getRotaColetaEntregaService() {
		return rotaColetaEntregaService;
	}
	public void setRotaColetaEntregaService(RotaColetaEntregaService rotaColetaEntregaService) {
		this.rotaColetaEntregaService = rotaColetaEntregaService;
	}


	/**
	 * Faz a pesquisa da lookup de filial, levando em consideracao buscar apenas as filiais 
	 * que o usuario logado tem acesso
	 * 
	 * @param TypedFlatMap criteria
	 * @return List
	 */
	public List findLookupFilialByUsuario(Map criteria) {
		
		List listFilialLookup = getFilialService().findLookup(criteria);
        List result = new ArrayList();
        if (listFilialLookup.size() == 1) {
            Filial filial = (Filial)listFilialLookup.get(0); 
            if (SessionUtils.isFilialAllowedByUsuario(filial)) {
            	Map mapFilial= new HashMap();
            	mapFilial.put("idFilial", filial.getIdFilial());
            	mapFilial.put("sgFilial", filial.getSgFilial());
            	mapFilial.put("nmFantasia", filial.getPessoa().getNmFantasia());
                result.add(mapFilial);
            } else {
                throw new BusinessException("LMS-00050");
            }
        }else {
            result = listFilialLookup; 
        }
        return result;
	}


	/**
	 * Busca uma list de rota coleta/entrega. 
	 * 
	 * @param criteria
	 * @return
	 */
	public List findLookupRotaColetaEntregaByFilial(Map criteria) {
		List listRetorno = new ArrayList();
		Map map = null;
		List listRotaColetaEntrega = this.getRotaColetaEntregaService().findLookupByFilialUsuario(criteria);
		for (Iterator iter = listRotaColetaEntrega.iterator(); iter.hasNext();) {
			RotaColetaEntrega rotaColetaEntrega = (RotaColetaEntrega) iter.next();
			map = new HashMap();
			map.put("idRotaColetaEntrega", rotaColetaEntrega.getIdRotaColetaEntrega());
			map.put("nrRota", rotaColetaEntrega.getNrRota());
			map.put("dsRota", rotaColetaEntrega.getDsRota());
			listRetorno.add(map);
		}
		return listRetorno;
	}


	public ResultSetPage findPaginated(Map criteria) {
		this.montaCriteriaPaginated(criteria);
		ResultSetPage resultSetPage = this.getManifestoColetaService().findPaginated(criteria);
		List listManifestosColeta = resultSetPage.getList();
		List listRetorno = new ArrayList();
		TypedFlatMap row = null;
		for (Iterator iter = listManifestosColeta.iterator(); iter.hasNext();) {
			ManifestoColeta manifestoColeta = (ManifestoColeta) iter.next();
			ControleCarga cc = manifestoColeta.getControleCarga();
			MeioTransporte meioTransporteTransportado = cc.getMeioTransporteByIdTransportado();
			MeioTransporte meioTransporteSemiRebocado = cc.getMeioTransporteByIdSemiRebocado();
			Moeda moeda = cc.getMoeda();
			row = new TypedFlatMap();
			row.put("idManifestoColeta", manifestoColeta.getIdManifestoColeta());
			row.put("nrManifesto",manifestoColeta.getNrManifesto());
			row.put("dhGeracao", manifestoColeta.getDhGeracao());
			row.put("filial.idFilial", manifestoColeta.getFilial().getIdFilial());
			row.put("sgFilialManifesto", manifestoColeta.getFilial().getSgFilial());			
			row.put("sgFilialControleCarga", cc.getFilialByIdFilialOrigem().getSgFilial());
			row.put("nrControleCarga", cc.getNrControleCarga());
			row.put("psTotalFrotaControleCarga", cc.getPsTotalFrota());
			row.put("vlTotalFrotaControleCarga", cc.getVlTotalFrota());
			if(moeda!=null){
				row.put("dsSimboloControleCarga", cc.getMoeda().getDsSimbolo());
				row.put("sgMoedaControleCarga", cc.getMoeda().getSgMoeda());
			}
			if (meioTransporteTransportado!=null){
				row.put("nrFrota", meioTransporteTransportado.getNrFrota());
				row.put("nrIdentificador", meioTransporteTransportado.getNrIdentificador());
				row.put("nrCapacidadeKgControleCarga",meioTransporteTransportado.getNrCapacidadeKg());
			}
			if (meioTransporteSemiRebocado!=null){
				row.put("nrFrotaSemiRebocado", meioTransporteSemiRebocado.getNrFrota());
				row.put("nrIdentificadorSemiRebocado", meioTransporteSemiRebocado.getNrIdentificador());
			}
			listRetorno.add(row);
		}
		resultSetPage.setList(listRetorno);
		return resultSetPage;
	}


	public Integer getRowCountManifestoColeta(Map criteria) {
		this.montaCriteriaPaginated(criteria);
		return this.getManifestoColetaService().getRowCount(criteria);
	}


	private Map montaCriteriaPaginated(Map criteria){
		if(criteria.get("idFilial")!= null){
			Map mapFilial = new HashMap();
			mapFilial.put("idFilial", criteria.get("idFilial"));
			criteria.put("filial", mapFilial);
		}

		if(criteria.get("idRotaColetaEntrega")!= null){
			Map mapRotaColetaEntrega = new HashMap();
			mapRotaColetaEntrega.put("idRotaColetaEntrega", criteria.get("idRotaColetaEntrega"));
			criteria.put("rotaColetaEntrega", mapRotaColetaEntrega);
		}
		return criteria;
	}


	public TypedFlatMap findFilialById(Long idFilial) {
		Filial filial = filialService.findById(idFilial);
		TypedFlatMap result = new TypedFlatMap();		
		result.put("sgFilial", filial.getSgFilial());
		result.put("nmFantasia", filial.getPessoa().getNmFantasia());
		return result;
	}
}