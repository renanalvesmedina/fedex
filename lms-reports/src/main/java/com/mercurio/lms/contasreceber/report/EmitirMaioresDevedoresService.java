package com.mercurio.lms.contasreceber.report;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.jdbc.UncategorizedSQLException;

import net.sf.jasperreports.engine.JRDataSource;
import net.sf.jasperreports.engine.data.JRMapCollectionDataSource;

import com.mercurio.adsm.core.InfrastructureException;
import com.mercurio.adsm.framework.model.JodaTimeUtils;
import com.mercurio.adsm.framework.report.JRReportDataObject;
import com.mercurio.adsm.framework.report.ReportServiceSupport;
import com.mercurio.adsm.framework.util.SqlTemplate;
import com.mercurio.adsm.framework.util.TypedFlatMap;
import com.mercurio.lms.util.session.SessionUtils;

/**
 * Generated by: ADSM ActionGenerator
 * 
 * @author Rafael Andrade de Oliveira
 * @since 28/03/2006
 *  
 * Não inserir documentação após ou remover a tag do XDoclet a seguir.
 * O valor do <code>id</code> informado abaixo deve ser utilizado para referenciar este serviço.
 * @spring.bean id="lms.contasreceber.emitirMaioresDevedoresService"
 * @spring.property name="reportName" value="com/mercurio/lms/contasreceber/report/emitirMaioresDevedores.jasper" 
 */

public class EmitirMaioresDevedoresService extends ReportServiceSupport { 
 
	private EmitirMaioresDevedoresSqlService emitirMaioresDevedoresSqlService;
	
	public void setEmitirMaioresDevedoresSqlService(EmitirMaioresDevedoresSqlService emitirMaioresDevedoresSqlService){
		this.emitirMaioresDevedoresSqlService = emitirMaioresDevedoresSqlService;
	}
	
	/**
	 * 
	 *
	 * @author Hector Julian Esnaola Junior
	 * @since 06/02/2007
	 *
	 * @param parameters
	 * @return
	 *
	 */
	public JRReportDataObject execute(Map parameters) {
		TypedFlatMap tfm = (TypedFlatMap) parameters;
		
		SqlTemplate sql = createSqlTemplate(); 
		
		if (tfm.getString("situacao").equalsIgnoreCase("V")) {//Vencidos/a vencer
			emitirMaioresDevedoresSqlService.getSqlAVencerVencidoNaoFaturado(tfm, sql);
		} else {//Em protesto
			emitirMaioresDevedoresSqlService.getSqlEmProtesto(tfm, sql);
		}
		
		// Seta o FilterSummary 
		emitirMaioresDevedoresSqlService.mountFilterSummary(sql, tfm);
		
		// Itera o resultSet
		List lst = this.iteratorResultSet(sql, tfm.getLong("qtdCliente")); 
		
		JRMapCollectionDataSource jrMap = new JRMapCollectionDataSource(lst);
		
		JRReportDataObject jr = createReportDataObject(jrMap, parameters);
		
		jr.setParameters(mountParametersReport(parameters, tfm, sql));
		
		return jr;
	}
	
	/**
	 * Itera o resultSet para calcular o total geral
	 *
	 * @author Hector Julian Esnaola Junior
	 * @since 14/03/2007
	 *
	 * @param sql
	 * @param qtClientes
	 * @return
	 *
	 */
	public List iteratorResultSet(SqlTemplate sql, final Long qtClientes){
		List retorno = null;
		try{
			retorno = (List)getJdbcTemplate().query(sql.getSql(), JodaTimeUtils.jdbcPureParamConverter(getJdbcTemplate(), sql.getCriteria()), emitirMaioresDevedoresSqlService.getResultSetExtractor(qtClientes));
		}catch(UncategorizedSQLException e){
			throw new InfrastructureException(e.getCause());
		}
		return (List) retorno; 
	}

	/**
	 *
	 * @author Hector Julian Esnaola Junior
	 * @since 14/03/2007
	 *
	 * @param parameters
	 * @param tfm
	 * @param sql
	 * @param parametersReport
	 *
	 */
	private Map mountParametersReport(Map parameters, TypedFlatMap tfm, SqlTemplate sql ) {
		
		Map parametersReport = new HashMap();
		
		/* Tipo do relatório */
        parametersReport.put(JRReportDataObject.EXPORT_MODE_PARAM, parameters.get("tpFormatoRelatorio"));
		
        /* Parametros de pesquisa */
        parametersReport.put("parametrosPesquisa", sql.getFilterSummary());
        
		/* Usuario emissor */
		parametersReport.put("usuarioEmissor", SessionUtils.getUsuarioLogado().getNmUsuario());
		
		/* Insere o TypedFlatMap nos parametros para ser usado no subReport */
		parametersReport.put("TFM", tfm);
		
		return parametersReport;
	}
	
	/**
	 * 
	 *
	 * @author Hector Julian Esnaola Junior
	 * @since 06/02/2007
	 *
	 * @param param
	 * @return
	 * @throws Exception
	 *
	 */
	public JRDataSource executeSubReport(Object[] param) throws Exception {
		
		Long idCliente = (Long) param[0];
		TypedFlatMap tfm = (TypedFlatMap) param[1]; 
		
		SqlTemplate sql  = emitirMaioresDevedoresSqlService.getSqlDoctoServicoAnalitico(idCliente, tfm);
		
		JRReportDataObject jr = executeQuery(sql.getSql(), sql.getCriteria());
		
		return jr.getDataSource();
	}
	
}